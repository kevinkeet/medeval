<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="description" content="Evidence-based medication benefit calculator that provides individualized assessment of medication benefits, harms, and burden based on your health profile and goals of care.">
    <meta name="theme-color" content="#0D5C63">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>MedBenefit | Patient-Centered Medication Calculator</title>

    <!-- Favicon using emoji (data URI) -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üíä</text></svg>">

    <!-- Preconnect for performance -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <!-- Optional: Google Fonts for enhanced typography -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        /* Font override if Google Fonts loads */
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

/* CSS Variables */
:root {
    --primary: #0D5C63;
    --primary-dark: #094449;
    --primary-light: #E8F4F5;
    --accent: #D4A03C;
    --accent-light: #F8F4E8;
    --benefit: #2E8B57;
    --benefit-light: #E8F4F0;
    --harm: #C44536;
    --harm-light: #FDF6F5;
    --burden: #7B68A6;
    --burden-light: #F4F0F8;
    --muted: #5A6A6E;
    --light-gray: #F5F7F8;
    --border: #DDE3E6;
    --text: #1d1d1d;
    --white: #FFFFFF;
    --shadow: 0 2px 8px rgba(0,0,0,0.08);
    --shadow-lg: 0 4px 16px rgba(0,0,0,0.12);

    /* New enhanced variables */
    --glass-bg: rgba(255, 255, 255, 0.85);
    --glass-border: rgba(255, 255, 255, 0.3);
    --gradient-primary: linear-gradient(135deg, #0D5C63 0%, #147A85 50%, #0D5C63 100%);
    --gradient-shine: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    --transition-bounce: cubic-bezier(0.68, -0.55, 0.265, 1.55);
}

/* Reset & Base */
* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    font-size: 16px;
    line-height: 1.6;
    color: var(--text);
    background: var(--light-gray);
}

.container {
    max-width: 1100px;
    margin: 0 auto;
    padding: 0 20px;
}

/* Header - Enhanced with animated gradient */
header {
    background: var(--gradient-primary);
    background-size: 200% 200%;
    animation: gradientShift 8s ease infinite;
    color: var(--white);
    padding: 50px 0 45px;
    text-align: center;
    box-shadow: 0 4px 30px rgba(13, 92, 99, 0.3);
    position: relative;
    overflow: hidden;
}

header::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: var(--gradient-shine);
    animation: headerShine 4s ease-in-out infinite;
}

@keyframes gradientShift {
    0%, 100% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
}

@keyframes headerShine {
    0% { left: -100%; }
    50%, 100% { left: 100%; }
}

header h1 {
    font-size: 2.4rem;
    font-weight: 800;
    margin-bottom: 10px;
    letter-spacing: -0.5px;
    text-shadow: 0 2px 4px rgba(0,0,0,0.15);
    position: relative;
}

header .subtitle {
    font-size: 1.15rem;
    opacity: 0.95;
    font-weight: 300;
    letter-spacing: 0.3px;
}

/* Header container styling */
header .container {
    position: relative;
}

/* Header Content Layout */
.header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: relative;
    z-index: 1;
}

.header-title {
    flex: 1;
    text-align: center;
}

.header-nav {
    position: absolute;
    right: 0;
    top: 50%;
    transform: translateY(-50%);
}

.header-nav .nav-link {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    color: rgba(255, 255, 255, 0.9);
    text-decoration: none;
    font-size: 0.9rem;
    font-weight: 500;
    padding: 8px 16px;
    background: rgba(255, 255, 255, 0.15);
    border: 1px solid rgba(255, 255, 255, 0.25);
    border-radius: 20px;
    transition: all 0.3s ease;
    backdrop-filter: blur(4px);
}

.header-nav .nav-link:hover {
    background: rgba(255, 255, 255, 0.25);
    color: #fff;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

@media (max-width: 768px) {
    .header-content {
        flex-direction: column;
        gap: 15px;
    }

    .header-nav {
        position: static;
        transform: none;
    }
}

/* Progress Bar - Enhanced with connecting lines */
.progress-bar {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 0;
    padding: 35px 20px;
    background: linear-gradient(180deg, var(--white) 0%, var(--light-gray) 100%);
    border-bottom: 1px solid var(--border);
    margin-bottom: 30px;
    flex-wrap: wrap;
    position: relative;
}

.progress-step {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 24px;
    border-radius: 50px;
    background: var(--white);
    color: var(--muted);
    font-size: 0.9rem;
    transition: all 0.4s var(--transition-bounce);
    border: 2px solid var(--border);
    position: relative;
    z-index: 1;
    cursor: default;
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
}

/* Connecting lines between steps */
.progress-step:not(:last-child)::after {
    content: '';
    position: absolute;
    right: -30px;
    top: 50%;
    width: 30px;
    height: 3px;
    background: var(--border);
    transform: translateY(-50%);
    z-index: 0;
    transition: background 0.4s ease;
}

.progress-step.completed:not(:last-child)::after {
    background: var(--benefit);
}

.progress-step:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}

.progress-step.active {
    background: var(--primary);
    color: var(--white);
    border-color: var(--primary);
    box-shadow: 0 4px 20px rgba(13, 92, 99, 0.35);
    transform: scale(1.05);
}

.progress-step.completed {
    background: var(--benefit);
    color: var(--white);
    border-color: var(--benefit);
}

.progress-step.completed .step-number::after {
    content: '‚úì';
    position: absolute;
    font-size: 0.7rem;
}

.progress-step.completed .step-number span {
    opacity: 0;
}

.step-number {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background: rgba(255,255,255,0.25);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 0.85rem;
    position: relative;
    transition: all 0.3s ease;
}

.progress-step:not(.active):not(.completed) .step-number {
    background: var(--light-gray);
    color: var(--muted);
}

.step-label {
    font-weight: 500;
    letter-spacing: 0.2px;
}

/* Cards - Enhanced with glassmorphism and hover effects */
.card {
    background: var(--glass-bg);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-radius: 16px;
    padding: 28px;
    margin-bottom: 24px;
    box-shadow: 0 4px 24px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04);
    border: 1px solid var(--glass-border);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, var(--primary), var(--benefit), var(--primary));
    opacity: 0;
    transition: opacity 0.3s ease;
}

.card:hover {
    box-shadow: 0 8px 32px rgba(0,0,0,0.1), 0 2px 4px rgba(0,0,0,0.06);
    transform: translateY(-2px);
}

.card:hover::before {
    opacity: 1;
}

.card h3 {
    color: var(--primary);
    font-size: 1.25rem;
    margin-bottom: 18px;
    padding-bottom: 14px;
    border-bottom: 2px solid var(--primary-light);
    display: flex;
    align-items: center;
    gap: 10px;
}

.card h3::before {
    content: '';
    width: 4px;
    height: 24px;
    background: var(--primary);
    border-radius: 2px;
}

/* Form Elements */
.form-section {
    display: none;
}

.form-section.active {
    display: block;
}

.form-section h2 {
    color: var(--primary);
    font-size: 1.8rem;
    margin-bottom: 8px;
}

.section-description {
    color: var(--muted);
    margin-bottom: 24px;
}

.form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
}

.form-group {
    display: flex;
    flex-direction: column;
}

.form-group.full-width {
    grid-column: 1 / -1;
}

.form-group label {
    font-weight: 500;
    color: var(--text);
    margin-bottom: 6px;
    font-size: 0.95rem;
}

.form-group label .optional {
    font-weight: 400;
    color: var(--muted);
    font-size: 0.85rem;
}

.form-group input,
.form-group select {
    padding: 12px 16px;
    border: 2px solid var(--border);
    border-radius: 10px;
    font-size: 1rem;
    transition: all 0.3s ease;
    background: var(--white);
}

.form-group input:hover,
.form-group select:hover {
    border-color: var(--primary-light);
    background: var(--light-gray);
}

.form-group input:focus,
.form-group select:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 4px rgba(13, 92, 99, 0.12);
    background: var(--white);
}

/* Input with value indicator */
.form-group input:not(:placeholder-shown) {
    border-color: var(--primary);
    background: linear-gradient(135deg, var(--white), var(--primary-light));
}

/* Number input spinners styling */
.form-group input[type="number"]::-webkit-inner-spin-button,
.form-group input[type="number"]::-webkit-outer-spin-button {
    height: 30px;
}

/* Checkboxes */
.checkbox-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 10px;
    margin-top: 12px;
}

.checkbox-label {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 14px;
    background: var(--light-gray);
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.2s;
}

.checkbox-label:hover {
    background: var(--primary-light);
}

.checkbox-label input[type="checkbox"] {
    width: 18px;
    height: 18px;
    accent-color: var(--primary);
}

/* Medication Checkboxes */
.med-checkbox-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 10px;
}

.med-checkbox {
    display: flex;
    flex-direction: column;
    padding: 12px 14px;
    background: var(--light-gray);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
    border: 2px solid transparent;
}

.med-checkbox:hover {
    background: var(--primary-light);
}

.med-checkbox input[type="checkbox"] {
    position: absolute;
    opacity: 0;
}

.med-checkbox input[type="checkbox"]:checked + .med-name {
    color: var(--primary);
    font-weight: 600;
}

.med-checkbox:has(input:checked) {
    background: var(--primary-light);
    border-color: var(--primary);
}

.med-name {
    font-weight: 500;
    color: var(--text);
}

.med-class {
    font-size: 0.85rem;
    color: var(--muted);
}

/* Goals of Care - Enhanced with icons and better interaction */
.goc-spectrum {
    display: flex;
    flex-direction: column;
    gap: 16px;
    margin-top: 20px;
}

.goc-option {
    border: 2px solid var(--border);
    border-radius: 16px;
    overflow: hidden;
    cursor: pointer;
    transition: all 0.4s var(--transition-bounce);
    position: relative;
}

.goc-option:hover {
    border-color: var(--primary);
    box-shadow: 0 8px 30px rgba(0,0,0,0.1);
    transform: translateX(8px);
}

.goc-option.selected {
    border-color: transparent;
    box-shadow: 0 12px 40px rgba(0,0,0,0.15);
    transform: scale(1.02);
}

.goc-option.selected::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    border: 3px solid;
    border-radius: 14px;
    pointer-events: none;
    animation: selectedPulse 2s ease-in-out infinite;
}

.goc-option.selected:has(.comfort)::before { border-color: var(--harm); }
.goc-option.selected:has(.selective)::before { border-color: var(--accent); }
.goc-option.selected:has(.balanced)::before { border-color: var(--primary); }
.goc-option.selected:has(.proactive)::before { border-color: var(--benefit); }

@keyframes selectedPulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.6; }
}

.goc-header {
    padding: 18px 22px;
    font-weight: 700;
    font-size: 1.15rem;
    color: var(--white);
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: relative;
}

.goc-header::before {
    font-size: 1.5rem;
    margin-right: 12px;
}

.goc-header.comfort { background: linear-gradient(135deg, var(--harm), #e74c3c); }
.goc-header.comfort::before { content: 'üïäÔ∏è'; }

.goc-header.selective { background: linear-gradient(135deg, var(--accent), #e67e22); }
.goc-header.selective::before { content: '‚öñÔ∏è'; }

.goc-header.balanced { background: linear-gradient(135deg, var(--primary), #147A85); }
.goc-header.balanced::before { content: 'üéØ'; }

.goc-header.proactive { background: linear-gradient(135deg, var(--benefit), #27ae60); }
.goc-header.proactive::before { content: 'üõ°Ô∏è'; }

.goc-option.selected .goc-header::after {
    content: "‚úì Selected";
    font-size: 0.85rem;
    font-weight: 500;
    background: rgba(255,255,255,0.25);
    padding: 4px 12px;
    border-radius: 20px;
}

.goc-description {
    padding: 20px 22px;
    background: var(--white);
}

.goc-description p {
    margin-bottom: 12px;
    line-height: 1.6;
}

.goc-description ul {
    margin-left: 20px;
    color: var(--muted);
}

.goc-description li {
    margin-bottom: 6px;
    line-height: 1.5;
}

/* Buttons - Enhanced with ripple effect and better states */
.nav-buttons {
    display: flex;
    justify-content: space-between;
    gap: 20px;
    margin-top: 35px;
    padding-top: 25px;
    border-top: 2px solid var(--light-gray);
}

.btn {
    padding: 16px 32px;
    border-radius: 12px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s var(--transition-bounce);
    border: none;
    position: relative;
    overflow: hidden;
    letter-spacing: 0.3px;
}

.btn::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    background: rgba(255,255,255,0.3);
    border-radius: 50%;
    transform: translate(-50%, -50%);
    transition: width 0.6s ease, height 0.6s ease;
}

.btn:active::after {
    width: 300px;
    height: 300px;
}

.btn-primary {
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    color: var(--white);
    box-shadow: 0 4px 15px rgba(13, 92, 99, 0.3);
}

.btn-primary:hover {
    background: linear-gradient(135deg, var(--primary-dark), var(--primary));
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(13, 92, 99, 0.4);
}

.btn-primary:active {
    transform: translateY(-1px);
    box-shadow: 0 4px 15px rgba(13, 92, 99, 0.3);
}

.btn-secondary {
    background: var(--white);
    color: var(--primary);
    border: 2px solid var(--primary);
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.btn-secondary:hover {
    background: var(--primary);
    color: var(--white);
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(13, 92, 99, 0.25);
}

.btn-secondary:active {
    transform: translateY(-1px);
}

/* Results Section */
.results-card {
    margin-bottom: 24px;
}

.results-description {
    color: var(--muted);
    margin-bottom: 16px;
}

.risk-summary {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 20px;
}

.risk-item {
    padding: 20px;
    border-radius: 16px;
    text-align: center;
    position: relative;
    overflow: hidden;
    transition: all 0.3s ease;
}

.risk-item:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 24px rgba(0,0,0,0.12);
}

/* Animated background pulse for high risk */
.risk-item.high {
    background: linear-gradient(135deg, var(--harm-light), #fff5f5);
    border: 2px solid var(--harm);
    animation: pulseHigh 2s ease-in-out infinite;
}

@keyframes pulseHigh {
    0%, 100% { box-shadow: 0 0 0 0 rgba(196, 69, 54, 0.2); }
    50% { box-shadow: 0 0 0 10px rgba(196, 69, 54, 0); }
}

.risk-item.moderate {
    background: linear-gradient(135deg, var(--accent-light), #fffbf0);
    border: 2px solid var(--accent);
}

.risk-item.low {
    background: linear-gradient(135deg, var(--benefit-light), #f0fff4);
    border: 2px solid var(--benefit);
}

/* Risk indicator icon */
.risk-item::before {
    font-size: 1.5rem;
    display: block;
    margin-bottom: 8px;
    opacity: 0.8;
}

.risk-item.high::before { content: '‚ö†Ô∏è'; }
.risk-item.moderate::before { content: '‚ö°'; }
.risk-item.low::before { content: '‚úÖ'; }

.risk-label {
    font-size: 0.85rem;
    color: var(--muted);
    margin-bottom: 8px;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.risk-value {
    font-size: 2.2rem;
    font-weight: 800;
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    line-height: 1.2;
}

.risk-item.high .risk-value {
    background: linear-gradient(135deg, var(--harm), #e74c3c);
    -webkit-background-clip: text;
    background-clip: text;
}

.risk-item.moderate .risk-value {
    background: linear-gradient(135deg, var(--accent), #e67e22);
    -webkit-background-clip: text;
    background-clip: text;
}

.risk-item.low .risk-value {
    background: linear-gradient(135deg, var(--benefit), #27ae60);
    -webkit-background-clip: text;
    background-clip: text;
}

.risk-interpretation {
    font-size: 0.8rem;
    margin-top: 8px;
    color: var(--muted);
    line-height: 1.4;
}

/* Medication Cards - Enhanced with benefit meter */
.med-card {
    background: white;
    border-radius: 16px;
    margin-bottom: 16px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.06);
    overflow: hidden;
    transition: all 0.3s var(--transition-bounce);
    position: relative;
}

.med-card:hover {
    box-shadow: 0 8px 30px rgba(0,0,0,0.12);
    transform: translateY(-3px);
}

/* Animated benefit indicator bar at top */
.med-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    height: 4px;
    width: var(--benefit-width, 50%);
    transition: width 0.6s ease-out, background 0.3s ease;
}

/* Status-based colors and widths */
.med-card.status-strong { --benefit-width: 95%; }
.med-card.status-strong::before { background: linear-gradient(90deg, #1a7a3e, #2ecc71); }
.med-card.status-strong { border-left: 5px solid #1a7a3e; }

.med-card.status-recommended { --benefit-width: 75%; }
.med-card.status-recommended::before { background: linear-gradient(90deg, var(--benefit), #3cb371); }
.med-card.status-recommended { border-left: 5px solid var(--benefit); }

.med-card.status-consider { --benefit-width: 50%; }
.med-card.status-consider::before { background: linear-gradient(90deg, var(--accent), #f0ad4e); }
.med-card.status-consider { border-left: 5px solid var(--accent); }

.med-card.status-marginal { --benefit-width: 25%; }
.med-card.status-marginal::before { background: linear-gradient(90deg, var(--muted), #95a5a6); }
.med-card.status-marginal { border-left: 5px solid var(--muted); }

.med-card.status-not-recommended { --benefit-width: 10%; }
.med-card.status-not-recommended::before { background: linear-gradient(90deg, var(--harm), #e74c3c); }
.med-card.status-not-recommended { border-left: 5px solid var(--harm); }

.med-card.status-caution-elderly { --benefit-width: 40%; }
.med-card.status-caution-elderly::before { background: linear-gradient(90deg, #e67e22, #f39c12); }
.med-card.status-caution-elderly { border-left: 5px solid #e67e22; }

/* Card Header - Always visible, clickable */
.med-card-header {
    display: flex;
    align-items: center;
    padding: 16px;
    gap: 16px;
    cursor: pointer;
    background: white;
}

.med-card-header:hover {
    background: var(--light-gray);
}

/* Status Icon */
.med-status-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 1.1rem;
    flex-shrink: 0;
}

.status-strong .med-status-icon { background: #d4edda; color: #1a7a3e; }
.status-recommended .med-status-icon { background: var(--benefit-light); color: var(--benefit); }
.status-consider .med-status-icon { background: var(--accent-light); color: #856404; }
.status-marginal .med-status-icon { background: var(--light-gray); color: var(--muted); }
.status-not-recommended .med-status-icon { background: var(--harm-light); color: var(--harm); }
.status-caution-elderly .med-status-icon { background: #ffeaa7; color: #e67e22; }

/* Main medication info */
.med-main-info {
    flex: 1;
    min-width: 0;
}

.med-name {
    font-weight: 600;
    font-size: 1.1rem;
    color: var(--text);
}

.med-class {
    font-size: 0.85rem;
    color: var(--muted);
}

/* Quick stats - net benefit number with animated circle */
.med-quick-stats {
    text-align: center;
    padding: 10px 16px;
    background: linear-gradient(135deg, var(--light-gray), white);
    border-radius: 12px;
    min-width: 90px;
    position: relative;
    border: 1px solid var(--border);
    transition: all 0.3s ease;
}

.med-card:hover .med-quick-stats {
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.med-net-benefit {
    font-size: 1.4rem;
    font-weight: 800;
    letter-spacing: -0.5px;
    transition: transform 0.3s ease;
}

.med-card:hover .med-net-benefit {
    transform: scale(1.1);
}

.status-strong .med-net-benefit,
.status-recommended .med-net-benefit {
    color: var(--benefit);
    text-shadow: 0 1px 2px rgba(46, 139, 87, 0.2);
}
.status-consider .med-net-benefit {
    color: var(--accent);
    text-shadow: 0 1px 2px rgba(212, 160, 60, 0.2);
}
.status-marginal .med-net-benefit { color: var(--muted); }
.status-not-recommended .med-net-benefit {
    color: var(--harm);
    text-shadow: 0 1px 2px rgba(196, 69, 54, 0.2);
}

.med-net-label {
    font-size: 0.6rem;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.8px;
    font-weight: 600;
    margin-top: 2px;
}

/* Tags for burden and cost */
.med-tags {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.tag {
    font-size: 0.7rem;
    padding: 3px 8px;
    border-radius: 10px;
    text-transform: uppercase;
    font-weight: 600;
    text-align: center;
}

/* Purpose tags - medication category */
.tag.purpose-preventive { background: #e3f2fd; color: #1565c0; }
.tag.purpose-disease_modifying { background: #e8f5e9; color: #2e7d32; }
.tag.purpose-symptomatic { background: #fff3e0; color: #e65100; }
.tag.purpose-replacement { background: #f3e5f5; color: #7b1fa2; }

/* Burden tags */
.tag.burden-low { background: #d4edda; color: #155724; }
.tag.burden-moderate { background: #fff3cd; color: #856404; }
.tag.burden-high { background: #f8d7da; color: #721c24; }
.tag.cost-tag { background: var(--light-gray); color: var(--muted); }

.expand-arrow {
    color: var(--muted);
    transition: transform 0.2s;
}

.med-card.expanded .expand-arrow {
    transform: rotate(180deg);
}

/* Summary line */
.med-card-summary {
    padding: 0 16px 12px 72px;
    display: flex;
    gap: 12px;
    font-size: 0.85rem;
}

.status-text {
    font-weight: 600;
}

.status-strong .status-text { color: #1a7a3e; }
.status-recommended .status-text { color: var(--benefit); }
.status-consider .status-text { color: #856404; }
.status-marginal .status-text { color: var(--muted); }
.status-not-recommended .status-text { color: var(--harm); }
.status-caution-elderly .status-text { color: #e67e22; }

/* Beers Criteria / Elderly Warning Box */
.beers-warning {
    background: linear-gradient(135deg, #fff5e6 0%, #ffe6cc 100%);
    border: 1px solid #e67e22;
    border-left: 4px solid #e67e22;
    border-radius: 8px;
    padding: 12px 16px;
    margin-top: 12px;
    font-size: 0.9rem;
}

.beers-warning-header {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 600;
    color: #d35400;
    margin-bottom: 6px;
}

.beers-warning-header::before {
    content: '!';
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 20px;
    height: 20px;
    background: #e67e22;
    color: white;
    border-radius: 50%;
    font-size: 0.8rem;
    font-weight: bold;
}

.beers-warning-content {
    color: #7f4f24;
    line-height: 1.4;
}

.beers-warning-recommendation {
    margin-top: 8px;
    padding-top: 8px;
    border-top: 1px dashed #e67e22;
    font-style: italic;
    color: #8b5a2b;
}

.elderly-caution-list {
    margin: 8px 0 0 0;
    padding-left: 20px;
}

.elderly-caution-list li {
    margin: 4px 0;
    color: #7f4f24;
}

.elderly-caution-list li.severity-high {
    color: #c0392b;
    font-weight: 500;
}

.benefit-for {
    color: var(--muted);
}

/* Potential medications sections */
.potential-section {
    margin-bottom: 24px;
}

.potential-section h4 {
    font-size: 1rem;
    color: var(--primary);
    margin-bottom: 12px;
    padding-bottom: 8px;
    border-bottom: 2px solid var(--primary-light);
}

.switch-note {
    font-size: 0.85rem;
    color: var(--muted);
    font-style: italic;
    margin-bottom: 12px;
}

/* Expandable details */
.med-card-details {
    border-top: 1px solid var(--border);
    padding: 16px;
    background: var(--light-gray);
}

.details-content {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
}

.detail-section {
    background: white;
    padding: 12px;
    border-radius: 8px;
}

.detail-section h5 {
    margin: 0 0 8px 0;
    font-size: 0.85rem;
    color: var(--primary);
}

.detail-section ul {
    margin: 0;
    padding-left: 16px;
    font-size: 0.85rem;
}

.detail-section li {
    margin-bottom: 6px;
}

.detail-section p {
    margin: 0;
    font-size: 0.85rem;
    color: var(--muted);
}

.benefits-detail { border-left: 3px solid var(--benefit); }
.harms-detail { border-left: 3px solid var(--harm); }
.burden-detail { border-left: 3px solid var(--burden); }
.calc-detail {
    grid-column: 1 / -1;
    border-left: 3px solid var(--primary);
    text-align: center;
}

.calc-detail strong {
    color: var(--primary);
    font-size: 1.1rem;
}

/* Legacy classes for backward compat */
.score-nnt {
    font-size: 0.75rem;
    color: var(--primary);
    margin-top: 4px;
    font-weight: 500;
}

/* Medication Details */
.med-benefits, .med-harms {
    margin-bottom: 10px;
}

.med-benefits strong, .med-harms strong {
    color: var(--primary);
    font-size: 0.85rem;
}

.med-benefits ul, .med-harms ul {
    margin-left: 18px;
    font-size: 0.85rem;
    color: var(--muted);
}

.med-benefits li, .med-harms li {
    margin-bottom: 3px;
}

.med-indications {
    font-size: 0.85rem;
    color: var(--primary);
    margin-bottom: 8px;
    padding: 6px 10px;
    background: var(--primary-light);
    border-radius: 6px;
}

.med-breakdown {
    display: flex;
    gap: 12px;
    margin-top: 10px;
    padding: 8px 12px;
    background: var(--light-gray);
    border-radius: 6px;
    font-size: 0.8rem;
}

.breakdown-item {
    padding: 4px 8px;
    border-radius: 4px;
}

.breakdown-item.benefit {
    background: var(--benefit-light);
    color: var(--benefit);
}

.breakdown-item.harm {
    background: var(--harm-light);
    color: var(--harm);
}

.breakdown-item.burden {
    background: var(--burden-light);
    color: var(--burden);
}

.med-recommendation {
    margin-top: 10px;
    padding: 8px 12px;
    background: rgba(0,0,0,0.03);
    border-radius: 6px;
    font-size: 0.9rem;
    font-weight: 500;
    color: var(--primary);
}

/* Summary display (always visible) */
.med-summary {
    display: flex;
    gap: 12px;
    margin: 10px 0;
    font-size: 0.85rem;
}

.summary-benefit {
    color: var(--benefit);
    font-weight: 500;
}

.summary-harm {
    color: var(--harm);
    font-weight: 500;
}

.summary-burden {
    color: var(--burden);
    font-weight: 500;
}

/* Clickable score area */
.med-result-score.clickable {
    cursor: pointer;
    transition: all 0.2s ease;
}

.med-result-score.clickable:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.expand-hint {
    font-size: 0.7rem;
    color: var(--muted);
    margin-top: 6px;
    opacity: 0.7;
}

.med-result-score.clickable:hover .expand-hint {
    opacity: 1;
}

/* Expanded state */
.med-result.expanded {
    box-shadow: 0 8px 24px rgba(0,0,0,0.12);
}

.med-result.expanded .expand-hint {
    transform: rotate(180deg);
    display: inline-block;
}

/* Expandable details section */
.med-details-expandable {
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px solid var(--border);
    animation: slideDown 0.3s ease;
}

@keyframes slideDown {
    from {
        opacity: 0;
        max-height: 0;
    }
    to {
        opacity: 1;
        max-height: 1000px;
    }
}

/* Calculation sections */
.calc-section {
    margin-bottom: 16px;
    padding: 12px;
    border-radius: 8px;
    background: var(--light-gray);
}

.calc-section h5 {
    margin: 0 0 10px 0;
    color: var(--primary);
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.calc-section ul {
    margin: 0;
    padding-left: 16px;
}

.calc-section li {
    margin-bottom: 12px;
    font-size: 0.85rem;
}

.calc-formula {
    display: block;
    font-family: 'Courier New', monospace;
    font-size: 0.8rem;
    background: white;
    padding: 6px 10px;
    border-radius: 4px;
    margin: 4px 0;
    color: var(--muted);
}

.calc-formula strong {
    color: var(--primary);
}

.calc-note {
    font-size: 0.75rem;
    color: var(--muted);
    font-style: italic;
}

/* Section-specific colors */
.benefits-calc {
    background: var(--benefit-light);
    border-left: 4px solid var(--benefit);
}

.benefits-calc h5 {
    color: var(--benefit);
}

.harms-calc {
    background: var(--harm-light);
    border-left: 4px solid var(--harm);
}

.harms-calc h5 {
    color: var(--harm);
}

.burden-calc {
    background: var(--burden-light);
    border-left: 4px solid var(--burden);
}

.burden-calc h5 {
    color: var(--burden);
}

.final-calc {
    background: var(--primary-light);
    border-left: 4px solid var(--primary);
}

.final-calc h5 {
    color: var(--primary);
}

.calc-formula.final {
    font-size: 0.9rem;
    padding: 10px 14px;
}

.calc-formula.final strong.positive {
    color: var(--benefit);
}

.calc-formula.final strong.neutral {
    color: var(--accent);
}

.calc-formula.final strong.negative {
    color: var(--harm);
}

/* Disclaimer */
.disclaimer {
    background: var(--accent-light);
    border-left: 4px solid var(--accent);
    padding: 16px;
    border-radius: 8px;
    margin-top: 24px;
    font-size: 0.9rem;
}

/* Footer */
footer {
    background: var(--primary-dark);
    color: var(--white);
    padding: 30px 0;
    text-align: center;
    margin-top: 40px;
}

footer p {
    opacity: 0.8;
    font-size: 0.9rem;
    margin-bottom: 4px;
}

/* Responsive - Enhanced for all devices */
@media (max-width: 768px) {
    header {
        padding: 35px 0 30px;
    }

    header h1 {
        font-size: 1.5rem;
    }

    header .subtitle {
        font-size: 0.95rem;
    }

    header .container::before,
    header .container::after {
        display: none;
    }

    .progress-bar {
        gap: 6px;
        padding: 20px 10px;
    }

    .progress-step {
        padding: 10px 14px;
        font-size: 0.8rem;
    }

    .progress-step:not(:last-child)::after {
        width: 20px;
        right: -20px;
    }

    .step-label {
        display: none;
    }

    .card {
        padding: 20px 16px;
        border-radius: 12px;
    }

    .form-grid {
        grid-template-columns: 1fr;
    }

    .checkbox-grid,
    .med-checkbox-grid {
        grid-template-columns: 1fr;
    }

    .nav-buttons {
        flex-direction: column;
        gap: 12px;
    }

    .btn {
        width: 100%;
        text-align: center;
        padding: 16px 24px;
    }

    .med-card-header {
        flex-wrap: wrap;
        gap: 12px;
    }

    .med-tags {
        flex-direction: row;
        width: 100%;
        justify-content: flex-start;
        flex-wrap: wrap;
        margin-top: 8px;
    }

    .med-quick-stats {
        order: -1;
    }

    .risk-summary {
        grid-template-columns: 1fr;
    }

    .details-content {
        grid-template-columns: 1fr;
    }

    .goc-option {
        font-size: 0.9rem;
    }

    .purpose-legend {
        grid-template-columns: 1fr;
    }
}

/* Tablet adjustments */
@media (min-width: 769px) and (max-width: 1024px) {
    .container {
        padding: 0 30px;
    }

    .risk-summary {
        grid-template-columns: repeat(2, 1fr);
    }
}

/* Touch device optimizations */
@media (hover: none) and (pointer: coarse) {
    .btn:hover {
        transform: none;
    }

    .card:hover {
        transform: none;
    }

    .med-card:hover {
        transform: none;
    }

    .risk-item:hover {
        transform: none;
    }

    /* Larger touch targets */
    .checkbox-label {
        padding: 14px 16px;
        min-height: 52px;
    }

    .med-checkbox {
        padding: 16px;
    }

    .goc-option {
        min-height: 60px;
    }
}

/* High contrast mode support */
@media (prefers-contrast: high) {
    .card {
        border: 2px solid var(--text);
    }

    .btn {
        border: 2px solid currentColor;
    }

    .med-card {
        border: 2px solid var(--text);
    }
}

/* Reduced motion preference */
@media (prefers-reduced-motion: reduce) {
    *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
    }

    header::before {
        display: none;
    }
}

/* Medication badges */
.med-badges {
    display: flex;
    gap: 8px;
    margin: 8px 0;
    flex-wrap: wrap;
}

.badge {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.3px;
}

.burden-low {
    background: #d4edda;
    color: #155724;
}

.burden-moderate {
    background: #fff3cd;
    color: #856404;
}

.burden-high {
    background: #f8d7da;
    color: #721c24;
}

.cost-badge {
    background: var(--light-gray);
    color: var(--muted);
}

/* Goals Summary Card */
.goals-summary-card {
    background: linear-gradient(135deg, var(--primary-light), var(--white));
    border-left: 5px solid var(--primary);
}

.goals-summary-content {
    text-align: center;
    padding: 10px 0;
}

.goals-badge {
    display: inline-block;
    padding: 8px 24px;
    border-radius: 20px;
    font-weight: 700;
    font-size: 1.1rem;
    color: white;
    margin-bottom: 12px;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.goals-badge.comfort { background: var(--harm); }
.goals-badge.selective { background: var(--accent); }
.goals-badge.balanced { background: var(--primary); }
.goals-badge.proactive { background: var(--benefit); }

.goals-summary-content p {
    margin: 8px 0;
    color: var(--muted);
}

.goals-threshold {
    background: white;
    padding: 10px 16px;
    border-radius: 8px;
    display: inline-block;
    margin-top: 8px !important;
}

.goals-threshold strong {
    color: var(--primary);
}

/* AI Import Section */
.ai-import-card {
    background: linear-gradient(135deg, #f0f9ff, var(--white));
    border: 2px dashed var(--primary);
}

.ai-import-card h3 {
    color: var(--primary);
    border-bottom: none;
    margin-bottom: 8px;
}

.ai-import-description {
    color: var(--muted);
    margin-bottom: 16px;
}

.ai-import-tabs {
    display: flex;
    gap: 8px;
    margin-bottom: 16px;
    border-bottom: 2px solid var(--border);
    padding-bottom: 8px;
}

.ai-tab {
    padding: 10px 20px;
    border: none;
    background: var(--light-gray);
    border-radius: 8px 8px 0 0;
    cursor: pointer;
    font-weight: 500;
    color: var(--muted);
    transition: all 0.2s;
}

.ai-tab:hover {
    background: var(--primary-light);
    color: var(--primary);
}

.ai-tab.active {
    background: var(--primary);
    color: white;
}

.ai-tab-content {
    display: none;
}

.ai-tab-content.active {
    display: block;
}

.ai-tab-description {
    color: var(--muted);
    margin-bottom: 12px;
    font-size: 0.9rem;
}

.prompt-container {
    position: relative;
}

.emr-prompt {
    background: #1e293b;
    color: #e2e8f0;
    padding: 16px;
    border-radius: 8px;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 0.8rem;
    line-height: 1.5;
    overflow-x: auto;
    white-space: pre-wrap;
    word-wrap: break-word;
    max-height: 300px;
    overflow-y: auto;
}

.copy-prompt-btn {
    margin-top: 12px;
}

.copy-prompt-btn.copied {
    background: var(--benefit);
    color: white;
    border-color: var(--benefit);
}

.ai-paste-textarea {
    width: 100%;
    min-height: 200px;
    padding: 14px;
    border: 2px solid var(--border);
    border-radius: 8px;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 0.85rem;
    resize: vertical;
    transition: border-color 0.2s;
}

.ai-paste-textarea:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(13, 92, 99, 0.1);
}

.ai-paste-textarea::placeholder {
    color: var(--muted);
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
}

.ai-extract-buttons {
    display: flex;
    gap: 12px;
    margin-top: 12px;
}

.ai-extract-status {
    margin-top: 12px;
    padding: 12px;
    border-radius: 8px;
    font-size: 0.9rem;
    display: none;
}

.ai-extract-status.success {
    display: block;
    background: var(--benefit-light);
    border-left: 4px solid var(--benefit);
    color: var(--benefit);
}

.ai-extract-status.error {
    display: block;
    background: var(--harm-light);
    border-left: 4px solid var(--harm);
    color: var(--harm);
}

.ai-extract-status.info {
    display: block;
    background: var(--primary-light);
    border-left: 4px solid var(--primary);
    color: var(--primary);
}

/* Purpose Legend */
.purpose-legend-card {
    background: linear-gradient(135deg, #f8fafc, #fff);
}

.purpose-legend {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 12px;
}

.purpose-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 12px;
    background: white;
    border-radius: 8px;
    border: 1px solid var(--border);
}

.purpose-item .tag {
    flex-shrink: 0;
}

.purpose-desc {
    font-size: 0.85rem;
    color: var(--muted);
    line-height: 1.4;
}

/* Print Styles */
@media print {
    header, footer, .nav-buttons, .progress-bar {
        display: none;
    }

    .form-section {
        display: block !important;
    }

    #section-risk-factors,
    #section-goals,
    #section-medications {
        display: none !important;
    }

    .card {
        break-inside: avoid;
        box-shadow: none;
        border: 1px solid var(--border);
    }

    .ai-import-card {
        display: none;
    }
}
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <div class="header-title">
                    <h1>MedBenefit Calculator</h1>
                    <p class="subtitle">Evidence-based, individualized medication assessment</p>
                </div>
                
                    <a href="data-reference.html" class="nav-link" title="View medication evidence data">
                        Data Reference
                    </a>
                </nav>
            </div>
        </div>
    </header>

    <main class="container">
        <!-- Progress indicator -->
        <div class="progress-bar">
            <div class="progress-step active" data-step="1">
                <span class="step-number">1</span>
                <span class="step-label">Risk Factors</span>
            </div>
            <div class="progress-step" data-step="2">
                <span class="step-number">2</span>
                <span class="step-label">Goals of Care</span>
            </div>
            <div class="progress-step" data-step="3">
                <span class="step-number">3</span>
                <span class="step-label">Medications</span>
            </div>
            <div class="progress-step" data-step="4">
                <span class="step-number">4</span>
                <span class="step-label">Results</span>
            </div>
        </div>

        <!-- SECTION 1: Risk Factors -->
        <section id="section-risk-factors" class="form-section active">
            <h2>Section 1: Your Health Profile</h2>
            <p class="section-description">Enter your health information to calculate individualized risks. This data is used locally and never stored.</p>

            <!-- AI Import Section -->
            <div class="card ai-import-card">
                <h3>Quick Import from Medical Records</h3>
                <p class="ai-import-description">Use AI to automatically extract patient data from your EMR or clinical notes.</p>

                <div class="ai-import-tabs">
                    <button type="button" class="ai-tab active" data-tab="emr-prompt">EMR AI Prompt</button>
                    <button type="button" class="ai-tab" data-tab="paste-extract">Paste & Extract</button>
                </div>

                <div id="emr-prompt-tab" class="ai-tab-content active">
                    <p class="ai-tab-description">Copy this prompt into your AI-enabled EMR to generate structured patient data:</p>
                    <div class="prompt-container">
                        <pre id="emr-prompt-text" class="emr-prompt">Extract the following patient information in JSON format for a medication benefit calculator:

{
  "demographics": {
    "age": [number],
    "sex": ["male" or "female"],
    "race": ["white", "black", "hispanic", "asian", or "other"],
    "weight_kg": [number],
    "height_cm": [number]
  },
  "vitals": {
    "systolic_bp": [number mmHg],
    "diastolic_bp": [number mmHg]
  },
  "labs": {
    "total_cholesterol": [number mg/dL],
    "ldl": [number mg/dL],
    "hdl": [number mg/dL],
    "triglycerides": [number mg/dL],
    "creatinine": [number mg/dL],
    "egfr": [number mL/min/1.73m¬≤],
    "a1c": [number %],
    "fasting_glucose": [number mg/dL],
    "bnp": [number pg/mL],
    "uacr": [number mg/g]
  },
  "cardiac": {
    "ejection_fraction": [number %],
    "nyha_class": [0-4, where 0=no HF],
    "afib": [true/false],
    "prior_stroke_tia": [true/false],
    "prior_mi": [true/false],
    "pvd": [true/false],
    "heart_failure": [true/false]
  },
  "diabetes": {
    "status": ["none", "prediabetes", "type2", or "type1"],
    "duration_years": [number]
  },
  "bleeding_risks": {
    "prior_major_bleed": [true/false],
    "anemia": [true/false],
    "liver_disease": [true/false],
    "heavy_alcohol": [true/false],
    "nsaid_use": [true/false],
    "on_antiplatelet": [true/false],
    "fall_risk": [true/false]
  },
  "other_conditions": {
    "hypertension_treated": [true/false],
    "current_smoker": [true/false],
    "former_smoker": [true/false],
    "family_hx_cad": [true/false],
    "copd": [true/false],
    "sleep_apnea": [true/false],
    "depression": [true/false],
    "dementia": [true/false],
    "active_cancer": [true/false],
    "frailty": [true/false],
    "osteoporosis": [true/false],
    "gout": [true/false]
  },
  "current_medications": [array of medication names from this list:
    // Cardiovascular
    "metoprolol", "carvedilol", "bisoprolol", "lisinopril", "enalapril",
    "losartan", "valsartan", "sacubitril_valsartan", "spironolactone",
    "eplerenone", "finerenone", "amlodipine", "hydrochlorothiazide",
    "chlorthalidone", "furosemide", "bumetanide", "torsemide", "digoxin",
    // Cholesterol
    "atorvastatin", "rosuvastatin", "simvastatin", "ezetimibe",
    "evolocumab", "icosapent_ethyl",
    // Diabetes
    "metformin", "empagliflozin", "dapagliflozin", "canagliflozin",
    "semaglutide", "liraglutide", "glipizide", "sitagliptin", "insulin",
    // Blood thinners
    "aspirin", "clopidogrel", "apixaban", "rivaroxaban",
    "rivaroxaban_vascular", "dabigatran", "edoxaban", "warfarin",
    // Osteoporosis
    "alendronate", "risedronate", "zoledronic_acid", "denosumab",
    "teriparatide", "romosozumab",
    // Respiratory
    "fluticasone_inh", "fluticasone_salmeterol", "tiotropium",
    "fluticasone_umeclidinium_vilanterol",
    // Gout
    "allopurinol", "febuxostat", "colchicine",
    // Pain/Neuro
    "gabapentin", "pregabalin", "duloxetine",
    // Other
    "omeprazole", "levothyroxine", "vitamin-d"
  ]
}

Use null for unknown values. Extract from the most recent available data.</pre>
                        <button type="button" class="btn btn-secondary copy-prompt-btn" onclick="copyEMRPrompt()">
                            Copy Prompt
                        </button>
                    </div>
                </div>

                <div id="paste-extract-tab" class="ai-tab-content">
                    <p class="ai-tab-description">Paste AI-generated JSON or clinical notes below, then click Extract:</p>
                    <textarea id="ai-paste-input" class="ai-paste-textarea" placeholder="Paste the JSON output from your EMR AI, or paste clinical notes/text and click Extract to use AI parsing..."></textarea>
                    <div class="ai-extract-buttons">
                        <button type="button" class="btn btn-primary" onclick="extractFromPaste()">
                            Extract & Fill Form
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="clearPasteInput()">
                            Clear
                        </button>
                    </div>
                    <div id="ai-extract-status" class="ai-extract-status"></div>
                </div>
            </div>

            <!-- Demographics -->
            <div class="card">
                <h3>Demographics</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="age">Age (years)</label>
                        <input type="number" id="age" min="18" max="120" placeholder="65" value="72">
                    </div>
                    <div class="form-group">
                        <label for="sex">Biological Sex</label>
                        <select id="sex">
                            <option value="">Select...</option>
                            <option value="male" selected>Male</option>
                            <option value="female">Female</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="race">Race/Ethnicity</label>
                        <select id="race">
                            <option value="">Select...</option>
                            <option value="white" selected>White</option>
                            <option value="black">Black/African American</option>
                            <option value="hispanic">Hispanic/Latino</option>
                            <option value="asian">Asian</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="weight">Weight (kg)</label>
                        <input type="number" id="weight" min="30" max="300" placeholder="70" value="85">
                    </div>
                    <div class="form-group">
                        <label for="height">Height (cm)</label>
                        <input type="number" id="height" min="100" max="250" placeholder="170" value="175">
                    </div>
                </div>
            </div>

            <!-- Cardiovascular Risk Factors -->
            <div class="card">
                <h3>Cardiovascular Risk Factors</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="systolic-bp">Systolic Blood Pressure (mmHg)</label>
                        <input type="number" id="systolic-bp" min="80" max="250" placeholder="130" value="142">
                    </div>
                    <div class="form-group">
                        <label for="diastolic-bp">Diastolic Blood Pressure (mmHg)</label>
                        <input type="number" id="diastolic-bp" min="40" max="150" placeholder="80" value="88">
                    </div>
                    <div class="form-group">
                        <label for="total-cholesterol">Total Cholesterol (mg/dL)</label>
                        <input type="number" id="total-cholesterol" min="100" max="400" placeholder="200" value="210">
                    </div>
                    <div class="form-group">
                        <label for="ldl">LDL Cholesterol (mg/dL)</label>
                        <input type="number" id="ldl" min="30" max="300" placeholder="130" value="125">
                    </div>
                    <div class="form-group">
                        <label for="hdl">HDL Cholesterol (mg/dL)</label>
                        <input type="number" id="hdl" min="15" max="150" placeholder="50" value="42">
                    </div>
                    <div class="form-group">
                        <label for="triglycerides">Triglycerides (mg/dL)</label>
                        <input type="number" id="triglycerides" min="30" max="1000" placeholder="150" value="180">
                    </div>
                </div>
                <div class="checkbox-grid">
                    <label class="checkbox-label">
                        <input type="checkbox" id="htn-treatment" checked>
                        <span>Currently on blood pressure medication</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="smoker">
                        <span>Current smoker</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="former-smoker">
                        <span>Former smoker</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="family-hx-cad">
                        <span>Family history of premature heart disease</span>
                    </label>
                </div>
            </div>

            <!-- Diabetes -->
            <div class="card">
                <h3>Diabetes</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="diabetes-status">Diabetes Status</label>
                        <select id="diabetes-status">
                            <option value="none">No diabetes</option>
                            <option value="prediabetes">Prediabetes</option>
                            <option value="type2" selected>Type 2 Diabetes</option>
                            <option value="type1">Type 1 Diabetes</option>
                        </select>
                    </div>
                    <div class="form-group diabetes-fields">
                        <label for="a1c">HbA1c (%)</label>
                        <input type="number" id="a1c" min="4" max="15" step="0.1" placeholder="7.0" value="7.8">
                    </div>
                    <div class="form-group diabetes-fields">
                        <label for="diabetes-duration">Years since diagnosis</label>
                        <input type="number" id="diabetes-duration" min="0" max="60" placeholder="5" value="8">
                    </div>
                    <div class="form-group diabetes-fields">
                        <label for="fasting-glucose">Fasting glucose (mg/dL)</label>
                        <input type="number" id="fasting-glucose" min="50" max="500" placeholder="120" value="145">
                    </div>
                </div>
            </div>

            <!-- Heart & Kidney Function -->
            <div class="card">
                <h3>Heart & Kidney Function</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="ef">Ejection Fraction (%) <span class="optional">if known</span></label>
                        <input type="number" id="ef" min="5" max="80" placeholder="55" value="35">
                    </div>
                    <div class="form-group">
                        <label for="nyha">Heart Failure Symptoms</label>
                        <select id="nyha">
                            <option value="0">No heart failure</option>
                            <option value="1">NYHA I - No limitation</option>
                            <option value="2" selected>NYHA II - Mild limitation</option>
                            <option value="3">NYHA III - Moderate limitation</option>
                            <option value="4">NYHA IV - Severe limitation</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="creatinine">Creatinine (mg/dL)</label>
                        <input type="number" id="creatinine" min="0.3" max="15" step="0.1" placeholder="1.0" value="1.4">
                    </div>
                    <div class="form-group">
                        <label for="egfr">eGFR (mL/min/1.73m¬≤) <span class="optional">if known</span></label>
                        <input type="number" id="egfr" min="5" max="150" placeholder="90" value="52">
                    </div>
                    <div class="form-group">
                        <label for="uacr">Urine Albumin/Creatinine Ratio (mg/g) <span class="optional">if known</span></label>
                        <input type="number" id="uacr" min="0" max="5000" placeholder="30" value="120">
                    </div>
                    <div class="form-group">
                        <label for="bnp">BNP (pg/mL) <span class="optional">if known</span></label>
                        <input type="number" id="bnp" min="0" max="10000" placeholder="100" value="450">
                    </div>
                </div>
            </div>

            <!-- Atrial Fibrillation -->
            <div class="card">
                <h3>Atrial Fibrillation & Stroke Risk</h3>
                <div class="checkbox-grid">
                    <label class="checkbox-label">
                        <input type="checkbox" id="afib" checked>
                        <span>Atrial fibrillation or flutter</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="prior-stroke">
                        <span>Prior stroke or TIA</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="prior-mi">
                        <span>Prior heart attack (MI)</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="pvd">
                        <span>Peripheral vascular disease</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="chf-history" checked>
                        <span>History of heart failure</span>
                    </label>
                </div>
            </div>

            <!-- Bleeding Risk -->
            <div class="card">
                <h3>Bleeding Risk Factors</h3>
                <div class="checkbox-grid">
                    <label class="checkbox-label">
                        <input type="checkbox" id="prior-bleed">
                        <span>Prior major bleeding</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="anemia">
                        <span>Anemia</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="liver-disease">
                        <span>Liver disease</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="alcohol">
                        <span>Heavy alcohol use (>8 drinks/week)</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="nsaid-use">
                        <span>Regular NSAID use</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="antiplatelet">
                        <span>On antiplatelet therapy (aspirin, clopidogrel)</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="fall-risk">
                        <span>High fall risk</span>
                    </label>
                </div>
            </div>

            <!-- Other Conditions -->
            <div class="card">
                <h3>Other Medical History</h3>
                <div class="checkbox-grid">
                    <label class="checkbox-label">
                        <input type="checkbox" id="copd">
                        <span>COPD or chronic lung disease</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="osa">
                        <span>Sleep apnea</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="depression">
                        <span>Depression or anxiety</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="dementia">
                        <span>Cognitive impairment or dementia</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="cancer">
                        <span>Active cancer</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="frailty">
                        <span>Frailty or poor functional status</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="osteoporosis">
                        <span>Osteoporosis</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="gout">
                        <span>Gout</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="asthma">
                        <span>Asthma</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="neuropathy">
                        <span>Diabetic neuropathy or chronic pain</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="hypothyroidism">
                        <span>Hypothyroidism</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="fibromyalgia">
                        <span>Fibromyalgia</span>
                    </label>
                </div>
            </div>

            <div class="nav-buttons">
                <button type="button" class="btn btn-primary" onclick="goToSection(2)">Continue to Goals of Care ‚Üí</button>
            </div>
        </section>

        <!-- SECTION 2: Goals of Care -->
        <section id="section-goals" class="form-section">
            <h2>Section 2: Your Goals of Care</h2>
            <p class="section-description">Help us understand what matters most to you in medical decisions.</p>

            <div class="card">
                <h3>Treatment Philosophy</h3>
                <p>On a spectrum from comfort-focused to aggressive prevention, where do you fall?</p>

                <div class="goc-spectrum">
                    <div class="goc-option" data-value="1">
                        <div class="goc-header comfort">Comfort-Focused</div>
                        <div class="goc-description">
                            <p><strong>My priority is quality of life now.</strong></p>
                            <ul>
                                <li>I want to minimize medications and their side effects</li>
                                <li>Only take treatments with very large, proven benefits</li>
                                <li>I'd rather accept health risks than medication burden</li>
                            </ul>
                        </div>
                    </div>

                    <div class="goc-option" data-value="2">
                        <div class="goc-header selective">Selective</div>
                        <div class="goc-description">
                            <p><strong>I want high-value treatments only.</strong></p>
                            <ul>
                                <li>I'll take medications with clear, substantial benefit</li>
                                <li>Avoid treatments where burden outweighs benefit</li>
                                <li>Quality of evidence matters to me</li>
                            </ul>
                        </div>
                    </div>

                    <div class="goc-option" data-value="3">
                        <div class="goc-header balanced">Balanced</div>
                        <div class="goc-description">
                            <p><strong>I want reasonable prevention with attention to burden.</strong></p>
                            <ul>
                                <li>I'll consider most recommended preventive treatments</li>
                                <li>Some medication burden is acceptable for benefits</li>
                                <li>I trust guidelines but want them personalized</li>
                            </ul>
                        </div>
                    </div>

                    <div class="goc-option" data-value="4">
                        <div class="goc-header proactive">Proactive</div>
                        <div class="goc-description">
                            <p><strong>I want to maximize prevention.</strong></p>
                            <ul>
                                <li>I'll take medications with any proven benefit</li>
                                <li>Willing to accept burden for potential gain</li>
                                <li>Living longer is very important to me</li>
                            </ul>
                        </div>
                    </div>
                </div>
                <input type="hidden" id="goc-value" value="">
            </div>

            <div class="card">
                <h3>Additional Preferences</h3>
                <div class="form-grid">
                    <div class="form-group full-width">
                        <label for="time-horizon">How far ahead do you think about health benefits?</label>
                        <select id="time-horizon">
                            <option value="1">Mostly day-to-day and short term</option>
                            <option value="2">1-2 years ahead</option>
                            <option value="3" selected>3-5 years ahead</option>
                            <option value="5">5-10 years ahead</option>
                            <option value="10">10+ years - long-term planning</option>
                        </select>
                    </div>
                    <div class="form-group full-width">
                        <label for="pill-burden">How do you feel about taking multiple medications?</label>
                        <select id="pill-burden">
                            <option value="low">I strongly prefer fewer medications</option>
                            <option value="moderate" selected>I'm okay with medications if they help</option>
                            <option value="high">Number of medications doesn't bother me</option>
                        </select>
                    </div>
                    <div class="form-group full-width">
                        <label for="cost-sensitivity">How important is medication cost?</label>
                        <select id="cost-sensitivity">
                            <option value="high">Very important - cost is a major factor</option>
                            <option value="moderate" selected>Somewhat important</option>
                            <option value="low">Not a significant factor</option>
                        </select>
                    </div>
                    <div class="form-group full-width">
                        <label for="monitoring-tolerance">How do you feel about monitoring (blood tests, clinic visits)?</label>
                        <select id="monitoring-tolerance">
                            <option value="low">I want to minimize appointments and tests</option>
                            <option value="moderate" selected>I can do reasonable monitoring</option>
                            <option value="high">I'm fine with frequent monitoring if needed</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="nav-buttons">
                <button type="button" class="btn btn-secondary" onclick="goToSection(1)">‚Üê Back</button>
                <button type="button" class="btn btn-primary" onclick="goToSection(3)">Continue to Medications ‚Üí</button>
            </div>
        </section>

        <!-- SECTION 3: Medications -->
        <section id="section-medications" class="form-section">
            <h2>Section 3: Your Current Medications</h2>
            <p class="section-description">Select all medications you are currently taking.</p>

            <div class="card">
                <h3>Cardiovascular Medications</h3>
                <div class="med-checkbox-grid">
                    <label class="med-checkbox">
                        <input type="checkbox" data-med="metoprolol">
                        <span class="med-name">Metoprolol XL (Toprol)</span>
                        <span class="med-class">Beta-blocker</span>
                    </label>
                    <label class="med-checkbox">
                        <input type="checkbox" data-med="carvedilol" checked>
                        <span class="med-name">Carvedilol (Coreg)</span>
                        <span class="med-class">Beta-blocker</span>
                    </label>
                    <label class="med-checkbox">
                        <input type="checkbox" data-med="bisoprolol">
                        <span class="med-name">Bisoprolol (Zebeta)</span>
                        <span class="med-class">Beta-blocker</span>
                    </label>
                    <label class="med-checkbox">
                        <input type="checkbox" data-med="lisinopril">
                        <span class="med-name">Lisinopril (Zestril)</span>
                        <span class="med-class">ACE Inhibitor</span>
                    </label>
                    <label class="med-checkbox">
                        <input type="checkbox" data-med="enalapril">
                        <span class="med-name">Enalapril (Vasotec)</span>
                        <span class="med-class">ACE Inhibitor</span>
                    </label>
                    <label class="med-checkbox">
                        <input type="checkbox" data-med="losartan">
                        <span class="med-name">Losartan (Cozaar)</span>
                        <span class="med-class">ARB</span>
                    </label>
                    <label class="med-checkbox">
                        <input type="checkbox" data-med="valsartan">
                        <span class="med-name">Valsartan (Diovan)</span>
                        <span class="med-class">ARB</span>
                    </label>
                    <label class="med-checkbox">
                        <input type="checkbox" data-med="sacubitril_valsartan">
                        <span class="med-name">Entresto (sacubitril/valsartan)</span>
                        <span class="med-class">ARNI</span>
                    </label>
                    <label class="med-checkbox">
                        <input type="checkbox" data-med="spironolactone">
                        <span class="med-name">Spironolactone (Aldactone)</span>
                        <span class="med-class">MRA</span>
                    </label>
                    <label class="med-checkbox">
                        <input type="checkbox" data-med="eplerenone">
                        <span class="med-name">Eplerenone (Inspra)</span>
                        <span class="med-class">MRA</span>
                    </label>
                    <label class="med-checkbox">
                        <input type="checkbox" data-med="finerenone">
                        <span class="med-name">Finerenone (Kerendia)</span>
                        <span class="med-class">Non-steroidal MRA</span>
                    </label>
                    <label class="med-checkbox">
                        <input type="checkbox" data-med="amlodipine">
                        <span class="med-name">Amlodipine (Norvasc)</span>
                        <span class="med-class">Calcium Channel Blocker</span>
                    </label>
                    <label class="med-checkbox">
                        <input type="checkbox" data-med="hydrochlorothiazide">
                        <span class="med-name">Hydrochlorothiazide (HCTZ)</span>
                        <span class="med-class">Thiazide Diuretic</span>
                    </label>
                    <label class="med-checkbox">
                        <input type="checkbox" data-med="chlorthalidone">
                        <span class="med-name">Chlorthalidone (Hygroton)</span>
                        <span class="med-class">Thiazide-like Diuretic</span>
                    </label>
                    <label class="med-checkbox">
                        <input type="checkbox" data-med="furosemide" checked>
                        <span class="med-name">Furosemide (Lasix)</span>
                        <span class="med-class">Loop Diuretic</span>
                    </label>
                    <label class="med-checkbox">
                        <input type="checkbox" data-med="bumetanide">
                        <span class="med-name">Bumetanide (Bumex)</span>
                        <span class="med-class">Loop Diuretic</span>
                    </label>
                    <label class="med-checkbox">
                        <input type="checkbox" data-med="torsemide">
                        <span class="med-name">Torsemide (Demadex)</span>
                        <span class="med-class">Loop Diuretic</span>
                    </label>
                    <label class="med-checkbox">
                        <input type="checkbox" data-med="digoxin">
                        <span class="med-name">Digoxin (Lanoxin)</span>
                        <span class="med-class">Cardiac Glycoside</span>
                    </label>
                </div>
            </div>

            <div class="card">
                <h3>Cholesterol Medications</h3>
                <div class="med-checkbox-grid">
                    <label class="med-checkbox">
                        <input type="checkbox" data-med="atorvastatin" checked>
                        <span class="med-name">Atorvastatin (Lipitor)</span>
                        <span class="med-class">Statin</span>
                    </label>
                    <label class="med-checkbox">
                        <input type="checkbox" data-med="rosuvastatin">
                        <span class="med-name">Rosuvastatin (Crestor)</span>
                        <span class="med-class">Statin</span>
                    </label>
                    <label class="med-checkbox">
                        <input type="checkbox" data-med="simvastatin">
                        <span class="med-name">Simvastatin (Zocor)</span>
                        <span class="med-class">Statin</span>
                    </label>
                    <label class="med-checkbox">
                        <input type="checkbox" data-med="ezetimibe">
                        <span class="med-name">Ezetimibe (Zetia)</span>
                        <span class="med-class">Cholesterol Absorption Inhibitor</span>
                    </label>
                    <label class="med-checkbox">
                        <input type="checkbox" data-med="evolocumab">
                        <span class="med-name">Evolocumab (Repatha)</span>
                        <span class="med-class">PCSK9 Inhibitor</span>
                    </label>
                    <label class="med-checkbox">
                        <input type="checkbox" data-med="icosapent_ethyl">
                        <span class="med-name">Icosapent Ethyl (Vascepa)</span>
                        <span class="med-class">Omega-3 (EPA)</span>
                    </label>
                </div>
            </div>

            <div class="card">
                <h3>Diabetes Medications</h3>
                <div class="med-checkbox-grid">
                    <label class="med-checkbox">
                        <input type="checkbox" data-med="metformin" checked>
                        <span class="med-name">Metformin (Glucophage)</span>
                        <span class="med-class">Biguanide</span>
                    </label>
                    <label class="med-checkbox">
                        <input type="checkbox" data-med="empagliflozin">
                        <span class="med-name">Empagliflozin (Jardiance)</span>
                        <span class="med-class">SGLT2 Inhibitor</span>
                    </label>
                    <label class="med-checkbox">
                        <input type="checkbox" data-med="dapagliflozin">
                        <span class="med-name">Dapagliflozin (Farxiga)</span>
                        <span class="med-class">SGLT2 Inhibitor</span>
                    </label>
                    <label class="med-checkbox">
                        <input type="checkbox" data-med="canagliflozin">
                        <span class="med-name">Canagliflozin (Invokana)</span>
                        <span class="med-class">SGLT2 Inhibitor</span>
                    </label>
                    <label class="med-checkbox">
                        <input type="checkbox" data-med="semaglutide">
                        <span class="med-name">Semaglutide (Ozempic/Wegovy)</span>
                        <span class="med-class">GLP-1 Agonist</span>
                    </label>
                    <label class="med-checkbox">
                        <input type="checkbox" data-med="liraglutide">
                        <span class="med-name">Liraglutide (Victoza)</span>
                        <span class="med-class">GLP-1 Agonist</span>
                    </label>
                    <label class="med-checkbox">
                        <input type="checkbox" data-med="glipizide" checked>
                        <span class="med-name">Glipizide (Glucotrol)</span>
                        <span class="med-class">Sulfonylurea</span>
                    </label>
                    <label class="med-checkbox">
                        <input type="checkbox" data-med="sitagliptin">
                        <span class="med-name">Sitagliptin (Januvia)</span>
                        <span class="med-class">DPP-4 Inhibitor</span>
                    </label>
                    <label class="med-checkbox">
                        <input type="checkbox" data-med="insulin">
                        <span class="med-name">Insulin (any type)</span>
                        <span class="med-class">Insulin</span>
                    </label>
                </div>
            </div>

            <div class="card">
                <h3>Blood Thinners</h3>
                <div class="med-checkbox-grid">
                    <label class="med-checkbox">
                        <input type="checkbox" data-med="aspirin">
                        <span class="med-name">Aspirin (81mg or 325mg)</span>
                        <span class="med-class">Antiplatelet</span>
                    </label>
                    <label class="med-checkbox">
                        <input type="checkbox" data-med="clopidogrel">
                        <span class="med-name">Clopidogrel (Plavix)</span>
                        <span class="med-class">Antiplatelet</span>
                    </label>
                    <label class="med-checkbox">
                        <input type="checkbox" data-med="apixaban" checked>
                        <span class="med-name">Apixaban (Eliquis)</span>
                        <span class="med-class">DOAC</span>
                    </label>
                    <label class="med-checkbox">
                        <input type="checkbox" data-med="rivaroxaban">
                        <span class="med-name">Rivaroxaban (Xarelto)</span>
                        <span class="med-class">DOAC</span>
                    </label>
                    <label class="med-checkbox">
                        <input type="checkbox" data-med="rivaroxaban_vascular">
                        <span class="med-name">Rivaroxaban 2.5mg + ASA (COMPASS)</span>
                        <span class="med-class">Vascular Protection</span>
                    </label>
                    <label class="med-checkbox">
                        <input type="checkbox" data-med="dabigatran">
                        <span class="med-name">Dabigatran (Pradaxa)</span>
                        <span class="med-class">DOAC</span>
                    </label>
                    <label class="med-checkbox">
                        <input type="checkbox" data-med="edoxaban">
                        <span class="med-name">Edoxaban (Savaysa)</span>
                        <span class="med-class">DOAC</span>
                    </label>
                    <label class="med-checkbox">
                        <input type="checkbox" data-med="warfarin">
                        <span class="med-name">Warfarin (Coumadin)</span>
                        <span class="med-class">Vitamin K Antagonist</span>
                    </label>
                </div>
            </div>

            <div class="card">
                <h3>Osteoporosis Medications</h3>
                <div class="med-checkbox-grid">
                    <label class="med-checkbox">
                        <input type="checkbox" data-med="alendronate">
                        <span class="med-name">Alendronate (Fosamax)</span>
                        <span class="med-class">Bisphosphonate</span>
                    </label>
                    <label class="med-checkbox">
                        <input type="checkbox" data-med="risedronate">
                        <span class="med-name">Risedronate (Actonel)</span>
                        <span class="med-class">Bisphosphonate</span>
                    </label>
                    <label class="med-checkbox">
                        <input type="checkbox" data-med="zoledronic_acid">
                        <span class="med-name">Zoledronic Acid (Reclast)</span>
                        <span class="med-class">IV Bisphosphonate</span>
                    </label>
                    <label class="med-checkbox">
                        <input type="checkbox" data-med="denosumab">
                        <span class="med-name">Denosumab (Prolia)</span>
                        <span class="med-class">RANK Ligand Inhibitor</span>
                    </label>
                    <label class="med-checkbox">
                        <input type="checkbox" data-med="teriparatide">
                        <span class="med-name">Teriparatide (Forteo)</span>
                        <span class="med-class">PTH Analog</span>
                    </label>
                    <label class="med-checkbox">
                        <input type="checkbox" data-med="romosozumab">
                        <span class="med-name">Romosozumab (Evenity)</span>
                        <span class="med-class">Sclerostin Inhibitor</span>
                    </label>
                </div>
            </div>

            <div class="card">
                <h3>Respiratory Medications</h3>
                <div class="med-checkbox-grid">
                    <label class="med-checkbox">
                        <input type="checkbox" data-med="fluticasone_inh">
                        <span class="med-name">Fluticasone Inhaler (Flovent)</span>
                        <span class="med-class">Inhaled Steroid</span>
                    </label>
                    <label class="med-checkbox">
                        <input type="checkbox" data-med="fluticasone_salmeterol">
                        <span class="med-name">Fluticasone/Salmeterol (Advair)</span>
                        <span class="med-class">ICS/LABA</span>
                    </label>
                    <label class="med-checkbox">
                        <input type="checkbox" data-med="tiotropium">
                        <span class="med-name">Tiotropium (Spiriva)</span>
                        <span class="med-class">LAMA</span>
                    </label>
                    <label class="med-checkbox">
                        <input type="checkbox" data-med="fluticasone_umeclidinium_vilanterol">
                        <span class="med-name">Trelegy (Triple Inhaler)</span>
                        <span class="med-class">ICS/LAMA/LABA</span>
                    </label>
                </div>
            </div>

            <div class="card">
                <h3>Gout Medications</h3>
                <div class="med-checkbox-grid">
                    <label class="med-checkbox">
                        <input type="checkbox" data-med="allopurinol">
                        <span class="med-name">Allopurinol (Zyloprim)</span>
                        <span class="med-class">Xanthine Oxidase Inhibitor</span>
                    </label>
                    <label class="med-checkbox">
                        <input type="checkbox" data-med="febuxostat">
                        <span class="med-name">Febuxostat (Uloric)</span>
                        <span class="med-class">Xanthine Oxidase Inhibitor</span>
                    </label>
                    <label class="med-checkbox">
                        <input type="checkbox" data-med="colchicine">
                        <span class="med-name">Colchicine (Colcrys)</span>
                        <span class="med-class">Anti-inflammatory</span>
                    </label>
                </div>
            </div>

            <div class="card">
                <h3>Pain & Nerve Medications</h3>
                <div class="med-checkbox-grid">
                    <label class="med-checkbox">
                        <input type="checkbox" data-med="gabapentin">
                        <span class="med-name">Gabapentin (Neurontin)</span>
                        <span class="med-class">Neuropathic Pain</span>
                    </label>
                    <label class="med-checkbox">
                        <input type="checkbox" data-med="pregabalin">
                        <span class="med-name">Pregabalin (Lyrica)</span>
                        <span class="med-class">Neuropathic Pain</span>
                    </label>
                    <label class="med-checkbox">
                        <input type="checkbox" data-med="duloxetine">
                        <span class="med-name">Duloxetine (Cymbalta)</span>
                        <span class="med-class">SNRI</span>
                    </label>
                </div>
            </div>

            <div class="card">
                <h3>Other Medications</h3>
                <div class="med-checkbox-grid">
                    <label class="med-checkbox">
                        <input type="checkbox" data-med="omeprazole">
                        <span class="med-name">Omeprazole (Prilosec)</span>
                        <span class="med-class">Proton Pump Inhibitor</span>
                    </label>
                    <label class="med-checkbox">
                        <input type="checkbox" data-med="levothyroxine">
                        <span class="med-name">Levothyroxine (Synthroid)</span>
                        <span class="med-class">Thyroid Hormone</span>
                    </label>
                    <label class="med-checkbox">
                        <input type="checkbox" data-med="vitamin-d">
                        <span class="med-name">Vitamin D</span>
                        <span class="med-class">Supplement</span>
                    </label>
                </div>
            </div>

            <div class="nav-buttons">
                <button type="button" class="btn btn-secondary" onclick="goToSection(2)">‚Üê Back</button>
                <button type="button" class="btn btn-primary" onclick="calculateResults()">Calculate Net Benefits ‚Üí</button>
            </div>
        </section>

        <!-- SECTION 4: Results -->
        <section id="section-results" class="form-section">
            <h2>Section 4: Your Personalized Results</h2>

            <!-- Goals Summary -->
            <div class="card results-card goals-summary-card">
                <div id="goals-summary">
                    <!-- Populated by JavaScript -->
                </div>
            </div>

            <!-- Calculated Risks Summary -->
            <div class="card results-card">
                <h3>Your Calculated Risk Profile</h3>
                <div id="risk-summary" class="risk-summary">
                    <!-- Populated by JavaScript -->
                </div>
            </div>

            <!-- Purpose Legend -->
            <div class="card results-card purpose-legend-card">
                <h3>Medication Purpose Categories</h3>
                <div class="purpose-legend">
                    <div class="purpose-item">
                        <span class="tag purpose-preventive">PREVENT</span>
                        <span class="purpose-desc">Prevents future events (e.g., statins, anticoagulants, bisphosphonates)</span>
                    </div>
                    <div class="purpose-item">
                        <span class="tag purpose-disease_modifying">DISEASE-MOD</span>
                        <span class="purpose-desc">Treats underlying disease and changes its course (e.g., HF meds, SGLT2i for CKD)</span>
                    </div>
                    <div class="purpose-item">
                        <span class="tag purpose-symptomatic">SYMPTOM</span>
                        <span class="purpose-desc">Relieves symptoms without altering disease (e.g., pain meds, loop diuretics)</span>
                    </div>
                    <div class="purpose-item">
                        <span class="tag purpose-replacement">REPLACE</span>
                        <span class="purpose-desc">Replaces missing hormones/nutrients (e.g., levothyroxine, vitamin D)</span>
                    </div>
                </div>
            </div>

            <!-- Current Medications Analysis -->
            <div class="card results-card">
                <h3>Analysis of Your Current Medications</h3>
                <p class="results-description">Based on your goals of care and individual risk factors</p>
                <div id="current-meds-analysis">
                    <!-- Populated by JavaScript -->
                </div>
            </div>

            <!-- Potential Medications to Consider -->
            <div class="card results-card">
                <h3>Potential Medications to Consider</h3>
                <p class="results-description">Best options by medication class based on your profile</p>
                <div id="potential-meds">
                    <!-- Populated by JavaScript -->
                </div>
            </div>

            <div class="nav-buttons">
                <button type="button" class="btn btn-secondary" onclick="goToSection(3)">‚Üê Back to Medications</button>
                <button type="button" class="btn btn-primary" onclick="printResults()">Print Results</button>
            </div>

            <div class="disclaimer">
                <strong>Important Disclaimer:</strong> This tool is for educational purposes only and should not replace medical advice.
                All medication decisions should be made in consultation with your healthcare provider.
                The calculations are estimates based on published clinical trial data and may not fully capture your individual situation.
            </div>
        </section>
    </main>

    <footer>
        <div class="container">
            <p>Patient-Centered Medication Benefit Calculator | Based on evidence-based medicine principles</p>
            <p>Created for educational purposes | Always consult your healthcare provider</p>
        </div>
    </footer>

<script>
/**
 * Medications Database - Evidence-Based NNT and NNH Values
 *
 * Each medication has:
 * - id: unique identifier
 * - name: generic name
 * - brandNames: common brand names
 * - class: medication class
 * - purpose: 'preventive' | 'disease_modifying' | 'symptomatic' | 'replacement'
 *     - preventive: Prevents future events/disease (statins for primary prevention, bisphosphonates)
 *     - disease_modifying: Treats underlying disease and alters its course (HF meds, SGLT2i for CKD)
 *     - symptomatic: Relieves symptoms without changing disease course (pain meds, PPIs, loop diuretics)
 *     - replacement: Replaces missing hormones/nutrients (levothyroxine, vitamin D)
 * - indications: array of conditions this treats/prevents
 * - benefits: object with indication -> outcome -> { rrr, nnt, timeframe, endpoint, quality, source }
 * - harms: ONLY serious adverse events with NNH from clinical trials
 *          Minor side effects (fatigue, nausea, etc.) are now part of burden
 * - burden: 'low' | 'moderate' | 'high' - includes pill burden + minor side effects
 * - burdenDetails: description of what makes it burdensome (including minor side effects)
 * - annualCost: estimated annual cost in USD
 * - monitoring: what monitoring is required
 * - contraindications: conditions where this shouldn't be used
 */

const MEDICATIONS_DATABASE = {
    // ===== 1. BETA-BLOCKER FOR HEART FAILURE - CARVEDILOL =====
    "carvedilol": {
        id: "carvedilol",
        name: "Carvedilol",
        brandNames: ["Coreg"],
        class: "Beta-blocker",
        purpose: "disease_modifying", // Improves survival and alters HF disease course
        indications: ["heart_failure", "post_mi", "hypertension"],
        benefits: {
            heart_failure: {
                mortality: { rrr: 0.35, nnt: 9, timeframe: 3, endpoint: "all-cause mortality", quality: "hard", source: "COPERNICUS" },
                hospitalization: { rrr: 0.24, nnt: 14, timeframe: 1, endpoint: "HF hospitalization", quality: "hard", source: "COPERNICUS" }
            },
            post_mi: {
                mortality: { rrr: 0.23, nnt: 42, timeframe: 2, endpoint: "all-cause mortality", quality: "hard", source: "CAPRICORN" }
            }
        },
        harms: {
            // Serious harms only - minor symptoms in burden
            // Beta-blockers in HF: serious bradycardia/hypotension requiring discontinuation is rare
            // No robust NNH data for serious harms - benefits vastly outweigh
        },
        burden: "moderate",
        burdenDetails: "Twice daily dosing. Common: fatigue (15%), dizziness (10%), bradycardia (5%). Requires slow uptitration over weeks.",
        annualCost: 48,
        monitoring: "Heart rate and blood pressure monitoring during uptitration",
        contraindications: ["severe_bradycardia", "heart_block", "severe_asthma", "decompensated_hf"]
    },

    // ===== 2. SGLT2 INHIBITOR - EMPAGLIFLOZIN =====
    "empagliflozin": {
        id: "empagliflozin",
        name: "Empagliflozin",
        brandNames: ["Jardiance"],
        class: "SGLT2 Inhibitor",
        purpose: "disease_modifying", // Modifies HF, CKD, and diabetes disease progression
        indications: ["heart_failure", "diabetes", "ckd"],
        benefits: {
            heart_failure: {
                cv_death_hf_hosp: { rrr: 0.25, nnt: 19, timeframe: 1.3, endpoint: "CV death or HF hospitalization", quality: "hard", source: "EMPEROR-Reduced" },
                mortality: { rrr: 0.17, nnt: 45, timeframe: 1.3, endpoint: "all-cause mortality", quality: "hard", source: "EMPEROR-Reduced" }
            },
            diabetes_with_cvd: {
                cv_mortality: { rrr: 0.38, nnt: 39, timeframe: 3.1, endpoint: "CV mortality", quality: "hard", source: "EMPA-REG OUTCOME" },
                mace: { rrr: 0.14, nnt: 63, timeframe: 3.1, endpoint: "MACE", quality: "composite", source: "EMPA-REG OUTCOME" }
            },
            ckd: {
                kidney_progression: { rrr: 0.28, nnt: 22, timeframe: 2, endpoint: "40% eGFR decline or ESKD", quality: "hard", source: "EMPA-KIDNEY" }
            }
        },
        harms: {
            // NNH from EMPA-REG: genital infections NNH 22, but these are mild/moderate
            // DKA extremely rare (~0.1%), NNH > 1000
            dka: { nnh: 1000, timeframe: 3, source: "EMPA-REG OUTCOME" }
        },
        burden: "low",
        burdenDetails: "Once daily pill. Common: genital yeast infections (6%), increased urination. No routine monitoring needed.",
        annualCost: 6000,
        monitoring: "Renal function at baseline, periodic monitoring",
        contraindications: ["egfr_below_20", "dialysis", "type1_diabetes"]
    },

    // ===== 3. MRA FOR HEART FAILURE - SPIRONOLACTONE =====
    "spironolactone": {
        id: "spironolactone",
        name: "Spironolactone",
        brandNames: ["Aldactone"],
        class: "Mineralocorticoid Receptor Antagonist (MRA)",
        purpose: "disease_modifying", // Improves HF mortality and alters disease course
        indications: ["heart_failure", "resistant_hypertension"],
        benefits: {
            heart_failure: {
                mortality: { rrr: 0.30, nnt: 6, timeframe: 2, endpoint: "all-cause mortality", quality: "hard", source: "RALES" },
                hospitalization: { rrr: 0.35, nnt: 8, timeframe: 2, endpoint: "HF hospitalization", quality: "hard", source: "RALES" }
            }
        },
        harms: {
            // MRA meta-analysis: hyperkalemia (K>5.5) NNH 12.7
            hyperkalemia_severe: { nnh: 13, timeframe: 2, source: "Meta-analysis 2025" }
        },
        burden: "moderate",
        burdenDetails: "Once daily. Common: gynecomastia in men (10%), breast tenderness. Requires periodic potassium and creatinine monitoring.",
        annualCost: 36,
        monitoring: "Potassium and creatinine at 1 week, 1 month, then every 3-6 months",
        contraindications: ["hyperkalemia", "severe_ckd", "addisons"]
    },

    // ===== 4. STATIN - ATORVASTATIN =====
    "atorvastatin": {
        id: "atorvastatin",
        name: "Atorvastatin",
        brandNames: ["Lipitor"],
        class: "Statin",
        purpose: "preventive", // Prevents CV events
        indications: ["ascvd_prevention", "post_mi", "diabetes_cv_risk"],
        benefits: {
            secondary_prevention: {
                mace: { rrr: 0.25, nnt: 25, timeframe: 5, endpoint: "major CV events", quality: "composite", source: "TNT, PROVE-IT" },
                mortality: { rrr: 0.15, nnt: 50, timeframe: 5, endpoint: "all-cause mortality", quality: "hard", source: "CTT meta-analysis" },
                stroke: { rrr: 0.20, nnt: 83, timeframe: 5, endpoint: "stroke", quality: "hard", source: "CTT meta-analysis" }
            },
            primary_prevention_high_risk: {
                mace: { rrr: 0.25, nnt: 50, timeframe: 5, endpoint: "major CV events", quality: "composite", source: "CTT meta-analysis" },
                mortality: { rrr: 0.10, nnt: 100, timeframe: 5, endpoint: "all-cause mortality", quality: "hard", source: "CTT meta-analysis" }
            }
        },
        harms: {
            // Statin NNH for new-onset diabetes: 255 over 4 years
            new_onset_diabetes: { nnh: 255, timeframe: 4, source: "Meta-analysis" },
            // Rhabdomyolysis extremely rare: NNH > 10,000
            rhabdomyolysis: { nnh: 10000, timeframe: 5, source: "CTT meta-analysis" }
        },
        burden: "low",
        burdenDetails: "Once daily pill. Myalgia reported in 5-10% (mostly nocebo effect per RCTs). Minimal monitoring needed.",
        annualCost: 24,
        monitoring: "Lipid panel at baseline, optional liver function tests",
        contraindications: ["active_liver_disease", "pregnancy"]
    },

    // ===== 5. DOAC - APIXABAN =====
    "apixaban": {
        id: "apixaban",
        name: "Apixaban",
        brandNames: ["Eliquis"],
        class: "Direct Oral Anticoagulant (DOAC)",
        purpose: "preventive", // Prevents stroke in AFib, prevents VTE recurrence
        indications: ["afib_stroke_prevention", "vte_treatment"],
        benefits: {
            afib_stroke_prevention: {
                stroke: { rrr: 0.21, nnt: null, timeframe: 1.8, endpoint: "stroke or systemic embolism", quality: "hard", source: "ARISTOTLE" }
                // NNT depends on CHA2DS2-VASc; use RRR with baseline risk
            }
        },
        harms: {
            // ARISTOTLE: Apixaban REDUCES bleeding vs warfarin (NNT 79 for major bleed prevention)
            // vs placebo: major bleeding ~2%/year
            major_bleeding: { nnh: 50, timeframe: 1, source: "ARISTOTLE (absolute rate)" },
            intracranial_bleeding: { nnh: 333, timeframe: 1, source: "ARISTOTLE" }
        },
        burden: "low",
        burdenDetails: "Twice daily pill, no dietary restrictions, no routine INR monitoring (unlike warfarin).",
        annualCost: 5500,
        monitoring: "Renal function annually",
        contraindications: ["mechanical_valve", "severe_bleeding", "severe_liver_disease"]
    },

    // ===== 6. METFORMIN FOR DIABETES =====
    "metformin": {
        id: "metformin",
        name: "Metformin",
        brandNames: ["Glucophage"],
        class: "Biguanide",
        purpose: "disease_modifying", // Reduces CV mortality in diabetes, modifies disease course
        indications: ["diabetes"],
        benefits: {
            diabetes_cv: {
                mortality: { rrr: 0.36, nnt: 14, timeframe: 10, endpoint: "diabetes-related death", quality: "hard", source: "UKPDS" },
                mi: { rrr: 0.39, nnt: 20, timeframe: 10, endpoint: "MI", quality: "hard", source: "UKPDS" }
            }
        },
        harms: {
            // Lactic acidosis extremely rare: ~3 per 100,000 patient-years
            // No meaningful NNH for serious events
        },
        burden: "moderate",
        burdenDetails: "Usually twice daily. Very common: GI upset (25%) especially when starting - usually resolves. B12 deficiency with long-term use.",
        annualCost: 48,
        monitoring: "Annual B12 if long-term use, renal function",
        contraindications: ["egfr_below_30", "acute_kidney_injury", "metabolic_acidosis"]
    },

    // ===== 7. SULFONYLUREA - GLIPIZIDE =====
    "glipizide": {
        id: "glipizide",
        name: "Glipizide",
        brandNames: ["Glucotrol"],
        class: "Sulfonylurea",
        purpose: "symptomatic", // Lowers glucose but no CV benefit, treats symptom of hyperglycemia
        indications: ["diabetes"],
        benefits: {
            diabetes_glycemic: {
                a1c_reduction: { absolute: 1.0, endpoint: "A1C reduction %", quality: "surrogate" }
            },
            diabetes_cv: {
                // No CV benefit demonstrated
                mortality: { rrr: 0.0, nnt: null, timeframe: 5, endpoint: "CV mortality", quality: "hard" }
            }
        },
        harms: {
            // Sulfonylureas: severe hypoglycemia in 1-2% per year in elderly
            // NNH for severe hypoglycemia varies by age
            severe_hypoglycemia: { nnh: 50, timeframe: 1, source: "Meta-analysis, elderly population" },
            severe_hypoglycemia_elderly: { nnh: 25, timeframe: 1, source: "Beers Criteria, observational data" }
        },
        burden: "moderate",
        burdenDetails: "Once or twice daily. Common: weight gain (3-5 kg), hypoglycemia risk - must eat regular meals.",
        annualCost: 36,
        monitoring: "Blood glucose monitoring, A1C every 3-6 months",
        contraindications: ["type1_diabetes", "dka", "severe_liver_disease"],
        beers_criteria: {
            listed: true,
            concern: "Higher risk of severe, prolonged hypoglycemia in older adults",
            recommendation: "Avoid in older adults; short-acting sulfonylureas like glipizide preferred over long-acting if used",
            strength: "strong",
            quality_of_evidence: "high"
        },
        elderly_caution: {
            hypoglycemia_risk: true,
            avoid_if_frail: true,
            avoid_if_cognitive_impairment: true,
            prefer_alternatives: ["metformin", "SGLT2i", "GLP1a"]
        }
    },

    // ===== 8. ASPIRIN FOR PRIMARY PREVENTION =====
    "aspirin": {
        id: "aspirin",
        name: "Aspirin",
        brandNames: ["Bayer", "Ecotrin"],
        class: "Antiplatelet",
        purpose: "preventive", // Prevents CV events
        indications: ["secondary_cv_prevention", "primary_cv_prevention"],
        benefits: {
            secondary_prevention: {
                mace: { rrr: 0.20, nnt: 50, timeframe: 2, endpoint: "major CV events", quality: "composite", source: "ATT meta-analysis" },
                stroke_recurrence: { rrr: 0.22, nnt: 77, timeframe: 2, endpoint: "recurrent stroke", quality: "hard", source: "ATT meta-analysis" }
            },
            primary_prevention: {
                mace: { rrr: 0.11, nnt: 250, timeframe: 5, endpoint: "major CV events", quality: "composite", source: "ASPREE, ARRIVE" },
                mortality: { rrr: 0.0, nnt: null, timeframe: 5, endpoint: "all-cause mortality", quality: "hard" }
            }
        },
        harms: {
            // Primary prevention: NNH 222 for major bleeding
            major_bleeding: { nnh: 222, timeframe: 5, source: "JAMA meta-analysis 2019" },
            intracranial_bleeding: { nnh: 1000, timeframe: 5, source: "JAMA meta-analysis" },
            // Age-dependent GI bleeding: NNH 202 in age 75-84
            gi_bleeding: { nnh: 400, timeframe: 1, source: "USPSTF analysis, age-adjusted" }
        },
        burden: "low",
        burdenDetails: "Once daily, no monitoring needed. May cause mild GI upset.",
        annualCost: 15,
        monitoring: "None routine, watch for bleeding symptoms",
        contraindications: ["active_bleeding", "severe_liver_disease", "aspirin_allergy"]
    },

    // ===== 9. ARNI - SACUBITRIL/VALSARTAN =====
    "sacubitril_valsartan": {
        id: "sacubitril_valsartan",
        name: "Sacubitril/Valsartan",
        brandNames: ["Entresto"],
        class: "Angiotensin Receptor-Neprilysin Inhibitor (ARNI)",
        purpose: "disease_modifying", // Improves HF survival and alters disease course
        indications: ["heart_failure"],
        benefits: {
            heart_failure: {
                cv_death_hf_hosp: { rrr: 0.20, nnt: 21, timeframe: 2.3, endpoint: "CV death or HF hospitalization", quality: "hard", source: "PARADIGM-HF" },
                mortality: { rrr: 0.16, nnt: 36, timeframe: 2.3, endpoint: "all-cause mortality", quality: "hard", source: "PARADIGM-HF" }
            }
        },
        harms: {
            // PARADIGM-HF: hypotension more common but rarely serious
            // Angioedema rare: 0.45% vs 0.24% with enalapril - NNH ~500
            angioedema: { nnh: 500, timeframe: 2.3, source: "PARADIGM-HF" }
        },
        burden: "moderate",
        burdenDetails: "Twice daily. Common: hypotension (14%), dizziness. Must stop ACEi 36h before starting. Requires titration.",
        annualCost: 6500,
        monitoring: "Blood pressure, potassium, creatinine during titration",
        contraindications: ["angioedema_history", "concurrent_acei", "pregnancy", "severe_liver_disease"]
    },

    // ===== 10. WARFARIN =====
    "warfarin": {
        id: "warfarin",
        name: "Warfarin",
        brandNames: ["Coumadin", "Jantoven"],
        class: "Vitamin K Antagonist",
        purpose: "preventive", // Prevents stroke and thromboembolism
        indications: ["afib_stroke_prevention", "mechanical_valve", "vte_treatment"],
        benefits: {
            afib_stroke_prevention: {
                stroke: { rrr: 0.64, nnt: null, timeframe: 1, endpoint: "stroke or systemic embolism", quality: "hard", source: "Meta-analysis" }
            },
            mechanical_valve: {
                thromboembolism: { rrr: 0.75, nnt: 10, timeframe: 1, endpoint: "valve thrombosis/embolism", quality: "hard" }
            }
        },
        harms: {
            // Warfarin: major bleeding 3%/year, ICH 0.5-0.8%/year
            major_bleeding: { nnh: 33, timeframe: 1, source: "SPAF studies" },
            intracranial_bleeding: { nnh: 125, timeframe: 1, source: "SPAF, RE-LY comparator" }
        },
        burden: "high",
        burdenDetails: "Requires frequent INR monitoring (weekly then monthly), dietary restrictions (vitamin K), many drug interactions.",
        annualCost: 60,
        monitoring: "INR weekly initially, then monthly when stable; target TTR >65%",
        contraindications: ["active_bleeding", "pregnancy", "severe_liver_disease", "noncompliance"]
    },

    // ===== 11. ACE INHIBITOR - LISINOPRIL =====
    "lisinopril": {
        id: "lisinopril",
        name: "Lisinopril",
        brandNames: ["Zestril", "Prinivil"],
        class: "ACE Inhibitor",
        purpose: "disease_modifying", // Modifies HF, nephropathy, and HTN disease course
        indications: ["heart_failure", "hypertension", "post_mi", "diabetic_nephropathy"],
        benefits: {
            heart_failure: {
                mortality: { rrr: 0.16, nnt: 22, timeframe: 3.5, endpoint: "all-cause mortality", quality: "hard", source: "SOLVD" },
                hospitalization: { rrr: 0.26, nnt: 15, timeframe: 3.5, endpoint: "HF hospitalization", quality: "hard", source: "SOLVD" }
            },
            post_mi: {
                mortality: { rrr: 0.12, nnt: 50, timeframe: 1, endpoint: "all-cause mortality", quality: "hard", source: "GISSI-3" }
            },
            hypertension: {
                stroke: { rrr: 0.30, nnt: 67, timeframe: 5, endpoint: "stroke", quality: "hard", source: "Meta-analysis" }
            }
        },
        harms: {
            // ACEi angioedema: NNH ~500 (ONTARGET)
            angioedema: { nnh: 500, timeframe: 5, source: "ONTARGET" },
            // Hyperkalemia requiring hospitalization: uncommon
            hyperkalemia_severe: { nnh: 100, timeframe: 1, source: "Clinical estimates" }
        },
        burden: "low",
        burdenDetails: "Once daily. Common: dry cough (10%), dizziness. Initial monitoring of potassium and creatinine.",
        annualCost: 24,
        monitoring: "Potassium, creatinine at baseline, 1-2 weeks after starting",
        contraindications: ["angioedema_history", "bilateral_renal_artery_stenosis", "pregnancy"]
    },

    // ===== 12. ACE INHIBITOR - ENALAPRIL =====
    "enalapril": {
        id: "enalapril",
        name: "Enalapril",
        brandNames: ["Vasotec"],
        class: "ACE Inhibitor",
        purpose: "disease_modifying", // Modifies HF disease course
        indications: ["heart_failure", "hypertension", "post_mi"],
        benefits: {
            heart_failure: {
                mortality: { rrr: 0.16, nnt: 22, timeframe: 3.5, endpoint: "all-cause mortality", quality: "hard", source: "SOLVD" },
                hospitalization: { rrr: 0.26, nnt: 15, timeframe: 3.5, endpoint: "HF hospitalization", quality: "hard", source: "SOLVD" }
            },
            heart_failure_severe: {
                mortality: { rrr: 0.40, nnt: 6, timeframe: 0.5, endpoint: "all-cause mortality", quality: "hard", source: "CONSENSUS" }
            }
        },
        harms: {
            angioedema: { nnh: 500, timeframe: 5, source: "ONTARGET" },
            hyperkalemia_severe: { nnh: 100, timeframe: 1, source: "Clinical estimates" }
        },
        burden: "moderate",
        burdenDetails: "Twice daily dosing. Common: dry cough (10%), hypotension (5%).",
        annualCost: 36,
        monitoring: "Potassium, creatinine at baseline, 1-2 weeks after starting",
        contraindications: ["angioedema_history", "bilateral_renal_artery_stenosis", "pregnancy"]
    },

    // ===== 13. ARB - LOSARTAN =====
    "losartan": {
        id: "losartan",
        name: "Losartan",
        brandNames: ["Cozaar"],
        class: "Angiotensin Receptor Blocker (ARB)",
        purpose: "disease_modifying", // Modifies nephropathy and HTN disease course
        indications: ["hypertension", "diabetic_nephropathy", "heart_failure"],
        benefits: {
            hypertension: {
                stroke: { rrr: 0.25, nnt: 67, timeframe: 5, endpoint: "stroke", quality: "hard", source: "LIFE" }
            },
            diabetic_nephropathy: {
                esrd: { rrr: 0.28, nnt: 13, timeframe: 3.4, endpoint: "ESRD", quality: "hard", source: "RENAAL" },
                doubling_creatinine: { rrr: 0.25, nnt: 11, timeframe: 3.4, endpoint: "doubling of creatinine", quality: "hard", source: "RENAAL" }
            }
        },
        harms: {
            // ARBs have lower angioedema risk than ACEi
            angioedema: { nnh: 2000, timeframe: 5, source: "Meta-analysis" },
            hyperkalemia_severe: { nnh: 100, timeframe: 1, source: "Clinical estimates" }
        },
        burden: "low",
        burdenDetails: "Once or twice daily. Well tolerated - no cough (unlike ACEi).",
        annualCost: 24,
        monitoring: "Potassium, creatinine periodically",
        contraindications: ["pregnancy", "bilateral_renal_artery_stenosis"]
    },

    // ===== 14. ARB - VALSARTAN =====
    "valsartan": {
        id: "valsartan",
        name: "Valsartan",
        brandNames: ["Diovan"],
        class: "Angiotensin Receptor Blocker (ARB)",
        purpose: "disease_modifying", // Modifies HF disease course
        indications: ["hypertension", "heart_failure", "post_mi"],
        benefits: {
            heart_failure: {
                mortality: { rrr: 0.13, nnt: 30, timeframe: 2, endpoint: "all-cause mortality", quality: "hard", source: "Val-HeFT" },
                hospitalization: { rrr: 0.24, nnt: 15, timeframe: 2, endpoint: "HF hospitalization", quality: "hard", source: "Val-HeFT" }
            },
            post_mi: {
                mortality: { rrr: 0.13, nnt: 45, timeframe: 2.1, endpoint: "all-cause mortality", quality: "hard", source: "VALIANT" }
            }
        },
        harms: {
            angioedema: { nnh: 2000, timeframe: 5, source: "Meta-analysis" },
            hyperkalemia_severe: { nnh: 100, timeframe: 1, source: "Clinical estimates" }
        },
        burden: "low",
        burdenDetails: "Once or twice daily. Well tolerated.",
        annualCost: 36,
        monitoring: "Potassium, creatinine periodically",
        contraindications: ["pregnancy", "bilateral_renal_artery_stenosis"]
    },

    // ===== 15. BETA-BLOCKER - METOPROLOL SUCCINATE =====
    "metoprolol": {
        id: "metoprolol",
        name: "Metoprolol Succinate",
        brandNames: ["Toprol-XL"],
        class: "Beta-blocker",
        purpose: "disease_modifying", // Improves HF survival and alters disease course
        indications: ["heart_failure", "hypertension", "post_mi"],
        benefits: {
            heart_failure: {
                mortality: { rrr: 0.34, nnt: 27, timeframe: 1, endpoint: "all-cause mortality", quality: "hard", source: "MERIT-HF" },
                hospitalization: { rrr: 0.18, nnt: 19, timeframe: 1, endpoint: "HF hospitalization", quality: "hard", source: "MERIT-HF" }
            },
            post_mi: {
                mortality: { rrr: 0.20, nnt: 50, timeframe: 2, endpoint: "all-cause mortality", quality: "hard", source: "MIAMI" }
            }
        },
        harms: {
            // Beta-blockers in HF trials: no robust NNH for serious events
        },
        burden: "low",
        burdenDetails: "Once daily (extended release). Common: fatigue (12%), bradycardia. Requires uptitration.",
        annualCost: 48,
        monitoring: "Heart rate and blood pressure during uptitration",
        contraindications: ["severe_bradycardia", "heart_block", "decompensated_hf", "severe_asthma"]
    },

    // ===== 16. BETA-BLOCKER - BISOPROLOL =====
    "bisoprolol": {
        id: "bisoprolol",
        name: "Bisoprolol",
        brandNames: ["Zebeta"],
        class: "Beta-blocker",
        purpose: "disease_modifying", // Improves HF survival
        indications: ["heart_failure", "hypertension"],
        benefits: {
            heart_failure: {
                mortality: { rrr: 0.34, nnt: 23, timeframe: 1.3, endpoint: "all-cause mortality", quality: "hard", source: "CIBIS-II" },
                hospitalization: { rrr: 0.20, nnt: 18, timeframe: 1.3, endpoint: "HF hospitalization", quality: "hard", source: "CIBIS-II" }
            }
        },
        harms: {
            // No robust NNH data - benefits vastly outweigh
        },
        burden: "low",
        burdenDetails: "Once daily. Common: fatigue (10%), bradycardia. More beta-1 selective - may be better in COPD.",
        annualCost: 36,
        monitoring: "Heart rate and blood pressure",
        contraindications: ["severe_bradycardia", "heart_block", "decompensated_hf"]
    },

    // ===== 17. DOAC - RIVAROXABAN =====
    "rivaroxaban": {
        id: "rivaroxaban",
        name: "Rivaroxaban",
        brandNames: ["Xarelto"],
        class: "Direct Oral Anticoagulant (DOAC)",
        purpose: "preventive", // Prevents stroke and VTE
        indications: ["afib_stroke_prevention", "vte_treatment", "secondary_prevention"],
        benefits: {
            afib_stroke_prevention: {
                stroke: { rrr: 0.21, nnt: null, timeframe: 1.9, endpoint: "stroke or systemic embolism", quality: "hard", source: "ROCKET-AF" }
            },
            secondary_prevention: {
                mace: { rrr: 0.24, nnt: 63, timeframe: 2, endpoint: "CV death, MI, stroke", quality: "composite", source: "COMPASS" }
            }
        },
        harms: {
            // ROCKET-AF: GI bleeding higher, NNH ~99 vs warfarin
            major_bleeding: { nnh: 50, timeframe: 1, source: "ROCKET-AF (absolute rate)" },
            gi_bleeding: { nnh: 99, timeframe: 1.9, source: "ROCKET-AF vs warfarin" },
            intracranial_bleeding: { nnh: 305, timeframe: 1.9, source: "ROCKET-AF" }
        },
        burden: "low",
        burdenDetails: "Once daily with food (for AF). No routine INR monitoring.",
        annualCost: 5500,
        monitoring: "Renal function annually",
        contraindications: ["mechanical_valve", "active_bleeding", "severe_liver_disease"]
    },

    // ===== 18. DOAC - DABIGATRAN =====
    "dabigatran": {
        id: "dabigatran",
        name: "Dabigatran",
        brandNames: ["Pradaxa"],
        class: "Direct Oral Anticoagulant (DOAC)",
        purpose: "preventive", // Prevents stroke and VTE
        indications: ["afib_stroke_prevention", "vte_treatment"],
        benefits: {
            afib_stroke_prevention: {
                stroke: { rrr: 0.34, nnt: null, timeframe: 2, endpoint: "stroke or systemic embolism", quality: "hard", source: "RE-LY (150mg)" }
            }
        },
        harms: {
            // RE-LY 150mg: GI bleeding higher, NNH ~67
            major_bleeding: { nnh: 50, timeframe: 1, source: "RE-LY (absolute rate)" },
            gi_bleeding: { nnh: 67, timeframe: 2, source: "RE-LY vs warfarin" },
            intracranial_bleeding: { nnh: 222, timeframe: 2, source: "RE-LY" }
        },
        burden: "low",
        burdenDetails: "Twice daily. Common: dyspepsia (10%). Has reversal agent (idarucizumab).",
        annualCost: 5000,
        monitoring: "Renal function annually",
        contraindications: ["mechanical_valve", "active_bleeding", "severe_ckd"]
    },

    // ===== 19. DOAC - EDOXABAN =====
    "edoxaban": {
        id: "edoxaban",
        name: "Edoxaban",
        brandNames: ["Savaysa"],
        class: "Direct Oral Anticoagulant (DOAC)",
        purpose: "preventive", // Prevents stroke and VTE
        indications: ["afib_stroke_prevention", "vte_treatment"],
        benefits: {
            afib_stroke_prevention: {
                stroke: { rrr: 0.21, nnt: null, timeframe: 2.8, endpoint: "stroke or systemic embolism", quality: "hard", source: "ENGAGE AF-TIMI 48" }
            }
        },
        harms: {
            // ENGAGE: lowest bleeding of DOACs
            major_bleeding: { nnh: 50, timeframe: 1, source: "ENGAGE (absolute rate)" },
            intracranial_bleeding: { nnh: 500, timeframe: 2.8, source: "ENGAGE AF-TIMI 48" }
        },
        burden: "low",
        burdenDetails: "Once daily. Well tolerated.",
        annualCost: 4500,
        monitoring: "Renal function annually",
        contraindications: ["mechanical_valve", "active_bleeding", "high_creatinine_clearance"]
    },

    // ===== 20. SGLT2 INHIBITOR - DAPAGLIFLOZIN =====
    "dapagliflozin": {
        id: "dapagliflozin",
        name: "Dapagliflozin",
        brandNames: ["Farxiga"],
        class: "SGLT2 Inhibitor",
        purpose: "disease_modifying", // Modifies HF, CKD, and diabetes disease progression
        indications: ["heart_failure", "diabetes", "ckd"],
        benefits: {
            heart_failure: {
                cv_death_hf_hosp: { rrr: 0.26, nnt: 17, timeframe: 1.5, endpoint: "CV death or HF hospitalization", quality: "hard", source: "DAPA-HF" },
                mortality: { rrr: 0.17, nnt: 45, timeframe: 1.5, endpoint: "all-cause mortality", quality: "hard", source: "DAPA-HF" }
            },
            ckd: {
                kidney_progression: { rrr: 0.39, nnt: 14, timeframe: 2.4, endpoint: "sustained eGFR decline, ESKD", quality: "hard", source: "DAPA-CKD" }
            }
        },
        harms: {
            dka: { nnh: 1000, timeframe: 2, source: "DAPA-HF, DAPA-CKD" }
        },
        burden: "low",
        burdenDetails: "Once daily. Common: genital infections (5%), increased urination. No routine monitoring.",
        annualCost: 6000,
        monitoring: "Renal function periodically",
        contraindications: ["dialysis", "type1_diabetes"]
    },

    // ===== 21. GLP-1 AGONIST - LIRAGLUTIDE =====
    "liraglutide": {
        id: "liraglutide",
        name: "Liraglutide",
        brandNames: ["Victoza", "Saxenda"],
        class: "GLP-1 Receptor Agonist",
        purpose: "disease_modifying", // Reduces CV mortality in diabetes
        indications: ["diabetes"],
        benefits: {
            diabetes_cv: {
                mace: { rrr: 0.13, nnt: 53, timeframe: 3.8, endpoint: "MACE", quality: "composite", source: "LEADER" },
                cv_mortality: { rrr: 0.22, nnt: 67, timeframe: 3.8, endpoint: "CV mortality", quality: "hard", source: "LEADER" },
                mortality: { rrr: 0.15, nnt: 67, timeframe: 3.8, endpoint: "all-cause mortality", quality: "hard", source: "LEADER" }
            }
        },
        harms: {
            // LEADER: no increased pancreatitis (0.4% vs 0.5% placebo)
            pancreatitis: { nnh: 1000, timeframe: 3.8, source: "LEADER (no significant increase)" }
        },
        burden: "moderate",
        burdenDetails: "Daily subcutaneous injection. Very common: nausea (20%), vomiting (8%), diarrhea (10%) - usually improves. Requires dose titration.",
        annualCost: 9000,
        monitoring: "A1C, weight",
        contraindications: ["medullary_thyroid_cancer", "men2_syndrome", "pancreatitis_history"]
    },

    // ===== 22. GLP-1 AGONIST - SEMAGLUTIDE =====
    "semaglutide": {
        id: "semaglutide",
        name: "Semaglutide",
        brandNames: ["Ozempic", "Wegovy", "Rybelsus"],
        class: "GLP-1 Receptor Agonist",
        purpose: "disease_modifying", // Reduces CV events and modifies diabetes/obesity
        indications: ["diabetes", "obesity"],
        benefits: {
            diabetes_cv: {
                mace: { rrr: 0.26, nnt: 46, timeframe: 2.1, endpoint: "MACE", quality: "composite", source: "SUSTAIN-6" },
                stroke: { rrr: 0.39, nnt: 100, timeframe: 2.1, endpoint: "stroke", quality: "hard", source: "SUSTAIN-6" }
            }
        },
        harms: {
            pancreatitis: { nnh: 1000, timeframe: 2, source: "SUSTAIN-6 (no significant increase)" }
        },
        burden: "moderate",
        burdenDetails: "Weekly injection or daily oral. Very common: nausea (22%), vomiting (10%), diarrhea (12%) - usually improves with time.",
        annualCost: 10000,
        monitoring: "A1C, weight",
        contraindications: ["medullary_thyroid_cancer", "men2_syndrome", "pancreatitis_history"]
    },

    // ===== 23. DPP-4 INHIBITOR - SITAGLIPTIN =====
    "sitagliptin": {
        id: "sitagliptin",
        name: "Sitagliptin",
        brandNames: ["Januvia"],
        class: "DPP-4 Inhibitor",
        purpose: "symptomatic", // Lowers glucose but CV neutral, treats symptom of hyperglycemia
        indications: ["diabetes"],
        benefits: {
            diabetes_glycemic: {
                a1c_reduction: { absolute: 0.7, endpoint: "A1C reduction %", quality: "surrogate" }
            },
            diabetes_cv: {
                // TECOS: CV neutral
                mace: { rrr: 0.0, nnt: null, timeframe: 3, endpoint: "MACE", quality: "composite", source: "TECOS" }
            }
        },
        harms: {
            // TECOS: no increased pancreatitis
            pancreatitis: { nnh: 1000, timeframe: 3, source: "TECOS" }
        },
        burden: "low",
        burdenDetails: "Once daily pill. Well tolerated, weight neutral, low hypoglycemia risk.",
        annualCost: 5000,
        monitoring: "A1C, renal function for dose adjustment",
        contraindications: ["pancreatitis_history"]
    },

    // ===== 24. MRA - EPLERENONE =====
    "eplerenone": {
        id: "eplerenone",
        name: "Eplerenone",
        brandNames: ["Inspra"],
        class: "Mineralocorticoid Receptor Antagonist (MRA)",
        purpose: "disease_modifying", // Improves HF survival
        indications: ["heart_failure", "post_mi"],
        benefits: {
            heart_failure: {
                cv_death_hf_hosp: { rrr: 0.24, nnt: 19, timeframe: 1.8, endpoint: "CV death or HF hospitalization", quality: "hard", source: "EMPHASIS-HF" },
                mortality: { rrr: 0.24, nnt: 50, timeframe: 1.8, endpoint: "all-cause mortality", quality: "hard", source: "EMPHASIS-HF" }
            },
            post_mi_with_lv_dysfunction: {
                mortality: { rrr: 0.15, nnt: 43, timeframe: 1.3, endpoint: "all-cause mortality", quality: "hard", source: "EPHESUS" }
            }
        },
        harms: {
            // EMPHASIS-HF: hyperkalemia K>=6.0 NNH ~167
            hyperkalemia_severe: { nnh: 167, timeframe: 1.8, source: "EMPHASIS-HF" }
        },
        burden: "moderate",
        burdenDetails: "Once daily. No gynecomastia (unlike spironolactone). Requires potassium monitoring.",
        annualCost: 200,
        monitoring: "Potassium at 1 week, 1 month, then every 3 months",
        contraindications: ["hyperkalemia", "severe_ckd"]
    },

    // ===== 25. DIGOXIN =====
    "digoxin": {
        id: "digoxin",
        name: "Digoxin",
        brandNames: ["Lanoxin"],
        class: "Cardiac Glycoside",
        purpose: "symptomatic", // Reduces hospitalizations but no mortality benefit
        indications: ["heart_failure", "afib_rate_control"],
        benefits: {
            heart_failure: {
                hospitalization: { rrr: 0.28, nnt: 13, timeframe: 3, endpoint: "HF hospitalization", quality: "hard", source: "DIG" },
                // No mortality benefit
                mortality: { rrr: 0.0, nnt: null, timeframe: 3, endpoint: "all-cause mortality", quality: "hard", source: "DIG" }
            }
        },
        harms: {
            // Digoxin toxicity: NNH ~50 in elderly
            // Narrow therapeutic window
            toxicity: { nnh: 50, timeframe: 2, source: "DIG trial, observational data" },
            arrhythmia: { nnh: 100, timeframe: 2, source: "DIG trial" }
        },
        burden: "moderate",
        burdenDetails: "Once daily. Requires level monitoring (target 0.5-0.9 ng/mL). Narrow therapeutic window - toxicity risk.",
        annualCost: 48,
        monitoring: "Digoxin level, renal function, potassium",
        contraindications: ["av_block", "ventricular_arrhythmia", "hypertrophic_cardiomyopathy"],
        beers_criteria: {
            listed: true,
            concern: "Use in HF may be associated with increased mortality. In AFib, may not add benefit beyond rate control agents. Increased toxicity risk with reduced renal function.",
            recommendation: "Avoid as first-line therapy for AFib and HF; if used, maintain serum level <1.0 ng/mL",
            strength: "strong",
            quality_of_evidence: "moderate"
        },
        elderly_caution: {
            toxicity_risk: true,
            requires_renal_adjustment: true,
            narrow_therapeutic_window: true,
            avoid_if_frail: true,
            monitor_levels: true
        }
    },

    // ===== 26. CALCIUM CHANNEL BLOCKER - AMLODIPINE =====
    "amlodipine": {
        id: "amlodipine",
        name: "Amlodipine",
        brandNames: ["Norvasc"],
        class: "Calcium Channel Blocker",
        purpose: "preventive", // Prevents stroke and CV events via BP control
        indications: ["hypertension", "angina"],
        benefits: {
            hypertension: {
                stroke: { rrr: 0.35, nnt: 67, timeframe: 5, endpoint: "stroke", quality: "hard", source: "ALLHAT" },
                mi: { rrr: 0.15, nnt: 125, timeframe: 5, endpoint: "MI", quality: "hard", source: "ALLHAT" }
            }
        },
        harms: {
            // No serious harms with NNH - edema is mild/moderate
        },
        burden: "low",
        burdenDetails: "Once daily. Common: peripheral edema (15%), headache (8%), flushing (5%).",
        annualCost: 24,
        monitoring: "Blood pressure",
        contraindications: ["severe_hypotension", "severe_aortic_stenosis"]
    },

    // ===== 27. THIAZIDE DIURETIC - HYDROCHLOROTHIAZIDE =====
    "hydrochlorothiazide": {
        id: "hydrochlorothiazide",
        name: "Hydrochlorothiazide",
        brandNames: ["Microzide"],
        class: "Thiazide Diuretic",
        purpose: "preventive", // Prevents stroke and CV events via BP control
        indications: ["hypertension"],
        benefits: {
            hypertension: {
                stroke: { rrr: 0.29, nnt: 50, timeframe: 5, endpoint: "stroke", quality: "hard", source: "ALLHAT" },
                mortality: { rrr: 0.10, nnt: 100, timeframe: 5, endpoint: "all-cause mortality", quality: "hard", source: "Meta-analysis" }
            }
        },
        harms: {
            // Electrolyte disturbances - usually mild
            // No robust NNH for serious events
        },
        burden: "low",
        burdenDetails: "Once daily. Common: increased urination, may cause hypokalemia, hyponatremia. Periodic electrolyte monitoring.",
        annualCost: 24,
        monitoring: "Electrolytes (K, Na), creatinine periodically",
        contraindications: ["anuria", "severe_hypokalemia"]
    },

    // ===== 28. LOOP DIURETIC - FUROSEMIDE =====
    "furosemide": {
        id: "furosemide",
        name: "Furosemide",
        brandNames: ["Lasix"],
        class: "Loop Diuretic",
        purpose: "symptomatic", // Relieves congestion symptoms, no mortality benefit
        indications: ["heart_failure", "edema"],
        benefits: {
            heart_failure_symptoms: {
                // Symptom relief, no mortality benefit
                congestion_relief: { absolute: 0.90, endpoint: "symptom improvement", quality: "surrogate" }
            }
        },
        harms: {
            // Electrolyte disturbances common but usually manageable
        },
        burden: "moderate",
        burdenDetails: "One to three times daily. Frequent urination. Common: electrolyte disturbances. Requires electrolyte monitoring.",
        annualCost: 24,
        monitoring: "Electrolytes, creatinine, weight",
        contraindications: ["anuria", "severe_hypokalemia"]
    },

    // ===== 29. ANTIPLATELET - CLOPIDOGREL =====
    "clopidogrel": {
        id: "clopidogrel",
        name: "Clopidogrel",
        brandNames: ["Plavix"],
        class: "Antiplatelet (P2Y12 Inhibitor)",
        purpose: "preventive", // Prevents recurrent CV events
        indications: ["acs", "post_pci", "stroke_secondary_prevention"],
        benefits: {
            acs: {
                mace: { rrr: 0.20, nnt: 46, timeframe: 1, endpoint: "CV death, MI, stroke", quality: "composite", source: "CURE" }
            },
            stroke_secondary_prevention: {
                stroke_recurrence: { rrr: 0.08, nnt: 91, timeframe: 2, endpoint: "recurrent stroke", quality: "hard", source: "CAPRIE" }
            }
        },
        harms: {
            major_bleeding: { nnh: 100, timeframe: 1, source: "CURE" }
        },
        burden: "low",
        burdenDetails: "Once daily. No routine monitoring. May cause mild GI upset.",
        annualCost: 24,
        monitoring: "Watch for bleeding symptoms",
        contraindications: ["active_bleeding", "severe_liver_disease"]
    },

    // ===== 30. STATIN - ROSUVASTATIN =====
    "rosuvastatin": {
        id: "rosuvastatin",
        name: "Rosuvastatin",
        brandNames: ["Crestor"],
        class: "Statin",
        purpose: "preventive", // Prevents CV events
        indications: ["ascvd_prevention", "hyperlipidemia"],
        benefits: {
            secondary_prevention: {
                mace: { rrr: 0.25, nnt: 25, timeframe: 5, endpoint: "major CV events", quality: "composite", source: "CTT meta-analysis" },
                mortality: { rrr: 0.15, nnt: 50, timeframe: 5, endpoint: "all-cause mortality", quality: "hard", source: "CTT meta-analysis" }
            },
            primary_prevention_high_risk: {
                mace: { rrr: 0.44, nnt: 25, timeframe: 5, endpoint: "major CV events", quality: "composite", source: "JUPITER" }
            }
        },
        harms: {
            new_onset_diabetes: { nnh: 255, timeframe: 4, source: "Meta-analysis" },
            rhabdomyolysis: { nnh: 10000, timeframe: 5, source: "CTT meta-analysis" }
        },
        burden: "low",
        burdenDetails: "Once daily. Most potent statin for LDL lowering. Myalgia in 5-8% (mostly nocebo).",
        annualCost: 36,
        monitoring: "Lipid panel periodically",
        contraindications: ["active_liver_disease", "pregnancy"]
    },

    // ===== 31. STATIN - SIMVASTATIN =====
    "simvastatin": {
        id: "simvastatin",
        name: "Simvastatin",
        brandNames: ["Zocor"],
        class: "Statin",
        purpose: "preventive", // Prevents CV events
        indications: ["ascvd_prevention", "hyperlipidemia"],
        benefits: {
            secondary_prevention: {
                mace: { rrr: 0.24, nnt: 30, timeframe: 5, endpoint: "major CV events", quality: "composite", source: "4S" },
                mortality: { rrr: 0.30, nnt: 30, timeframe: 5, endpoint: "all-cause mortality", quality: "hard", source: "4S" }
            }
        },
        harms: {
            new_onset_diabetes: { nnh: 255, timeframe: 4, source: "Meta-analysis" },
            rhabdomyolysis: { nnh: 10000, timeframe: 5, source: "CTT meta-analysis" }
        },
        burden: "low",
        burdenDetails: "Once daily (evening). Older statin, many drug interactions. 80mg dose increases myopathy risk.",
        annualCost: 24,
        monitoring: "Lipid panel periodically",
        contraindications: ["active_liver_disease", "pregnancy", "strong_cyp3a4_inhibitors"]
    },

    // ===== 32. EZETIMIBE =====
    "ezetimibe": {
        id: "ezetimibe",
        name: "Ezetimibe",
        brandNames: ["Zetia"],
        class: "Cholesterol Absorption Inhibitor",
        purpose: "preventive", // Prevents CV events (add-on to statin)
        indications: ["hyperlipidemia", "ascvd_prevention"],
        benefits: {
            secondary_prevention_addon: {
                mace: { rrr: 0.065, nnt: 50, timeframe: 7, endpoint: "CV death, MI, stroke", quality: "composite", source: "IMPROVE-IT" }
            }
        },
        harms: {
            // Very well tolerated, no significant harms
        },
        burden: "low",
        burdenDetails: "Once daily. Very well tolerated. Usually added to statin.",
        annualCost: 24,
        monitoring: "Lipid panel",
        contraindications: ["severe_liver_disease"]
    },

    // ===== 33. BISPHOSPHONATE - ALENDRONATE =====
    "alendronate": {
        id: "alendronate",
        name: "Alendronate",
        brandNames: ["Fosamax"],
        class: "Bisphosphonate",
        purpose: "preventive", // Prevents fractures
        indications: ["osteoporosis"],
        benefits: {
            osteoporosis: {
                hip_fracture: { rrr: 0.40, nnt: 91, timeframe: 3, endpoint: "hip fracture", quality: "hard", source: "FIT" },
                vertebral_fracture: { rrr: 0.47, nnt: 14, timeframe: 3, endpoint: "vertebral fracture", quality: "hard", source: "FIT" },
                nonvertebral_fracture: { rrr: 0.20, nnt: 50, timeframe: 3, endpoint: "non-vertebral fracture", quality: "hard", source: "FIT" }
            }
        },
        harms: {
            atypical_femur_fracture: { nnh: 1000, timeframe: 5, source: "Meta-analysis" },
            osteonecrosis_jaw: { nnh: 10000, timeframe: 5, source: "FDA data" }
        },
        burden: "moderate",
        burdenDetails: "Once weekly. MUST take fasting with full glass of water, stay upright 30 min. Common: GI upset, esophageal irritation.",
        annualCost: 48,
        monitoring: "Bone density every 2 years, dental exam",
        contraindications: ["esophageal_disorders", "inability_to_sit_upright", "hypocalcemia", "severe_ckd"]
    },

    // ===== 34. BISPHOSPHONATE - RISEDRONATE =====
    "risedronate": {
        id: "risedronate",
        name: "Risedronate",
        brandNames: ["Actonel", "Atelvia"],
        class: "Bisphosphonate",
        purpose: "preventive", // Prevents fractures
        indications: ["osteoporosis"],
        benefits: {
            osteoporosis: {
                hip_fracture: { rrr: 0.26, nnt: 77, timeframe: 3, endpoint: "hip fracture", quality: "hard", source: "HIP study" },
                vertebral_fracture: { rrr: 0.41, nnt: 20, timeframe: 3, endpoint: "vertebral fracture", quality: "hard", source: "VERT" }
            }
        },
        harms: {
            atypical_femur_fracture: { nnh: 1000, timeframe: 5, source: "Meta-analysis" },
            osteonecrosis_jaw: { nnh: 10000, timeframe: 5, source: "FDA data" }
        },
        burden: "moderate",
        burdenDetails: "Weekly or monthly. Same administration requirements as alendronate. May have less GI irritation.",
        annualCost: 200,
        monitoring: "Bone density every 2 years",
        contraindications: ["esophageal_disorders", "inability_to_sit_upright", "hypocalcemia", "severe_ckd"]
    },

    // ===== 35. IV BISPHOSPHONATE - ZOLEDRONIC ACID =====
    "zoledronic_acid": {
        id: "zoledronic_acid",
        name: "Zoledronic Acid",
        brandNames: ["Reclast", "Zometa"],
        class: "IV Bisphosphonate",
        purpose: "preventive", // Prevents fractures, also mortality benefit
        indications: ["osteoporosis"],
        benefits: {
            osteoporosis: {
                hip_fracture: { rrr: 0.41, nnt: 91, timeframe: 3, endpoint: "hip fracture", quality: "hard", source: "HORIZON" },
                vertebral_fracture: { rrr: 0.70, nnt: 14, timeframe: 3, endpoint: "vertebral fracture", quality: "hard", source: "HORIZON" },
                mortality: { rrr: 0.28, nnt: 28, timeframe: 2.8, endpoint: "all-cause mortality", quality: "hard", source: "HORIZON-RFT" }
            }
        },
        harms: {
            atypical_femur_fracture: { nnh: 1000, timeframe: 5, source: "Meta-analysis" },
            osteonecrosis_jaw: { nnh: 10000, timeframe: 5, source: "FDA data" }
        },
        burden: "low",
        burdenDetails: "Once yearly IV infusion. Common: flu-like symptoms after first dose (30%). No daily pill burden.",
        annualCost: 800,
        monitoring: "Bone density every 2 years, calcium/vitamin D levels, dental exam",
        contraindications: ["egfr_below_35", "hypocalcemia"]
    },

    // ===== 36. DENOSUMAB =====
    "denosumab": {
        id: "denosumab",
        name: "Denosumab",
        brandNames: ["Prolia"],
        class: "RANK Ligand Inhibitor",
        purpose: "preventive", // Prevents fractures
        indications: ["osteoporosis"],
        benefits: {
            osteoporosis: {
                hip_fracture: { rrr: 0.40, nnt: 200, timeframe: 3, endpoint: "hip fracture", quality: "hard", source: "FREEDOM" },
                vertebral_fracture: { rrr: 0.68, nnt: 21, timeframe: 3, endpoint: "vertebral fracture", quality: "hard", source: "FREEDOM" },
                nonvertebral_fracture: { rrr: 0.20, nnt: 67, timeframe: 3, endpoint: "non-vertebral fracture", quality: "hard", source: "FREEDOM" }
            }
        },
        harms: {
            osteonecrosis_jaw: { nnh: 1000, timeframe: 3, source: "FREEDOM extension" },
            atypical_femur_fracture: { nnh: 1000, timeframe: 5, source: "Meta-analysis" }
        },
        burden: "low",
        burdenDetails: "Subcutaneous injection every 6 months. Well tolerated. CRITICAL: must not stop suddenly - causes rapid bone loss.",
        annualCost: 2400,
        monitoring: "Calcium levels, dental exam, bone density",
        contraindications: ["hypocalcemia"]
    },

    // ===== 37. INHALED CORTICOSTEROID - FLUTICASONE =====
    "fluticasone_inh": {
        id: "fluticasone_inh",
        name: "Fluticasone (inhaled)",
        brandNames: ["Flovent", "ArmonAir"],
        class: "Inhaled Corticosteroid (ICS)",
        purpose: "disease_modifying", // Controls inflammation and prevents exacerbations
        indications: ["asthma", "copd"],
        benefits: {
            asthma: {
                exacerbations: { rrr: 0.50, nnt: 7, timeframe: 1, endpoint: "asthma exacerbations", quality: "hard", source: "Meta-analysis" }
            },
            copd: {
                exacerbations: { rrr: 0.25, nnt: 20, timeframe: 1, endpoint: "COPD exacerbations", quality: "hard", source: "TORCH" }
            }
        },
        harms: {
            pneumonia_copd: { nnh: 20, timeframe: 3, source: "TORCH (COPD patients only)" }
        },
        burden: "moderate",
        burdenDetails: "Once or twice daily inhaler. Common: oral thrush (5%), hoarseness. Rinse mouth after use.",
        annualCost: 300,
        monitoring: "Growth in children, bone density if long-term high dose",
        contraindications: ["active_tb", "untreated_fungal_infection"]
    },

    // ===== 38. LABA/ICS - FLUTICASONE/SALMETEROL =====
    "fluticasone_salmeterol": {
        id: "fluticasone_salmeterol",
        name: "Fluticasone/Salmeterol",
        brandNames: ["Advair"],
        class: "ICS/LABA Combination",
        purpose: "disease_modifying", // Controls disease and prevents exacerbations
        indications: ["asthma", "copd"],
        benefits: {
            asthma: {
                exacerbations: { rrr: 0.45, nnt: 8, timeframe: 1, endpoint: "severe exacerbations", quality: "hard", source: "GOAL" }
            },
            copd: {
                exacerbations: { rrr: 0.25, nnt: 15, timeframe: 1, endpoint: "moderate/severe exacerbations", quality: "hard", source: "TORCH" },
                mortality: { rrr: 0.18, nnt: 42, timeframe: 3, endpoint: "all-cause mortality (trend)", quality: "hard", source: "TORCH" }
            }
        },
        harms: {
            pneumonia_copd: { nnh: 16, timeframe: 3, source: "TORCH (COPD)" }
        },
        burden: "moderate",
        burdenDetails: "Twice daily inhaler. Combines steroid + long-acting bronchodilator. Rinse mouth after use.",
        annualCost: 400,
        monitoring: "Bone density if long-term, potassium",
        contraindications: ["severe_milk_allergy"]
    },

    // ===== 39. LAMA - TIOTROPIUM =====
    "tiotropium": {
        id: "tiotropium",
        name: "Tiotropium",
        brandNames: ["Spiriva"],
        class: "Long-Acting Muscarinic Antagonist (LAMA)",
        purpose: "disease_modifying", // Reduces exacerbations and improves disease control
        indications: ["copd", "asthma"],
        benefits: {
            copd: {
                exacerbations: { rrr: 0.14, nnt: 16, timeframe: 1, endpoint: "COPD exacerbations", quality: "hard", source: "UPLIFT" }
                // No mortality benefit in UPLIFT
            },
            asthma: {
                exacerbations: { rrr: 0.21, nnt: 20, timeframe: 1, endpoint: "asthma exacerbations (add-on)", quality: "hard", source: "Meta-analysis" }
            }
        },
        harms: {
            // Dry mouth common but not serious; no robust NNH for serious events
        },
        burden: "low",
        burdenDetails: "Once daily inhaler. Common: dry mouth (10%). Generally well tolerated.",
        annualCost: 400,
        monitoring: "None routine",
        contraindications: ["severe_glaucoma", "urinary_retention"]
    },

    // ===== 40. TRIPLE INHALER - FLUTICASONE/UMECLIDINIUM/VILANTEROL =====
    "fluticasone_umeclidinium_vilanterol": {
        id: "fluticasone_umeclidinium_vilanterol",
        name: "Fluticasone/Umeclidinium/Vilanterol",
        brandNames: ["Trelegy"],
        class: "Triple Therapy (ICS/LAMA/LABA)",
        purpose: "disease_modifying", // Reduces exacerbations and mortality
        indications: ["copd"],
        benefits: {
            copd: {
                exacerbations: { rrr: 0.35, nnt: 9, timeframe: 1, endpoint: "moderate/severe exacerbations", quality: "hard", source: "IMPACT" },
                mortality: { rrr: 0.28, nnt: 104, timeframe: 1, endpoint: "all-cause mortality", quality: "hard", source: "IMPACT" }
            }
        },
        harms: {
            pneumonia: { nnh: 24, timeframe: 1, source: "IMPACT" }
        },
        burden: "low",
        burdenDetails: "Once daily single inhaler. Combines 3 classes in one device. Rinse mouth after use.",
        annualCost: 600,
        monitoring: "Bone density if long-term",
        contraindications: ["severe_milk_allergy"]
    },

    // ===== 41. PROTON PUMP INHIBITOR - OMEPRAZOLE =====
    "omeprazole": {
        id: "omeprazole",
        name: "Omeprazole",
        brandNames: ["Prilosec"],
        class: "Proton Pump Inhibitor (PPI)",
        purpose: "symptomatic", // Relieves GERD symptoms; preventive for GI bleeding
        indications: ["gerd", "peptic_ulcer", "gi_bleed_prevention"],
        benefits: {
            gerd: {
                symptom_relief: { absolute: 0.80, endpoint: "symptom resolution", quality: "surrogate" }
            },
            gi_bleed_prevention: {
                gi_bleeding: { rrr: 0.70, nnt: 50, timeframe: 1, endpoint: "GI bleeding", quality: "hard", source: "Meta-analysis" }
            }
        },
        harms: {
            hip_fracture: { nnh: 1000, timeframe: 5, source: "Observational data (uncertain)" },
            c_diff: { nnh: 500, timeframe: 1, source: "Observational data" }
        },
        burden: "low",
        burdenDetails: "Once or twice daily. Take 30 min before meals. Long-term use concerns: B12 deficiency, low magnesium, possible fracture risk.",
        annualCost: 24,
        monitoring: "B12 and magnesium if long-term use",
        contraindications: ["ppi_allergy"]
    },

    // ===== 42. ALLOPURINOL =====
    "allopurinol": {
        id: "allopurinol",
        name: "Allopurinol",
        brandNames: ["Zyloprim"],
        class: "Xanthine Oxidase Inhibitor",
        purpose: "preventive", // Prevents gout flares
        indications: ["gout"],
        benefits: {
            gout: {
                gout_flares: { rrr: 0.40, nnt: 5, timeframe: 1, endpoint: "gout flares", quality: "hard", source: "Meta-analysis" }
            }
        },
        harms: {
            hypersensitivity_syndrome: { nnh: 1000, timeframe: 1, source: "Meta-analysis" }
        },
        burden: "moderate",
        burdenDetails: "Once daily. Requires slow titration. May trigger gout flares initially - use colchicine prophylaxis. Check HLA-B*5801 in some populations.",
        annualCost: 24,
        monitoring: "Uric acid levels, renal function",
        contraindications: ["allopurinol_hypersensitivity"]
    },

    // ===== 43. FEBUXOSTAT =====
    "febuxostat": {
        id: "febuxostat",
        name: "Febuxostat",
        brandNames: ["Uloric"],
        class: "Xanthine Oxidase Inhibitor",
        purpose: "preventive", // Prevents gout flares
        indications: ["gout"],
        benefits: {
            gout: {
                gout_flares: { rrr: 0.50, nnt: 4, timeframe: 1, endpoint: "gout flares (vs placebo)", quality: "hard", source: "CONFIRMS" }
            }
        },
        harms: {
            cv_death: { nnh: 91, timeframe: 3, source: "CARES (vs allopurinol)" }
        },
        burden: "low",
        burdenDetails: "Once daily. More potent than allopurinol. FDA boxed warning: increased CV death risk vs allopurinol in CV disease.",
        annualCost: 300,
        monitoring: "Uric acid, liver function",
        contraindications: ["azathioprine_use", "mercaptopurine_use"]
    },

    // ===== 44. COLCHICINE =====
    "colchicine": {
        id: "colchicine",
        name: "Colchicine",
        brandNames: ["Colcrys", "Mitigare"],
        class: "Anti-inflammatory",
        purpose: "preventive", // Prevents gout flares and CV events
        indications: ["gout", "cv_prevention"],
        benefits: {
            gout_flare_treatment: {
                pain_relief: { absolute: 0.40, endpoint: "50% pain reduction at 24h", quality: "surrogate", source: "AGREE" }
            },
            cv_prevention: {
                mace: { rrr: 0.23, nnt: 62, timeframe: 2.4, endpoint: "CV death, MI, stroke", quality: "composite", source: "COLCOT" }
            }
        },
        harms: {
            diarrhea_severe: { nnh: 20, timeframe: 0.1, source: "Acute dosing" }
        },
        burden: "moderate",
        burdenDetails: "Once or twice daily for prevention. Very common: diarrhea, nausea. Narrow therapeutic window - drug interactions with statins, CYP3A4.",
        annualCost: 200,
        monitoring: "Renal and hepatic function",
        contraindications: ["severe_ckd", "severe_liver_disease", "blood_dyscrasias"]
    },

    // ===== 45. INSULIN (BASAL) =====
    "insulin_basal": {
        id: "insulin",
        name: "Insulin (Basal)",
        brandNames: ["Lantus", "Basaglar", "Levemir", "Tresiba"],
        class: "Insulin",
        purpose: "replacement", // Replaces deficient insulin (especially T1DM) or supplements in T2DM
        indications: ["diabetes"],
        benefits: {
            diabetes_glycemic: {
                a1c_reduction: { absolute: 1.5, endpoint: "A1C reduction %", quality: "surrogate" }
            },
            diabetes_cv: {
                // ORIGIN trial: neutral CV effect
                mace: { rrr: 0.0, nnt: null, timeframe: 6.2, endpoint: "MACE", quality: "composite", source: "ORIGIN" }
            }
        },
        harms: {
            severe_hypoglycemia: { nnh: 50, timeframe: 1, source: "ORIGIN" }
        },
        burden: "high",
        burdenDetails: "Daily injection. Requires blood glucose monitoring. Common: weight gain (2-4 kg), hypoglycemia. Injection training needed.",
        annualCost: 3500,
        monitoring: "Frequent blood glucose, A1C every 3 months",
        contraindications: ["hypoglycemia_unawareness_severe"]
    },

    // ===== 46. LEVOTHYROXINE =====
    "levothyroxine": {
        id: "levothyroxine",
        name: "Levothyroxine",
        brandNames: ["Synthroid", "Levoxyl", "Unithroid"],
        class: "Thyroid Hormone",
        purpose: "replacement", // Replaces deficient thyroid hormone
        indications: ["hypothyroidism"],
        benefits: {
            hypothyroidism: {
                symptom_relief: { absolute: 0.90, endpoint: "symptom resolution", quality: "surrogate" }
            }
        },
        harms: {
            afib: { nnh: 200, timeframe: 5, source: "Observational (overtreatment)" },
            osteoporosis: { nnh: 500, timeframe: 10, source: "Observational (overtreatment)" }
        },
        burden: "moderate",
        burdenDetails: "Once daily on empty stomach. Take 30-60 min before eating. Many drug/food interactions. Requires dose adjustments.",
        annualCost: 48,
        monitoring: "TSH every 6-12 months once stable, more frequently when adjusting",
        contraindications: ["untreated_adrenal_insufficiency", "acute_mi"]
    },

    // ===== 47. VITAMIN D =====
    "vitamin_d": {
        id: "vitamin-d",
        name: "Vitamin D (Cholecalciferol)",
        brandNames: ["Various"],
        class: "Supplement",
        purpose: "replacement", // Replaces deficient vitamin D
        indications: ["vitamin_d_deficiency", "osteoporosis_adjunct"],
        benefits: {
            deficiency_treatment: {
                bone_health: { absolute: 0.90, endpoint: "normalized vitamin D levels", quality: "surrogate" }
            },
            fall_prevention: {
                falls: { rrr: 0.14, nnt: 100, timeframe: 1, endpoint: "falls (in deficient elderly)", quality: "hard", source: "Meta-analysis" }
            }
        },
        harms: {
            // Very low harm at standard doses
            hypercalcemia: { nnh: 5000, timeframe: 1, source: "With very high doses only" }
        },
        burden: "low",
        burdenDetails: "Daily or weekly. Very well tolerated at standard doses (1000-2000 IU/day).",
        annualCost: 24,
        monitoring: "25-OH vitamin D level if deficient",
        contraindications: ["hypercalcemia", "sarcoidosis"]
    },

    // ===== 48. GABAPENTIN =====
    "gabapentin": {
        id: "gabapentin",
        name: "Gabapentin",
        brandNames: ["Neurontin", "Gralise"],
        class: "Anticonvulsant/Neuropathic Pain Agent",
        purpose: "symptomatic", // Relieves pain symptoms
        indications: ["neuropathic_pain", "seizures"],
        benefits: {
            neuropathic_pain: {
                pain_relief: { rrr: 0.30, nnt: 6, timeframe: 0.25, endpoint: "50% pain reduction", quality: "hard", source: "Cochrane review" }
            }
        },
        harms: {
            falls_elderly: { nnh: 20, timeframe: 1, source: "Observational studies" },
            cns_depression: { nnh: 10, timeframe: 0.25, source: "FDA label, Beers Criteria" }
        },
        burden: "moderate",
        burdenDetails: "Three times daily. Very common: dizziness (20%), somnolence (20%), peripheral edema. Requires slow titration.",
        annualCost: 48,
        monitoring: "Renal function for dose adjustment",
        contraindications: ["gabapentin_hypersensitivity"],
        beers_criteria: {
            listed: true,
            concern: "May cause or exacerbate SIADH, ataxia, impaired psychomotor function, syncope, falls",
            recommendation: "Avoid in older adults; if used, reduce dose and monitor closely",
            strength: "strong",
            quality_of_evidence: "moderate"
        },
        elderly_caution: {
            fall_risk: true,
            cognitive_impairment: true,
            sedation: true,
            requires_renal_adjustment: true,
            avoid_if_frail: true
        }
    },

    // ===== 49. PREGABALIN =====
    "pregabalin": {
        id: "pregabalin",
        name: "Pregabalin",
        brandNames: ["Lyrica"],
        class: "Anticonvulsant/Neuropathic Pain Agent",
        purpose: "symptomatic", // Relieves pain symptoms
        indications: ["neuropathic_pain", "fibromyalgia", "seizures"],
        benefits: {
            neuropathic_pain: {
                pain_relief: { rrr: 0.35, nnt: 5, timeframe: 0.25, endpoint: "50% pain reduction", quality: "hard", source: "Cochrane review" }
            },
            fibromyalgia: {
                pain_relief: { rrr: 0.25, nnt: 10, timeframe: 0.25, endpoint: "30% pain reduction", quality: "hard", source: "Cochrane review" }
            }
        },
        harms: {
            falls_elderly: { nnh: 15, timeframe: 1, source: "Observational studies" },
            cns_depression: { nnh: 8, timeframe: 0.25, source: "FDA label, Beers Criteria" },
            edema_worsening_hf: { nnh: 25, timeframe: 0.5, source: "FDA label" }
        },
        burden: "moderate",
        burdenDetails: "Twice daily. Common: dizziness (30%), somnolence (25%), weight gain, peripheral edema. Schedule V controlled substance.",
        annualCost: 150,
        monitoring: "Renal function for dose adjustment",
        contraindications: ["pregabalin_hypersensitivity", "heart_failure_edema"],
        beers_criteria: {
            listed: true,
            concern: "May cause or exacerbate SIADH, ataxia, impaired psychomotor function, syncope, falls; peripheral edema may worsen heart failure",
            recommendation: "Avoid in older adults; if used, reduce dose and monitor closely",
            strength: "strong",
            quality_of_evidence: "moderate"
        },
        elderly_caution: {
            fall_risk: true,
            cognitive_impairment: true,
            sedation: true,
            requires_renal_adjustment: true,
            avoid_if_frail: true,
            avoid_in_hf: true
        }
    },

    // ===== 50. DULOXETINE =====
    "duloxetine": {
        id: "duloxetine",
        name: "Duloxetine",
        brandNames: ["Cymbalta"],
        class: "SNRI",
        purpose: "symptomatic", // Relieves depression and pain symptoms
        indications: ["depression", "neuropathic_pain", "fibromyalgia", "anxiety"],
        benefits: {
            depression: {
                remission: { rrr: 0.20, nnt: 8, timeframe: 0.25, endpoint: "depression remission", quality: "hard", source: "Meta-analysis" }
            },
            neuropathic_pain: {
                pain_relief: { rrr: 0.30, nnt: 6, timeframe: 0.25, endpoint: "50% pain reduction", quality: "hard", source: "Meta-analysis" }
            }
        },
        harms: {
            discontinuation_syndrome: { nnh: 10, timeframe: 0.1, source: "If stopped abruptly" }
        },
        burden: "moderate",
        burdenDetails: "Once daily. Common: nausea (25%), dry mouth (15%), constipation. Must taper to stop - withdrawal symptoms if stopped abruptly.",
        annualCost: 48,
        monitoring: "Blood pressure, liver function",
        contraindications: ["maoi_use", "uncontrolled_glaucoma", "severe_liver_disease"]
    },

    // ===== 51. PCSK9 INHIBITOR - EVOLOCUMAB =====
    "evolocumab": {
        id: "evolocumab",
        name: "Evolocumab",
        brandNames: ["Repatha"],
        class: "PCSK9 Inhibitor",
        purpose: "preventive", // Prevents CV events
        indications: ["hyperlipidemia", "ascvd_prevention"],
        benefits: {
            secondary_prevention: {
                mace: { rrr: 0.15, nnt: 63, timeframe: 2.2, endpoint: "CV death, MI, stroke", quality: "composite", source: "FOURIER" }
            }
        },
        harms: {
            // Very well tolerated, injection site reactions mild
        },
        burden: "moderate",
        burdenDetails: "Subcutaneous injection every 2 weeks or monthly. Common: injection site reactions (5%). Extremely potent LDL lowering (60%).",
        annualCost: 6000,
        monitoring: "Lipid panel",
        contraindications: ["pcsk9_hypersensitivity"]
    },

    // ===== 52. RIVAROXABAN LOW-DOSE + ASA =====
    "rivaroxaban_vascular": {
        id: "rivaroxaban_vascular",
        name: "Rivaroxaban 2.5mg BID (vascular dose)",
        brandNames: ["Xarelto (vascular)"],
        class: "Anticoagulant + Antiplatelet",
        purpose: "preventive", // Prevents CV and limb events
        indications: ["stable_cad", "pad"],
        benefits: {
            stable_cad_pad: {
                mace: { rrr: 0.24, nnt: 77, timeframe: 2, endpoint: "CV death, MI, stroke", quality: "composite", source: "COMPASS" },
                limb_events: { rrr: 0.46, nnt: 200, timeframe: 2, endpoint: "major adverse limb events", quality: "hard", source: "COMPASS" }
            }
        },
        harms: {
            major_bleeding: { nnh: 91, timeframe: 2, source: "COMPASS" }
        },
        burden: "moderate",
        burdenDetails: "Twice daily (taken with aspirin 100mg). Higher bleeding risk than aspirin alone.",
        annualCost: 5500,
        monitoring: "Renal function, bleeding symptoms",
        contraindications: ["high_bleeding_risk", "severe_ckd"]
    },

    // ===== 53. ICOSAPENT ETHYL =====
    "icosapent_ethyl": {
        id: "icosapent_ethyl",
        name: "Icosapent Ethyl",
        brandNames: ["Vascepa"],
        class: "Omega-3 Fatty Acid (purified EPA)",
        purpose: "preventive", // Prevents CV events
        indications: ["hypertriglyceridemia", "cv_prevention"],
        benefits: {
            cv_prevention_high_tg: {
                mace: { rrr: 0.25, nnt: 21, timeframe: 4.9, endpoint: "CV death, MI, stroke, revascularization", quality: "composite", source: "REDUCE-IT" }
            }
        },
        harms: {
            afib: { nnh: 77, timeframe: 4.9, source: "REDUCE-IT" },
            bleeding: { nnh: 125, timeframe: 4.9, source: "REDUCE-IT (minor bleeding)" }
        },
        burden: "moderate",
        burdenDetails: "Four capsules daily (2g twice daily with meals). Must be taken with food.",
        annualCost: 3600,
        monitoring: "Triglycerides, bleeding symptoms",
        contraindications: ["fish_allergy"]
    },

    // ===== 54. CANAGLIFLOZIN =====
    "canagliflozin": {
        id: "canagliflozin",
        name: "Canagliflozin",
        brandNames: ["Invokana"],
        class: "SGLT2 Inhibitor",
        purpose: "disease_modifying", // Modifies CKD and diabetes disease progression
        indications: ["diabetes", "ckd", "heart_failure"],
        benefits: {
            diabetes_cv: {
                mace: { rrr: 0.14, nnt: 73, timeframe: 2.4, endpoint: "MACE", quality: "composite", source: "CANVAS" }
            },
            ckd: {
                kidney_progression: { rrr: 0.30, nnt: 22, timeframe: 2.6, endpoint: "ESKD, doubling creatinine, renal death", quality: "hard", source: "CREDENCE" }
            }
        },
        harms: {
            amputation: { nnh: 345, timeframe: 2.4, source: "CANVAS (signal, not confirmed in CREDENCE)" },
            dka: { nnh: 1000, timeframe: 2, source: "CANVAS/CREDENCE" }
        },
        burden: "low",
        burdenDetails: "Once daily. Common: genital infections (6%), increased urination. FDA warning about amputation risk (uncertain causality).",
        annualCost: 6000,
        monitoring: "Renal function, foot exams",
        contraindications: ["dialysis", "type1_diabetes"]
    },

    // ===== 55. FINERENONE =====
    "finerenone": {
        id: "finerenone",
        name: "Finerenone",
        brandNames: ["Kerendia"],
        class: "Non-steroidal MRA",
        purpose: "disease_modifying", // Slows kidney disease progression
        indications: ["diabetic_kidney_disease"],
        benefits: {
            diabetic_kidney_disease: {
                kidney_progression: { rrr: 0.18, nnt: 34, timeframe: 2.6, endpoint: "kidney failure, 40% eGFR decline", quality: "hard", source: "FIDELIO-DKD" },
                cv_events: { rrr: 0.14, nnt: 42, timeframe: 2.6, endpoint: "CV death, MI, stroke, HF hosp", quality: "composite", source: "FIDELIO-DKD" }
            }
        },
        harms: {
            hyperkalemia: { nnh: 12, timeframe: 2.6, source: "FIDELIO-DKD" }
        },
        burden: "moderate",
        burdenDetails: "Once daily. Common: hyperkalemia (18%). Requires potassium monitoring. No gynecomastia (unlike spironolactone).",
        annualCost: 6000,
        monitoring: "Potassium at 4 weeks, then periodically; eGFR",
        contraindications: ["severe_ckd", "adrenal_insufficiency", "concurrent_strong_cyp3a4_inhibitors"]
    },

    // ===== 56. TERIPARATIDE =====
    "teriparatide": {
        id: "teriparatide",
        name: "Teriparatide",
        brandNames: ["Forteo"],
        class: "PTH Analog (Anabolic)",
        purpose: "disease_modifying", // Builds bone, modifies osteoporosis disease course
        indications: ["osteoporosis_severe"],
        benefits: {
            osteoporosis_severe: {
                vertebral_fracture: { rrr: 0.65, nnt: 11, timeframe: 1.8, endpoint: "vertebral fracture", quality: "hard", source: "Fracture Prevention Trial" },
                nonvertebral_fracture: { rrr: 0.35, nnt: 33, timeframe: 1.8, endpoint: "non-vertebral fracture", quality: "hard", source: "Fracture Prevention Trial" }
            }
        },
        harms: {
            hypercalcemia: { nnh: 50, timeframe: 1.8, source: "Fracture Prevention Trial" }
        },
        burden: "high",
        burdenDetails: "Daily subcutaneous injection for up to 2 years. Common: leg cramps, dizziness. Must transition to antiresorptive after.",
        annualCost: 25000,
        monitoring: "Calcium levels, uric acid",
        contraindications: ["pagets_disease", "prior_radiation_therapy", "bone_metastases", "hypercalcemia"]
    },

    // ===== 57. ROMOSOZUMAB =====
    "romosozumab": {
        id: "romosozumab",
        name: "Romosozumab",
        brandNames: ["Evenity"],
        class: "Sclerostin Inhibitor (Anabolic)",
        purpose: "disease_modifying", // Builds bone, modifies osteoporosis disease course
        indications: ["osteoporosis_severe"],
        benefits: {
            osteoporosis_severe: {
                vertebral_fracture: { rrr: 0.73, nnt: 20, timeframe: 1, endpoint: "vertebral fracture", quality: "hard", source: "FRAME" },
                hip_fracture: { rrr: 0.38, nnt: 167, timeframe: 2, endpoint: "hip fracture (vs alendronate)", quality: "hard", source: "ARCH" }
            }
        },
        harms: {
            cv_events: { nnh: 100, timeframe: 1, source: "ARCH" }
        },
        burden: "moderate",
        burdenDetails: "Monthly subcutaneous injection for 12 months only. Common: injection site reactions, arthralgia. FDA boxed warning: CV risk.",
        annualCost: 22000,
        monitoring: "Calcium, symptoms of CV events",
        contraindications: ["mi_within_1_year", "stroke_within_1_year", "hypocalcemia"]
    },

    // ===== 58. BUMETANIDE =====
    "bumetanide": {
        id: "bumetanide",
        name: "Bumetanide",
        brandNames: ["Bumex"],
        class: "Loop Diuretic",
        purpose: "symptomatic", // Relieves congestion symptoms
        indications: ["heart_failure", "edema"],
        benefits: {
            heart_failure_symptoms: {
                congestion_relief: { absolute: 0.90, endpoint: "symptom improvement", quality: "surrogate" }
            }
        },
        harms: {
            // Similar to furosemide
        },
        burden: "moderate",
        burdenDetails: "Once to twice daily. 40x more potent than furosemide per mg. May be preferred in severe edema or furosemide resistance.",
        annualCost: 120,
        monitoring: "Electrolytes, creatinine, weight",
        contraindications: ["anuria", "severe_hypokalemia"]
    },

    // ===== 59. TORSEMIDE =====
    "torsemide": {
        id: "torsemide",
        name: "Torsemide",
        brandNames: ["Demadex"],
        class: "Loop Diuretic",
        purpose: "symptomatic", // Relieves congestion symptoms
        indications: ["heart_failure", "edema"],
        benefits: {
            heart_failure: {
                hospitalization: { rrr: 0.17, nnt: 25, timeframe: 1, endpoint: "HF hospitalization vs furosemide", quality: "hard", source: "TRANSFORM-HF (no sig diff)" }
            }
        },
        harms: {
            // Similar to furosemide
        },
        burden: "low",
        burdenDetails: "Once daily. Longer duration than furosemide, more predictable absorption. May reduce nighttime urination.",
        annualCost: 48,
        monitoring: "Electrolytes, creatinine, weight",
        contraindications: ["anuria", "severe_hypokalemia"]
    },

    // ===== 60. CHLORTHALIDONE =====
    "chlorthalidone": {
        id: "chlorthalidone",
        name: "Chlorthalidone",
        brandNames: ["Hygroton"],
        class: "Thiazide-like Diuretic",
        purpose: "preventive", // Prevents stroke and CV events via BP control
        indications: ["hypertension"],
        benefits: {
            hypertension: {
                stroke: { rrr: 0.36, nnt: 50, timeframe: 5, endpoint: "stroke", quality: "hard", source: "ALLHAT" },
                mortality: { rrr: 0.15, nnt: 100, timeframe: 5, endpoint: "all-cause mortality", quality: "hard", source: "Meta-analysis" }
            }
        },
        harms: {
            // Electrolyte disturbances, gout
            hypokalemia_severe: { nnh: 50, timeframe: 1, source: "ALLHAT" }
        },
        burden: "low",
        burdenDetails: "Once daily. Longer acting than HCTZ, more potent. May cause more hypokalemia than HCTZ.",
        annualCost: 24,
        monitoring: "Electrolytes (K, Na), uric acid, glucose",
        contraindications: ["anuria", "severe_hypokalemia"]
    }
};

// Helper function to get medication by ID
function getMedication(id) {
    return MEDICATIONS_DATABASE[id] || null;
}

// Get all medications
function getAllMedications() {
    return Object.values(MEDICATIONS_DATABASE);
}

// Get medications by indication
function getMedicationsByIndication(indication) {
    return Object.values(MEDICATIONS_DATABASE).filter(med =>
        med.indications.includes(indication)
    );
}

// Get medications by class
function getMedicationsByClass(medClass) {
    return Object.values(MEDICATIONS_DATABASE).filter(med =>
        med.class.toLowerCase().includes(medClass.toLowerCase())
    );
}

// Get medications by purpose
function getMedicationsByPurpose(purpose) {
    return Object.values(MEDICATIONS_DATABASE).filter(med =>
        med.purpose === purpose
    );
}

// Purpose display labels and descriptions
const PURPOSE_INFO = {
    preventive: {
        label: "Preventive",
        shortLabel: "PREVENT",
        description: "Prevents future events or disease (e.g., statins, bisphosphonates, anticoagulants)",
        color: "#3498db" // Blue
    },
    disease_modifying: {
        label: "Disease-Modifying",
        shortLabel: "DISEASE-MOD",
        description: "Treats underlying disease and changes its course (e.g., HF medications, SGLT2 inhibitors for CKD)",
        color: "#27ae60" // Green
    },
    symptomatic: {
        label: "Symptomatic",
        shortLabel: "SYMPTOM",
        description: "Relieves symptoms without changing disease course (e.g., pain medications, loop diuretics)",
        color: "#f39c12" // Orange
    },
    replacement: {
        label: "Replacement",
        shortLabel: "REPLACE",
        description: "Replaces missing hormones or nutrients (e.g., levothyroxine, vitamin D, insulin)",
        color: "#9b59b6" // Purple
    }
};

// Export for use in other modules
if (typeof module !== 'undefined' && module.exports) {
    module.exports = { MEDICATIONS_DATABASE, getMedication, getAllMedications, getMedicationsByIndication, getMedicationsByClass, getMedicationsByPurpose, PURPOSE_INFO };
}

/**
 * Risk Calculators
 *
 * Implementations of common clinical risk calculators
 */

const RiskCalculators = {
    /**
     * CHA‚ÇÇDS‚ÇÇ-VASc Score for stroke risk in atrial fibrillation
     * Returns score 0-9 and annual stroke risk percentage
     */
    calculateCHADS2VASc: function(patientData) {
        let score = 0;

        // C - Congestive heart failure (1 point)
        if (patientData.chfHistory || patientData.ef < 40) score += 1;

        // H - Hypertension (1 point)
        if (patientData.htnTreatment || patientData.systolicBP >= 140) score += 1;

        // A‚ÇÇ - Age ‚â•75 (2 points)
        if (patientData.age >= 75) score += 2;
        // A - Age 65-74 (1 point)
        else if (patientData.age >= 65) score += 1;

        // D - Diabetes (1 point)
        if (patientData.diabetesStatus === 'type2' || patientData.diabetesStatus === 'type1') score += 1;

        // S‚ÇÇ - Stroke/TIA/thromboembolism (2 points)
        if (patientData.priorStroke) score += 2;

        // V - Vascular disease (1 point)
        if (patientData.priorMI || patientData.pvd) score += 1;

        // Sc - Sex category - female (1 point)
        if (patientData.sex === 'female') score += 1;

        // Annual stroke risk by score (approximate from literature)
        const strokeRiskByScore = {
            0: 0.2, 1: 0.6, 2: 2.2, 3: 3.2, 4: 4.8,
            5: 7.2, 6: 9.7, 7: 11.2, 8: 10.8, 9: 12.2
        };

        return {
            score: score,
            annualStrokeRisk: strokeRiskByScore[Math.min(score, 9)] || 12.2,
            interpretation: score === 0 ? 'Low risk' :
                           score === 1 ? 'Low-moderate risk' :
                           score >= 2 ? 'Moderate-high risk (anticoagulation recommended)' : ''
        };
    },

    /**
     * HAS-BLED Score for bleeding risk on anticoagulation
     * Returns score 0-9 and annual major bleeding risk
     */
    calculateHASBLED: function(patientData) {
        let score = 0;

        // H - Hypertension (uncontrolled, SBP >160)
        if (patientData.systolicBP > 160) score += 1;

        // A - Abnormal renal/liver function (1 point each)
        if (patientData.creatinine > 2.3 || patientData.egfr < 30) score += 1;
        if (patientData.liverDisease) score += 1;

        // S - Stroke history
        if (patientData.priorStroke) score += 1;

        // B - Bleeding history or predisposition
        if (patientData.priorBleed || patientData.anemia) score += 1;

        // L - Labile INR (assume if on warfarin without good control data)
        // Skip for now unless we track this

        // E - Elderly (>65)
        if (patientData.age > 65) score += 1;

        // D - Drugs (antiplatelet, NSAIDs) or alcohol
        if (patientData.nsaidUse || patientData.antiplatelet) score += 1;
        if (patientData.alcohol) score += 1;

        // Annual major bleeding risk by score
        const bleedRiskByScore = {
            0: 1.1, 1: 1.0, 2: 1.9, 3: 3.7, 4: 8.7, 5: 12.5
        };

        return {
            score: score,
            annualBleedRisk: bleedRiskByScore[Math.min(score, 5)] || 12.5,
            interpretation: score <= 2 ? 'Low-moderate bleeding risk' :
                           score >= 3 ? 'High bleeding risk - caution with anticoagulation' : ''
        };
    },

    /**
     * Pooled Cohort Equations (ASCVD Risk Calculator)
     * 10-year risk of atherosclerotic cardiovascular disease
     */
    calculateASCVDRisk: function(patientData) {
        // Simplified version - full calculation requires natural log coefficients
        // This is an approximation for demonstration

        if (!patientData.age || !patientData.totalCholesterol || !patientData.hdl ||
            !patientData.systolicBP || !patientData.sex) {
            return { risk: null, interpretation: 'Insufficient data' };
        }

        let baseRisk = 0;
        const age = patientData.age;
        const isMale = patientData.sex === 'male';
        const isBlack = patientData.race === 'black';

        // Age contribution
        if (isMale) {
            baseRisk = (age - 40) * 0.8;
        } else {
            baseRisk = (age - 40) * 0.5;
        }

        // Cholesterol contribution
        const tcHdlRatio = patientData.totalCholesterol / patientData.hdl;
        baseRisk += (tcHdlRatio - 4) * 1.5;

        // Blood pressure contribution
        const sbp = patientData.systolicBP;
        if (patientData.htnTreatment) {
            baseRisk += (sbp - 120) * 0.08;
        } else {
            baseRisk += (sbp - 120) * 0.05;
        }

        // Smoking
        if (patientData.smoker) baseRisk += 4;

        // Diabetes
        if (patientData.diabetesStatus === 'type2' || patientData.diabetesStatus === 'type1') {
            baseRisk += isMale ? 3 : 5;
        }

        // Race adjustment
        if (isBlack) {
            baseRisk *= isMale ? 1.1 : 1.3;
        }

        // Convert to percentage (simplified sigmoid-like function)
        let risk = 1 / (1 + Math.exp(-0.15 * (baseRisk - 10))) * 30;
        risk = Math.max(0.5, Math.min(risk, 50)); // Cap between 0.5% and 50%

        return {
            risk: risk.toFixed(1),
            interpretation: risk < 5 ? 'Low risk (<5%)' :
                           risk < 7.5 ? 'Borderline risk (5-7.5%)' :
                           risk < 20 ? 'Intermediate risk (7.5-20%)' :
                           'High risk (‚â•20%)'
        };
    },

    /**
     * Framingham Heart Failure Risk Score (simplified)
     */
    calculateHFRisk: function(patientData) {
        if (!patientData.age) return { risk: null };

        let points = 0;

        // Age points (simplified)
        points += Math.floor((patientData.age - 45) / 5) * 2;

        // Hypertension
        if (patientData.htnTreatment || patientData.systolicBP >= 140) points += 2;

        // Diabetes
        if (patientData.diabetesStatus === 'type2' || patientData.diabetesStatus === 'type1') points += 3;

        // Prior MI
        if (patientData.priorMI) points += 4;

        // LVH/cardiomegaly (use EF as proxy)
        if (patientData.ef && patientData.ef < 50) points += 3;

        // BMI (if available)
        if (patientData.weight && patientData.height) {
            const bmi = patientData.weight / Math.pow(patientData.height / 100, 2);
            if (bmi >= 30) points += 2;
        }

        // Convert to 10-year risk (simplified)
        const risk = Math.min(points * 1.5, 40);

        return {
            points: points,
            risk: risk.toFixed(1),
            interpretation: risk < 5 ? 'Low risk' :
                           risk < 10 ? 'Moderate risk' :
                           risk < 20 ? 'High risk' :
                           'Very high risk'
        };
    },

    /**
     * UKPDS Risk Engine (simplified) for diabetes complications
     * 10-year risk of CHD, stroke, etc.
     */
    calculateUKPDSRisk: function(patientData) {
        if (patientData.diabetesStatus !== 'type2' && patientData.diabetesStatus !== 'type1') {
            return { chdRisk: null, strokeRisk: null };
        }

        const age = patientData.age || 60;
        const duration = patientData.diabetesDuration || 5;
        const a1c = patientData.a1c || 7.5;
        const sbp = patientData.systolicBP || 135;
        const tcHdlRatio = patientData.totalCholesterol && patientData.hdl ?
            patientData.totalCholesterol / patientData.hdl : 5;

        // Simplified CHD risk
        let chdRisk = 5; // Base 5%
        chdRisk += (age - 50) * 0.3;
        chdRisk += duration * 0.5;
        chdRisk += (a1c - 6.5) * 2;
        chdRisk += (sbp - 120) * 0.1;
        chdRisk += (tcHdlRatio - 4) * 1.5;
        if (patientData.smoker) chdRisk *= 1.5;
        if (patientData.sex === 'male') chdRisk *= 1.2;

        // Simplified stroke risk
        let strokeRisk = 3;
        strokeRisk += (age - 50) * 0.2;
        strokeRisk += duration * 0.3;
        strokeRisk += (sbp - 120) * 0.08;
        if (patientData.afib) strokeRisk *= 2;

        return {
            chdRisk: Math.min(Math.max(chdRisk, 1), 50).toFixed(1),
            strokeRisk: Math.min(Math.max(strokeRisk, 1), 30).toFixed(1),
            interpretation: {
                chd: chdRisk < 10 ? 'Low-moderate' : chdRisk < 20 ? 'Moderate-high' : 'High',
                stroke: strokeRisk < 5 ? 'Low' : strokeRisk < 10 ? 'Moderate' : 'High'
            }
        };
    },

    /**
     * Seattle Heart Failure Model (simplified)
     * Estimates 1, 2, and 5-year survival
     */
    calculateSeattleHFSurvival: function(patientData) {
        if (!patientData.ef || patientData.ef >= 50) {
            return { survival1yr: null, interpretation: 'Not applicable (EF ‚â•50% or unknown)' };
        }

        const age = patientData.age || 65;
        const ef = patientData.ef;
        const nyha = parseInt(patientData.nyha) || 2;
        const sbp = patientData.systolicBP || 110;
        const creatinine = patientData.creatinine || 1.2;

        // Simplified survival calculation
        let riskScore = 0;
        riskScore += (age - 60) * 0.02;
        riskScore += (40 - ef) * 0.02;
        riskScore += (nyha - 2) * 0.15;
        riskScore -= (sbp - 100) * 0.005;
        riskScore += (creatinine - 1) * 0.1;

        if (patientData.diabetesStatus === 'type2') riskScore += 0.1;
        if (patientData.afib) riskScore += 0.05;

        // Calculate survival (simplified exponential model)
        const survival1yr = Math.max(0.4, Math.min(0.95, 0.9 - riskScore));
        const survival2yr = Math.pow(survival1yr, 1.8);
        const survival5yr = Math.pow(survival1yr, 4);

        // Estimate life-years gained from GDMT
        const gdmtBenefit = {
            betaBlocker: (1 - survival5yr) * 0.35 * 5,
            mra: (1 - survival5yr) * 0.30 * 5,
            arni: (1 - survival5yr) * 0.20 * 5,
            sglt2i: (1 - survival5yr) * 0.25 * 5
        };

        return {
            survival1yr: (survival1yr * 100).toFixed(0),
            survival2yr: (survival2yr * 100).toFixed(0),
            survival5yr: (survival5yr * 100).toFixed(0),
            potentialGDMTBenefit: gdmtBenefit,
            interpretation: survival1yr >= 0.85 ? 'Good prognosis' :
                           survival1yr >= 0.70 ? 'Moderate prognosis' :
                           'Poor prognosis - aggressive therapy warranted'
        };
    },

    /**
     * eGFR Calculation (CKD-EPI 2021)
     */
    calculateEGFR: function(patientData) {
        if (!patientData.creatinine || !patientData.age) return null;

        const cr = patientData.creatinine;
        const age = patientData.age;
        const isFemale = patientData.sex === 'female';

        // CKD-EPI 2021 (race-free)
        const kappa = isFemale ? 0.7 : 0.9;
        const alpha = isFemale ? -0.241 : -0.302;
        const scr_k = cr / kappa;

        let egfr;
        if (scr_k <= 1) {
            egfr = 142 * Math.pow(scr_k, alpha) * Math.pow(0.9938, age);
        } else {
            egfr = 142 * Math.pow(scr_k, -1.200) * Math.pow(0.9938, age);
        }

        if (isFemale) egfr *= 1.012;

        return {
            egfr: Math.round(egfr),
            stage: egfr >= 90 ? 'G1 (Normal)' :
                   egfr >= 60 ? 'G2 (Mild)' :
                   egfr >= 45 ? 'G3a (Mild-Mod)' :
                   egfr >= 30 ? 'G3b (Mod-Severe)' :
                   egfr >= 15 ? 'G4 (Severe)' :
                   'G5 (Kidney Failure)'
        };
    },

    /**
     * Calculate all applicable risks for a patient
     */
    calculateAllRisks: function(patientData) {
        const results = {};

        // ASCVD Risk
        results.ascvd = this.calculateASCVDRisk(patientData);

        // AFib-related scores (only if has AFib)
        if (patientData.afib) {
            results.chadsvasc = this.calculateCHADS2VASc(patientData);
            results.hasbled = this.calculateHASBLED(patientData);
        }

        // Heart failure (only if EF reduced or HF symptoms)
        if ((patientData.ef && patientData.ef < 50) || parseInt(patientData.nyha) > 0) {
            results.seattleHF = this.calculateSeattleHFSurvival(patientData);
            results.hfRisk = this.calculateHFRisk(patientData);
        }

        // Diabetes risks
        if (patientData.diabetesStatus === 'type2' || patientData.diabetesStatus === 'type1') {
            results.ukpds = this.calculateUKPDSRisk(patientData);
        }

        // eGFR
        if (patientData.creatinine) {
            results.egfr = this.calculateEGFR(patientData);
        }

        return results;
    }
};

// Export
if (typeof module !== 'undefined' && module.exports) {
    module.exports = RiskCalculators;
}

/**
 * Net Benefit Calculation Engine
 *
 * Core Formula:
 * Net Benefit = Œ£(Expected Benefits) - Œ£(Expected Harms) - Burden Penalty
 *
 * Where:
 * Expected Benefit = (1/NNT) √ó Severity Weight √ó 100 patients
 * Expected Harm = (1/NNH) √ó Severity Weight √ó 100 patients
 *
 * All values are annualized and expressed as "quality-adjusted life-years saved per 100 patients per year"
 */

const BenefitEngine = {

    /**
     * Severity weights for different outcomes
     * Scale: 0-1 where 1 = death equivalent (1 QALY lost)
     * Based on standard QALY/utility estimates from health economics literature
     *
     * These represent the QALY impact of experiencing the event once
     */
    OUTCOME_WEIGHTS: {
        // === BENEFITS (events prevented) ===
        death: 1.0,
        cv_death: 1.0,
        all_cause_mortality: 1.0,
        mortality: 1.0,

        stroke_disabling: 0.7,      // Permanent severe disability
        stroke_any: 0.4,            // Mix of disabling and non-disabling
        stroke: 0.4,

        mi_fatal: 1.0,
        mi_nonfatal: 0.2,           // ~2-3 months recovery, some permanent impact
        mi: 0.25,

        heart_failure_hospitalization: 0.15,  // ~2-3 week event, some lasting impact
        hf_hospitalization: 0.15,
        hospitalization: 0.1,
        cv_hospitalization: 0.1,

        cv_death_hf_hosp: 0.4,      // Composite - weighted average
        mace: 0.35,                 // Composite of MI, stroke, CV death
        mace_composite: 0.35,

        eskd_dialysis: 0.5,         // Major permanent impact on QOL
        kidney_progression: 0.3,
        esrd: 0.5,
        doubling_creatinine: 0.2,

        amputation: 0.4,
        blindness: 0.4,

        thromboembolism: 0.3,       // Valve thrombosis/embolism
        stroke_recurrence: 0.4,

        // Fractures (osteoporosis)
        hip_fracture: 0.5,          // High mortality, permanent disability in elderly
        vertebral_fracture: 0.2,    // Pain, disability, height loss
        nonvertebral_fracture: 0.15, // Wrist, arm, etc. - recoverable
        falls: 0.05,                // Single fall event

        // Respiratory
        exacerbations: 0.1,         // COPD/asthma exacerbation

        // Gout
        gout_flares: 0.02,          // Acute pain episode

        // Pain relief
        pain_relief: 0.15,          // 50% pain reduction (neuropathic)

        // Depression
        remission: 0.2,             // Depression remission

        // Limb events
        limb_events: 0.3,           // Major adverse limb events (amputation, revascularization)

        // Symptom relief (surrogate but clinically meaningful)
        symptom_relief: 0.1,
        congestion_relief: 0.1,

        // === HARMS (serious adverse events with NNH) ===
        // These are QALY losses per event

        // Bleeding events
        major_bleeding: 0.15,       // Hospitalization, transfusion, ~1-2 month recovery
        intracranial_bleeding: 0.6, // ICH - high mortality/disability
        gi_bleeding: 0.08,          // Usually recoverable, ~2-4 weeks
        fatal_bleeding: 1.0,

        // Metabolic
        severe_hypoglycemia: 0.05,  // Single episode, recoverable
        dka: 0.1,                   // ICU stay, ~1-2 week recovery
        new_onset_diabetes: 0.05,   // Chronic but manageable condition
        hypercalcemia: 0.05,        // Usually reversible

        // Renal
        aki: 0.1,                   // Acute event, usually recoverable
        hyperkalemia_severe: 0.08,  // K>6.0, may require hospitalization
        hyperkalemia: 0.05,         // Moderate hyperkalemia

        // Bone (from osteoporosis meds)
        atypical_femur_fracture: 0.4,  // Serious fracture
        osteonecrosis_jaw: 0.2,        // ONJ

        // Respiratory
        pneumonia: 0.1,             // Hospitalization, recovery
        pneumonia_copd: 0.15,       // More serious in COPD patients

        // CV harm
        cv_events: 0.3,             // CV death, MI, stroke
        cv_death: 1.0,
        afib: 0.1,                  // New onset AFib

        // Falls
        falls_elderly: 0.1,         // Falls in elderly on CNS meds

        // CNS effects in elderly (Beers Criteria medications)
        cns_depression: 0.15,       // Sedation, cognitive impairment, delirium risk
        cognitive_impairment: 0.2,  // Worsening cognition in elderly
        edema_worsening_hf: 0.1,    // Peripheral edema exacerbating HF

        // Discontinuation
        discontinuation_syndrome: 0.02, // Withdrawal symptoms

        // Other serious
        angioedema: 0.1,            // Can be life-threatening
        pancreatitis: 0.1,          // Hospitalization, 1-2 week recovery
        rhabdomyolysis: 0.15,       // Serious, hospitalization required
        hypersensitivity_syndrome: 0.2, // Drug hypersensitivity (allopurinol)
        diarrhea_severe: 0.02,      // Severe diarrhea (colchicine)
        amputation: 0.4             // Limb amputation
    },

    /**
     * Burden penalties (annual QALY decrement from taking the medication)
     * This now includes minor side effects (fatigue, nausea, etc.) plus:
     * - Pill burden
     * - Monitoring requirements
     * - Dietary restrictions
     * - Injection burden
     */
    BURDEN_PENALTIES: {
        low: 0.01,      // Once daily pill, no monitoring, minimal side effects
        moderate: 0.03, // Multiple daily doses OR regular monitoring OR common mild side effects (GI, fatigue)
        high: 0.06      // Frequent monitoring (INR), injections, significant side effects, dietary restrictions
    },

    /**
     * Calculate expected benefit for a single outcome using NNT
     *
     * @param {number} nnt - Number needed to treat (can be null if we need to calculate from RRR)
     * @param {number} baselineRisk - Annual probability of event (0-1) - used if NNT not provided
     * @param {number} rrr - Relative risk reduction (0-1) - used if NNT not provided
     * @param {string} outcomeType - Type of outcome for severity weighting
     * @param {number} timeframe - Years over which NNT was calculated (to annualize)
     * @returns {number} Expected benefit in QALYs per 100 patients per year
     */
    calculateExpectedBenefit: function(nnt, baselineRisk, rrr, outcomeType, timeframe = 1) {
        let annualNnt;

        if (nnt && nnt > 0) {
            // Annualize NNT if timeframe > 1 year
            // If NNT is 20 over 3 years, annual NNT is ~60
            annualNnt = nnt * timeframe;
        } else if (baselineRisk && rrr) {
            // Calculate NNT from baseline risk and RRR
            const arr = baselineRisk * rrr;
            if (arr > 0) {
                annualNnt = 1 / arr;
            } else {
                return 0;
            }
        } else {
            return 0;
        }

        const severityWeight = this.OUTCOME_WEIGHTS[outcomeType] || 0.2;

        // Benefit = (1/NNT) √ó severity √ó 100 patients
        // This gives QALYs saved per 100 patients per year
        const benefitPer100 = (1 / annualNnt) * severityWeight * 100;

        return benefitPer100;
    },

    /**
     * Calculate expected harm for a serious adverse event using NNH
     *
     * @param {number} nnh - Number needed to harm (annualized)
     * @param {string} harmType - Type of harm for severity weighting
     * @param {number} timeframe - Years over which NNH was calculated (to annualize)
     * @returns {number} Expected harm in QALYs lost per 100 patients per year
     */
    calculateExpectedHarm: function(nnh, harmType, timeframe = 1) {
        if (!nnh || nnh <= 0) return 0;

        // Annualize NNH if needed
        const annualNnh = nnh * timeframe;

        const severityWeight = this.OUTCOME_WEIGHTS[harmType] || 0.05;

        // Harm = (1/NNH) √ó severity √ó 100 patients
        const harmPer100 = (1 / annualNnh) * severityWeight * 100;

        return Math.max(0, harmPer100);
    },

    /**
     * Get baseline risk for an outcome based on patient data and risk calculators
     */
    getBaselineRisk: function(outcomeType, patientData, calculatedRisks) {
        switch (outcomeType) {
            // Cardiovascular outcomes
            case 'mace_composite':
            case 'mace':
            case 'cv_death':
                if (calculatedRisks.ascvd && calculatedRisks.ascvd.risk) {
                    return parseFloat(calculatedRisks.ascvd.risk) / 100 / 10; // Convert 10-yr to annual
                }
                return 0.02; // Default 2% annual

            case 'stroke_any':
            case 'stroke_disabling':
            case 'stroke':
                if (patientData.afib && calculatedRisks.chadsvasc) {
                    return calculatedRisks.chadsvasc.annualStrokeRisk / 100;
                }
                if (calculatedRisks.ascvd && calculatedRisks.ascvd.risk) {
                    return parseFloat(calculatedRisks.ascvd.risk) / 100 / 10 * 0.3; // ~30% of ASCVD is stroke
                }
                return 0.005; // Default 0.5% annual

            case 'mi_nonfatal':
            case 'mi_fatal':
            case 'mi':
                if (calculatedRisks.ascvd && calculatedRisks.ascvd.risk) {
                    return parseFloat(calculatedRisks.ascvd.risk) / 100 / 10 * 0.5; // ~50% of ASCVD is MI
                }
                return 0.01; // Default 1% annual

            // Heart failure outcomes
            case 'death':
            case 'all_cause_mortality':
            case 'mortality':
                if (patientData.ef && patientData.ef < 40) {
                    // HFrEF mortality based on Seattle model or estimate
                    if (calculatedRisks.seattleHF && calculatedRisks.seattleHF.survival1yr) {
                        return (100 - parseInt(calculatedRisks.seattleHF.survival1yr)) / 100;
                    }
                    return 0.15; // ~15% annual mortality in HFrEF
                }
                // General population mortality by age
                const ageMortality = {
                    40: 0.002, 50: 0.004, 60: 0.01, 70: 0.02, 80: 0.05, 90: 0.15
                };
                const age = patientData.age || 65;
                const ageKey = Math.min(90, Math.max(40, Math.floor(age / 10) * 10));
                return ageMortality[ageKey] || 0.02;

            case 'hf_hospitalization':
            case 'heart_failure_hospitalization':
            case 'hospitalization':
                if (patientData.ef && patientData.ef < 40) {
                    return 0.25; // ~25% annual HF hospitalization in HFrEF
                }
                if (patientData.chfHistory) {
                    return 0.15;
                }
                return 0.01;

            case 'cv_death_hf_hosp':
                if (patientData.ef && patientData.ef < 40) {
                    return 0.35; // Combined outcome in HFrEF
                }
                return 0.05;

            // Kidney outcomes
            case 'kidney_progression':
            case 'eskd_dialysis':
            case 'esrd':
                if (calculatedRisks.egfr) {
                    const egfr = calculatedRisks.egfr.egfr;
                    if (egfr < 30) return 0.10;
                    if (egfr < 45) return 0.05;
                    if (egfr < 60) return 0.02;
                }
                return 0.005;

            // Diabetes complications
            case 'blindness':
            case 'amputation':
                if (patientData.diabetesStatus === 'type2' || patientData.diabetesStatus === 'type1') {
                    const duration = patientData.diabetesDuration || 5;
                    return 0.005 + (duration * 0.001); // Increases with duration
                }
                return 0.001;

            default:
                return 0.01; // Default 1% for unknown outcomes
        }
    },

    /**
     * Main calculation: Net benefit for a medication
     *
     * @param {object} medication - Medication from database
     * @param {object} patientData - Patient characteristics
     * @param {object} calculatedRisks - Pre-calculated risk scores
     * @param {object} preferences - Patient preferences (goals of care, etc.)
     * @returns {object} Detailed net benefit calculation
     */
    calculateNetBenefit: function(medication, patientData, calculatedRisks, preferences) {
        const results = {
            medicationId: medication.id,
            medicationName: medication.name,
            medicationClass: medication.class,
            benefits: [],
            harms: [],
            totalBenefit: 0,
            totalHarm: 0,
            burdenPenalty: 0,
            netBenefit: 0,
            nntEquivalent: null,
            recommendation: '',
            applicableIndications: [],
            // Beers Criteria / elderly safety warnings
            beersWarning: null,
            elderlyCaution: null
        };

        // ========== CHECK BEERS CRITERIA / ELDERLY SAFETY ==========
        const elderlyCheck = this.checkElderlySafety(medication, patientData);
        results.beersWarning = elderlyCheck.beersWarning;
        results.elderlyCaution = elderlyCheck.elderlyCaution;

        // ========== ESTIMATE LIFE EXPECTANCY FOR COMPETING RISK ==========

        const lifeExpectancy = this.estimateLifeExpectancy(patientData, calculatedRisks);
        results.estimatedLifeExpectancy = lifeExpectancy;
        const userTimeHorizon = preferences.timeHorizon || 5;

        // ========== CALCULATE BENEFITS ==========

        // Check each indication and its benefits
        for (const [indication, outcomes] of Object.entries(medication.benefits)) {
            // Check if this indication applies to the patient
            const indicationApplies = this.checkIndicationApplies(indication, patientData, calculatedRisks);

            if (!indicationApplies.applies) continue;

            results.applicableIndications.push({
                indication: indication,
                reason: indicationApplies.reason
            });

            // Calculate benefit for each outcome
            for (const [outcomeName, outcomeData] of Object.entries(outcomes)) {
                // Skip non-RRR outcomes (like A1C reduction)
                if (!outcomeData.rrr && !outcomeData.nnt) continue;

                // Get baseline risk for this outcome
                const baselineRisk = this.getBaselineRisk(outcomeName, patientData, calculatedRisks);

                // Adjust for patient factors (adherence, etc.)
                const adjustmentFactor = this.getPatientAdjustmentFactor(patientData, medication, calculatedRisks, preferences);

                // Apply competing risk adjustment based on trial timeframe vs life expectancy
                const timeframe = outcomeData.timeframe || 1;
                const competingRiskFactor = this.getCompetingRiskFactor(timeframe, lifeExpectancy, userTimeHorizon);

                // Calculate expected benefit
                let expectedBenefit;

                if (outcomeData.nnt) {
                    expectedBenefit = this.calculateExpectedBenefit(
                        outcomeData.nnt,
                        null,
                        null,
                        outcomeName,
                        timeframe
                    );
                } else {
                    expectedBenefit = this.calculateExpectedBenefit(
                        null,
                        baselineRisk,
                        outcomeData.rrr * adjustmentFactor,
                        outcomeName,
                        1 // Already using annual baseline risk
                    );
                }

                // Apply competing risk reduction
                expectedBenefit *= competingRiskFactor;

                if (expectedBenefit > 0.001) { // Only include meaningful benefits
                    const severityWeight = this.OUTCOME_WEIGHTS[outcomeName] || 0.2;

                    // Calculate NNT for display
                    let displayNnt = outcomeData.nnt;
                    if (!displayNnt && baselineRisk && outcomeData.rrr) {
                        displayNnt = Math.round(1 / (baselineRisk * outcomeData.rrr));
                    }

                    results.benefits.push({
                        outcome: outcomeName,
                        indication: indication,
                        baselineRisk: baselineRisk,
                        rrr: outcomeData.rrr,
                        nnt: displayNnt,
                        timeframe: timeframe,
                        severityWeight: severityWeight,
                        expectedBenefit: expectedBenefit,
                        endpointQuality: outcomeData.quality || 'unknown'
                    });

                    results.totalBenefit += expectedBenefit;
                }
            }
        }

        // ========== CALCULATE HARMS (Using Risk Calculators When Available) ==========

        // Use HAS-BLED for bleeding risk on anticoagulants/antiplatelets
        const bleedingMedClasses = ['Direct Oral Anticoagulant (DOAC)', 'Vitamin K Antagonist', 'Antiplatelet'];
        const isBleedingRiskMed = bleedingMedClasses.some(c => medication.class.includes(c) || medication.class === c);

        if (isBleedingRiskMed && calculatedRisks.hasbled) {
            // Use HAS-BLED calculated bleeding risk instead of static NNH
            const annualBleedRisk = calculatedRisks.hasbled.annualBleedRisk / 100;
            const majorBleedSeverity = this.OUTCOME_WEIGHTS['major_bleeding'] || 0.15;
            const ichSeverity = this.OUTCOME_WEIGHTS['intracranial_bleeding'] || 0.6;

            // Major bleeding (most bleeds)
            const majorBleedHarm = annualBleedRisk * 0.85 * majorBleedSeverity * 100; // 85% of bleeds are non-ICH
            if (majorBleedHarm > 0.001) {
                results.harms.push({
                    harm: 'major_bleeding',
                    nnh: Math.round(100 / annualBleedRisk),
                    annualRisk: (annualBleedRisk * 100).toFixed(1) + '%',
                    timeframe: 1,
                    severityWeight: majorBleedSeverity,
                    expectedHarm: majorBleedHarm,
                    source: `HAS-BLED score ${calculatedRisks.hasbled.score}`
                });
                results.totalHarm += majorBleedHarm;
            }

            // ICH (about 10-15% of major bleeds on anticoagulation)
            const ichRisk = annualBleedRisk * 0.12;
            const ichHarm = ichRisk * ichSeverity * 100;
            if (ichHarm > 0.001) {
                results.harms.push({
                    harm: 'intracranial_bleeding',
                    nnh: Math.round(100 / ichRisk),
                    annualRisk: (ichRisk * 100).toFixed(2) + '%',
                    timeframe: 1,
                    severityWeight: ichSeverity,
                    expectedHarm: ichHarm,
                    source: `HAS-BLED score ${calculatedRisks.hasbled.score}`
                });
                results.totalHarm += ichHarm;
            }
        } else if (medication.harms) {
            // Use static NNH from medication database for non-bleeding harms
            for (const [harmName, harmData] of Object.entries(medication.harms)) {
                // Skip bleeding harms if we already calculated them above
                if (isBleedingRiskMed && (harmName.includes('bleeding') || harmName === 'major_bleeding' || harmName === 'intracranial_bleeding' || harmName === 'gi_bleeding')) {
                    continue;
                }

                if (!harmData.nnh) continue;

                const harmType = harmName;
                const severityWeight = this.OUTCOME_WEIGHTS[harmType] || 0.05;

                // Adjust NNH for patient factors
                const adjustedNnh = this.adjustNnhForPatient(harmData.nnh, harmName, patientData, calculatedRisks);
                const timeframe = harmData.timeframe || 1;

                const expectedHarm = this.calculateExpectedHarm(
                    adjustedNnh,
                    harmType,
                    timeframe
                );

                if (expectedHarm > 0.0001) {
                    results.harms.push({
                        harm: harmName,
                        nnh: adjustedNnh,
                        annualRisk: ((1 / adjustedNnh) * 100).toFixed(2) + '%',
                        timeframe: timeframe,
                        severityWeight: severityWeight,
                        expectedHarm: expectedHarm,
                        source: harmData.source || 'clinical trial'
                    });

                    results.totalHarm += expectedHarm;
                }
            }
        }

        // Add hypoglycemia risk for diabetes meds based on patient factors
        const hypoglycemiaMeds = ['Sulfonylurea'];
        if (hypoglycemiaMeds.some(c => medication.class.includes(c))) {
            let hypoRisk = 0.02; // 2% baseline severe hypoglycemia
            if (patientData.age >= 75) hypoRisk *= 2;
            if (calculatedRisks.egfr && calculatedRisks.egfr.egfr < 45) hypoRisk *= 1.5;

            const hypoSeverity = this.OUTCOME_WEIGHTS['severe_hypoglycemia'] || 0.05;
            const hypoHarm = hypoRisk * hypoSeverity * 100;

            if (hypoHarm > 0.001) {
                results.harms.push({
                    harm: 'severe_hypoglycemia',
                    nnh: Math.round(1 / hypoRisk),
                    annualRisk: (hypoRisk * 100).toFixed(1) + '%',
                    timeframe: 1,
                    severityWeight: hypoSeverity,
                    expectedHarm: hypoHarm,
                    source: 'Patient-adjusted estimate'
                });
                results.totalHarm += hypoHarm;
            }
        }

        // ========== CALCULATE BURDEN ==========

        let burdenLevel = medication.burden || 'moderate';

        // Adjust burden based on patient preferences
        if (preferences.pillBurdenTolerance === 'low') {
            burdenLevel = burdenLevel === 'low' ? 'moderate' :
                         burdenLevel === 'moderate' ? 'high' : 'high';
        }

        results.burdenLevel = burdenLevel;
        results.burdenPenalty = this.BURDEN_PENALTIES[burdenLevel] * 100; // per 100 patients
        results.burdenDetails = medication.burdenDetails || '';

        // Add cost penalty if cost-sensitive
        if (preferences.costSensitivity === 'high' && medication.annualCost > 2000) {
            results.burdenPenalty += 0.5; // Additional penalty for expensive meds
        } else if (preferences.costSensitivity === 'moderate' && medication.annualCost > 5000) {
            results.burdenPenalty += 0.3;
        }

        // ========== CALCULATE NET BENEFIT ==========
        // Net benefit = benefits - harms only (burden is displayed separately)

        results.totalBenefit = Math.round(results.totalBenefit * 1000) / 1000;
        results.totalHarm = Math.round(results.totalHarm * 1000) / 1000;
        results.netBenefit = results.totalBenefit - results.totalHarm;
        results.netBenefit = Math.round(results.netBenefit * 1000) / 1000;

        // Convert to NNT-equivalent (how many patients to treat for 1 year to get 1 QALY)
        if (results.netBenefit > 0) {
            results.nntEquivalent = Math.round(100 / results.netBenefit);
        }

        // ========== APPLY GOALS OF CARE THRESHOLD ==========

        // Thresholds for 4 goals of care levels (QALYs per 100 patients per year)
        const gocThresholds = {
            1: 3.0,   // Comfort-focused: need very high net benefit
            2: 1.0,   // Selective: need good net benefit
            3: 0.3,   // Balanced: need modest net benefit
            4: 0.0    // Proactive: accept any positive benefit
        };

        const gocNames = {
            1: 'Comfort-Focused',
            2: 'Selective',
            3: 'Balanced',
            4: 'Proactive'
        };

        const goc = preferences.goalsOfCare || 3;
        const threshold = gocThresholds[goc];
        results.gocName = gocNames[goc];
        results.gocThreshold = threshold;

        // Determine recommendation based on net benefit, burden, cost, and elderly safety
        const isHighBurden = (results.burdenLevel || 'low') === 'high';
        const isHighCost = medication.annualCost > 3000;

        // Check for Beers Criteria / elderly safety concerns
        const hasBeersWarning = results.beersWarning && results.beersWarning.listed;
        const hasHighSeverityElderlyWarning = results.elderlyCaution &&
            results.elderlyCaution.overallSeverity === 'high';
        const shouldAvoidInFrail = results.elderlyCaution && results.elderlyCaution.avoidRecommended;
        const isElderly = patientData.age >= 65;
        const isFrail = patientData.frailty;

        if (results.netBenefit < 0) {
            results.recommendation = 'not-recommended';
            results.recommendationText = 'Expected harms outweigh benefits';
        } else if (shouldAvoidInFrail) {
            // Strong recommendation to avoid in frail patients with high-risk medications
            results.recommendation = 'caution-elderly';
            results.recommendationText = 'Avoid in frail patients - high risk of adverse events (Beers Criteria)';
        } else if (hasBeersWarning && hasHighSeverityElderlyWarning && isElderly) {
            // Beers medication with high severity warnings in elderly
            if (results.netBenefit >= threshold && results.netBenefit >= 1.0) {
                // Still has meaningful benefit - recommend with strong caution
                results.recommendation = 'caution-elderly';
                results.recommendationText = 'Potential benefit but Beers Criteria medication - discuss safer alternatives';
            } else {
                // Marginal benefit + high risk = not recommended
                results.recommendation = 'not-recommended';
                results.recommendationText = 'Beers Criteria medication with limited benefit in this patient - avoid';
            }
        } else if (hasBeersWarning && isElderly) {
            // Beers medication with moderate concerns
            if (results.netBenefit >= threshold) {
                results.recommendation = 'caution-elderly';
                results.recommendationText = 'Beers Criteria medication - use lowest dose, monitor closely';
            } else {
                results.recommendation = 'marginal';
                results.recommendationText = 'Beers Criteria medication with limited benefit - consider alternatives';
            }
        } else if (results.netBenefit >= threshold) {
            // Meets threshold - but modify based on burden/cost/elderly caution
            if (results.netBenefit >= 3.0) {
                results.recommendation = 'strongly-recommended';
                results.recommendationText = 'High net benefit - strongly recommended';
            } else if (hasHighSeverityElderlyWarning && isElderly) {
                results.recommendation = 'consider';
                results.recommendationText = 'Good benefit but use caution in elderly - monitor closely';
            } else if (isHighBurden && goc <= 2) {
                results.recommendation = 'consider';
                results.recommendationText = 'Good benefit but high burden - discuss with your doctor';
            } else if (isHighCost && preferences.costSensitivity === 'high') {
                results.recommendation = 'consider';
                results.recommendationText = 'Good benefit but high cost - discuss alternatives';
            } else {
                results.recommendation = 'recommended';
                results.recommendationText = 'Net benefit meets your goals';
            }
        } else {
            // Below threshold
            if (results.netBenefit > 0) {
                results.recommendation = 'marginal';
                results.recommendationText = `Benefit below your ${gocNames[goc].toLowerCase()} threshold`;
            } else {
                results.recommendation = 'not-recommended';
                results.recommendationText = 'No net benefit expected';
            }
        }

        return results;
    },

    /**
     * Check if an indication applies to this patient
     */
    checkIndicationApplies: function(indication, patientData, calculatedRisks) {
        switch (indication) {
            case 'heart_failure':
            case 'heart_failure_symptoms':
                if (patientData.ef && patientData.ef < 50) {
                    return { applies: true, reason: 'EF < 50%' };
                }
                if (parseInt(patientData.nyha) >= 1) {
                    return { applies: true, reason: 'Heart failure symptoms' };
                }
                if (patientData.chfHistory) {
                    return { applies: true, reason: 'History of heart failure' };
                }
                return { applies: false };

            case 'heart_failure_severe':
                if (patientData.ef && patientData.ef < 30) {
                    return { applies: true, reason: 'Severe HFrEF (EF < 30%)' };
                }
                if (parseInt(patientData.nyha) >= 3) {
                    return { applies: true, reason: 'NYHA III-IV symptoms' };
                }
                return { applies: false };

            case 'afib_stroke_prevention':
                if (patientData.afib) {
                    return { applies: true, reason: 'Atrial fibrillation' };
                }
                return { applies: false };

            case 'diabetes':
            case 'diabetes_cv':
            case 'diabetes_glycemic':
                if (patientData.diabetesStatus === 'type2' || patientData.diabetesStatus === 'type1') {
                    return { applies: true, reason: 'Diabetes mellitus' };
                }
                return { applies: false };

            case 'diabetes_with_cvd':
                if ((patientData.diabetesStatus === 'type2' || patientData.diabetesStatus === 'type1') &&
                    (patientData.priorMI || patientData.priorStroke || patientData.pvd)) {
                    return { applies: true, reason: 'Diabetes with established CVD' };
                }
                return { applies: false };

            case 'secondary_prevention':
            case 'post_mi':
                if (patientData.priorMI || patientData.priorStroke || patientData.pvd) {
                    return { applies: true, reason: 'Established cardiovascular disease' };
                }
                return { applies: false };

            case 'post_mi_with_lv_dysfunction':
                if (patientData.priorMI && patientData.ef && patientData.ef < 40) {
                    return { applies: true, reason: 'Post-MI with LV dysfunction' };
                }
                return { applies: false };

            case 'primary_prevention_high_risk':
                if (!patientData.priorMI && !patientData.priorStroke) {
                    if (calculatedRisks.ascvd && parseFloat(calculatedRisks.ascvd.risk) >= 7.5) {
                        return { applies: true, reason: 'High CV risk (ASCVD ‚â•7.5%)' };
                    }
                }
                return { applies: false };

            case 'primary_prevention':
            case 'primary_prevention_low_risk':
                if (!patientData.priorMI && !patientData.priorStroke) {
                    return { applies: true, reason: 'Primary prevention' };
                }
                return { applies: false };

            case 'ckd':
                if (calculatedRisks.egfr && calculatedRisks.egfr.egfr < 60) {
                    return { applies: true, reason: 'CKD (eGFR < 60)' };
                }
                if (patientData.uacr && patientData.uacr > 30) {
                    return { applies: true, reason: 'Albuminuria' };
                }
                return { applies: false };

            case 'diabetic_nephropathy':
                if ((patientData.diabetesStatus === 'type2' || patientData.diabetesStatus === 'type1') &&
                    calculatedRisks.egfr && calculatedRisks.egfr.egfr < 60) {
                    return { applies: true, reason: 'Diabetic nephropathy' };
                }
                return { applies: false };

            case 'hypertension':
                if (patientData.htnTreatment || patientData.systolicBP >= 130) {
                    return { applies: true, reason: 'Hypertension' };
                }
                return { applies: false };

            case 'acs':
            case 'stroke_secondary_prevention':
                if (patientData.priorMI || patientData.priorStroke) {
                    return { applies: true, reason: 'Secondary prevention' };
                }
                return { applies: false };

            case 'mechanical_valve':
                if (patientData.mechanicalValve) {
                    return { applies: true, reason: 'Mechanical heart valve' };
                }
                return { applies: false };

            // Osteoporosis indications
            case 'osteoporosis':
            case 'osteoporosis_severe':
                if (patientData.osteoporosis) {
                    return { applies: true, reason: 'Osteoporosis' };
                }
                // High-risk patients even without diagnosis
                if (patientData.age >= 65 && patientData.sex === 'female') {
                    return { applies: true, reason: 'High fracture risk (age ‚â•65, female)' };
                }
                if (patientData.age >= 75) {
                    return { applies: true, reason: 'High fracture risk (age ‚â•75)' };
                }
                return { applies: false };

            // Gout
            case 'gout':
            case 'gout_flare_treatment':
                if (patientData.gout) {
                    return { applies: true, reason: 'Gout' };
                }
                return { applies: false };

            // CV prevention (for colchicine, low-dose rivaroxaban)
            case 'cv_prevention':
            case 'stable_cad':
            case 'stable_cad_pad':
                if (patientData.priorMI || patientData.pvd) {
                    return { applies: true, reason: 'Stable CAD or PAD' };
                }
                return { applies: false };

            case 'pad':
                if (patientData.pvd) {
                    return { applies: true, reason: 'Peripheral artery disease' };
                }
                return { applies: false };

            // Respiratory
            case 'asthma':
                if (patientData.asthma) {
                    return { applies: true, reason: 'Asthma' };
                }
                return { applies: false };

            case 'copd':
                if (patientData.copd) {
                    return { applies: true, reason: 'COPD' };
                }
                return { applies: false };

            // GERD/PPI indications
            case 'gerd':
            case 'peptic_ulcer':
            case 'gi_bleed_prevention':
                // PPI indicated if on dual antiplatelet or high bleeding risk + anticoagulation
                if (patientData.antiplatelet && (patientData.priorMI || patientData.priorStroke)) {
                    return { applies: true, reason: 'GI protection with antithrombotics' };
                }
                return { applies: false };

            // Lipid/CV additions
            case 'hyperlipidemia':
            case 'secondary_prevention_addon':
                if (patientData.priorMI || patientData.priorStroke || patientData.pvd) {
                    return { applies: true, reason: 'Secondary CV prevention' };
                }
                return { applies: false };

            case 'cv_prevention_high_tg':
                // Icosapent ethyl - on statin with high TG
                if (patientData.triglycerides && patientData.triglycerides >= 150 &&
                    (patientData.priorMI || patientData.priorStroke || patientData.diabetesStatus === 'type2')) {
                    return { applies: true, reason: 'Elevated TG with high CV risk' };
                }
                return { applies: false };

            // Diabetic kidney disease (finerenone)
            case 'diabetic_kidney_disease':
                if ((patientData.diabetesStatus === 'type2') &&
                    ((calculatedRisks.egfr && calculatedRisks.egfr.egfr < 60) || (patientData.uacr && patientData.uacr > 30))) {
                    return { applies: true, reason: 'Diabetic kidney disease' };
                }
                return { applies: false };

            // Neuropathic pain
            case 'neuropathic_pain':
                if (patientData.neuropathy || (patientData.diabetesStatus === 'type2' && patientData.diabetesDuration >= 5)) {
                    return { applies: true, reason: 'Neuropathic pain' };
                }
                return { applies: false };

            case 'fibromyalgia':
                if (patientData.fibromyalgia) {
                    return { applies: true, reason: 'Fibromyalgia' };
                }
                return { applies: false };

            case 'depression':
            case 'anxiety':
                if (patientData.depression) {
                    return { applies: true, reason: 'Depression/anxiety' };
                }
                return { applies: false };

            // Thyroid
            case 'hypothyroidism':
                if (patientData.hypothyroidism) {
                    return { applies: true, reason: 'Hypothyroidism' };
                }
                return { applies: false };

            // Vitamin D
            case 'vitamin_d_deficiency':
            case 'osteoporosis_adjunct':
            case 'fall_prevention':
                if (patientData.osteoporosis || patientData.age >= 65) {
                    return { applies: true, reason: 'Vitamin D supplementation indicated' };
                }
                return { applies: false };

            // Edema
            case 'edema':
                if (patientData.chfHistory || (patientData.ef && patientData.ef < 50)) {
                    return { applies: true, reason: 'Volume overload/edema' };
                }
                return { applies: false };

            // Angina
            case 'angina':
                if (patientData.priorMI || patientData.stableAngina) {
                    return { applies: true, reason: 'Angina/CAD' };
                }
                return { applies: false };

            // VTE
            case 'vte_treatment':
                if (patientData.vte) {
                    return { applies: true, reason: 'VTE treatment' };
                }
                return { applies: false };

            // Seizures (gabapentin/pregabalin)
            case 'seizures':
                if (patientData.seizures) {
                    return { applies: true, reason: 'Seizure disorder' };
                }
                return { applies: false };

            // Obesity (semaglutide/liraglutide)
            case 'obesity':
                if (patientData.weight && patientData.height) {
                    const bmi = patientData.weight / Math.pow(patientData.height / 100, 2);
                    if (bmi >= 30) {
                        return { applies: true, reason: 'Obesity (BMI ‚â•30)' };
                    }
                }
                return { applies: false };

            // Rate control for AFib
            case 'afib_rate_control':
                if (patientData.afib) {
                    return { applies: true, reason: 'AFib rate control' };
                }
                return { applies: false };

            // Resistant hypertension
            case 'resistant_hypertension':
                if (patientData.htnTreatment && patientData.systolicBP >= 140) {
                    return { applies: true, reason: 'Resistant hypertension' };
                }
                return { applies: false };

            default:
                return { applies: false };
        }
    },

    /**
     * Estimate life expectancy based on age, sex, and comorbidities
     * Returns estimated years of remaining life
     * Based on actuarial tables adjusted for health status
     */
    estimateLifeExpectancy: function(patientData, calculatedRisks = {}) {
        // Base life expectancy by age and sex (US Social Security actuarial tables, approximate)
        const baseLifeExpectancy = {
            male: { 50: 30, 55: 26, 60: 22, 65: 18, 70: 15, 75: 12, 80: 8, 85: 6, 90: 4, 95: 3 },
            female: { 50: 33, 55: 29, 60: 25, 65: 21, 70: 17, 75: 13, 80: 10, 85: 7, 90: 5, 95: 3 }
        };

        const age = patientData.age || 65;
        const sex = patientData.sex || 'male';
        const ageKey = Math.min(95, Math.max(50, Math.floor(age / 5) * 5));

        let lifeExp = baseLifeExpectancy[sex]?.[ageKey] || 15;

        // Adjust for comorbidities (multiplicative factors based on literature)

        // Heart failure - significant reduction
        if (patientData.ef && patientData.ef < 40) {
            lifeExp *= 0.5; // HFrEF roughly halves life expectancy
        } else if (patientData.chfHistory) {
            lifeExp *= 0.7;
        }

        // CKD
        if (calculatedRisks.egfr) {
            const egfr = calculatedRisks.egfr.egfr;
            if (egfr < 30) lifeExp *= 0.5;
            else if (egfr < 45) lifeExp *= 0.7;
            else if (egfr < 60) lifeExp *= 0.85;
        }

        // Active cancer
        if (patientData.cancer) {
            lifeExp *= 0.4; // Highly variable, but significant reduction on average
        }

        // Frailty
        if (patientData.frailty) {
            lifeExp *= 0.6;
        }

        // Dementia
        if (patientData.dementia) {
            lifeExp *= 0.5;
        }

        // COPD
        if (patientData.copd) {
            lifeExp *= 0.8;
        }

        // Prior CV events
        if (patientData.priorMI || patientData.priorStroke) {
            lifeExp *= 0.85;
        }

        // Diabetes
        if (patientData.diabetesStatus === 'type2' || patientData.diabetesStatus === 'type1') {
            lifeExp *= 0.9;
        }

        return Math.max(lifeExp, 0.5); // Minimum 6 months
    },

    /**
     * Get competing risk adjustment factor
     * Reduces benefit for medications with long time-to-benefit in patients with limited life expectancy
     * @param {number} trialTimeframe - Years over which benefit was demonstrated in trial
     * @param {number} lifeExpectancy - Estimated remaining years of life
     * @param {number} userTimeHorizon - User's selected time horizon for thinking about benefits
     */
    getCompetingRiskFactor: function(trialTimeframe, lifeExpectancy, userTimeHorizon) {
        // If life expectancy is shorter than trial timeframe, reduce benefit proportionally
        // Also consider user's selected time horizon

        const effectiveHorizon = Math.min(lifeExpectancy, userTimeHorizon || 10);

        if (effectiveHorizon >= trialTimeframe) {
            // Patient likely to live long enough to realize full benefit
            return 1.0;
        } else if (effectiveHorizon <= 1) {
            // Very limited life expectancy - minimal benefit from prevention
            return 0.2;
        } else {
            // Proportional reduction - assume benefit accrues linearly over trial period
            // (This is a simplification; some benefits are front-loaded, others back-loaded)
            return effectiveHorizon / trialTimeframe;
        }
    },

    /**
     * Get adjustment factor for patient characteristics (uses competing risk)
     */
    getPatientAdjustmentFactor: function(patientData, medication, calculatedRisks = {}, preferences = {}) {
        let factor = 1.0;

        // Reduce benefit if dementia (adherence concerns)
        if (patientData.dementia) {
            factor *= 0.7;
        }

        // Note: Competing risk adjustment is now applied per-outcome in calculateNetBenefit
        // based on trial timeframe and life expectancy

        return factor;
    },

    /**
     * Adjust NNH based on patient characteristics and risk calculators
     * Lower NNH = higher risk of harm
     */
    adjustNnhForPatient: function(baseNnh, harmType, patientData, calculatedRisks = {}) {
        let adjustedNnh = baseNnh;

        // Hyperkalemia - use eGFR to adjust risk
        if (harmType.includes('hyperkalemia')) {
            if (calculatedRisks.egfr) {
                const egfr = calculatedRisks.egfr.egfr;
                if (egfr < 30) adjustedNnh *= 0.3;      // Very high risk
                else if (egfr < 45) adjustedNnh *= 0.5; // High risk
                else if (egfr < 60) adjustedNnh *= 0.7; // Moderate risk
            }
            if (patientData.diabetesStatus) adjustedNnh *= 0.8;
        }

        // AKI - use eGFR
        if (harmType === 'aki') {
            if (calculatedRisks.egfr) {
                const egfr = calculatedRisks.egfr.egfr;
                if (egfr < 30) adjustedNnh *= 0.4;
                else if (egfr < 45) adjustedNnh *= 0.6;
            }
        }

        // Hypoglycemia - age and renal function
        if (harmType.includes('hypoglycemia')) {
            if (patientData.age >= 75) adjustedNnh *= 0.6;
            if (calculatedRisks.egfr && calculatedRisks.egfr.egfr < 45) adjustedNnh *= 0.7;
        }

        // New onset diabetes from statins - baseline glucose matters
        if (harmType === 'new_onset_diabetes') {
            if (patientData.a1c && patientData.a1c >= 5.7 && patientData.a1c < 6.5) {
                adjustedNnh *= 0.5; // Prediabetes - much higher risk
            }
        }

        return Math.max(adjustedNnh, 5); // NNH can't go below 5 (20% annual risk cap)
    },

    /**
     * Check for Beers Criteria and elderly safety concerns
     * Returns warnings and cautions for medications that may be inappropriate in elderly/frail patients
     *
     * Based on AGS Beers Criteria 2023 Update
     *
     * @param {object} medication - Medication from database
     * @param {object} patientData - Patient characteristics including age, frailty, etc.
     * @returns {object} { beersWarning, elderlyCaution }
     */
    checkElderlySafety: function(medication, patientData) {
        const result = {
            beersWarning: null,
            elderlyCaution: null
        };

        const age = patientData.age || 65;
        const isElderly = age >= 65;
        const isVeryElderly = age >= 75;
        const isFrail = patientData.frailty || false;
        const hasFallRisk = patientData.fallRisk || false;
        const hasCognitiveImpairment = patientData.dementia || false;
        const hasHeartFailure = patientData.chfHistory || (patientData.ef && patientData.ef < 50);

        // Check if medication has Beers Criteria information
        if (medication.beers_criteria && medication.beers_criteria.listed) {
            const beers = medication.beers_criteria;

            // Apply Beers warning for elderly patients
            if (isElderly) {
                result.beersWarning = {
                    listed: true,
                    concern: beers.concern,
                    recommendation: beers.recommendation,
                    strength: beers.strength,
                    qualityOfEvidence: beers.quality_of_evidence,
                    severity: beers.strength === 'strong' ? 'high' : 'moderate'
                };
            }
        }

        // Check elderly_caution flags
        if (medication.elderly_caution) {
            const caution = medication.elderly_caution;
            const warnings = [];

            // Fall risk medications
            if (caution.fall_risk && (isElderly || hasFallRisk)) {
                warnings.push({
                    type: 'fall_risk',
                    message: 'Increases fall risk',
                    applies: true,
                    severity: (isVeryElderly || hasFallRisk || isFrail) ? 'high' : 'moderate'
                });
            }

            // Cognitive impairment
            if (caution.cognitive_impairment && (isElderly || hasCognitiveImpairment)) {
                warnings.push({
                    type: 'cognitive',
                    message: 'May cause or worsen cognitive impairment',
                    applies: true,
                    severity: hasCognitiveImpairment ? 'high' : 'moderate'
                });
            }

            // Sedation
            if (caution.sedation && isElderly) {
                warnings.push({
                    type: 'sedation',
                    message: 'Causes sedation and CNS depression',
                    applies: true,
                    severity: (isVeryElderly || isFrail) ? 'high' : 'moderate'
                });
            }

            // Hypoglycemia risk
            if (caution.hypoglycemia_risk && isElderly) {
                warnings.push({
                    type: 'hypoglycemia',
                    message: 'High risk of severe hypoglycemia in elderly',
                    applies: true,
                    severity: (isVeryElderly || isFrail || hasCognitiveImpairment) ? 'high' : 'moderate'
                });
            }

            // Heart failure exacerbation
            if (caution.avoid_in_hf && hasHeartFailure) {
                warnings.push({
                    type: 'heart_failure',
                    message: 'May worsen heart failure (causes edema)',
                    applies: true,
                    severity: 'high'
                });
            }

            // Narrow therapeutic window
            if (caution.narrow_therapeutic_window && isElderly) {
                warnings.push({
                    type: 'toxicity',
                    message: 'Narrow therapeutic window - high toxicity risk in elderly',
                    applies: true,
                    severity: 'high'
                });
            }

            // Frailty-specific warnings
            if (caution.avoid_if_frail && isFrail) {
                warnings.push({
                    type: 'frailty',
                    message: 'Avoid in frail patients - high risk of adverse events',
                    applies: true,
                    severity: 'high'
                });
            }

            // Compile elderly caution result
            if (warnings.length > 0) {
                const highSeverityCount = warnings.filter(w => w.severity === 'high').length;
                result.elderlyCaution = {
                    hasWarnings: true,
                    warnings: warnings,
                    overallSeverity: highSeverityCount > 0 ? 'high' : 'moderate',
                    preferAlternatives: caution.prefer_alternatives || null,
                    requiresRenalAdjustment: caution.requires_renal_adjustment || false,
                    avoidRecommended: isFrail && caution.avoid_if_frail
                };
            }
        }

        return result;
    }
};

// Export
if (typeof module !== 'undefined' && module.exports) {
    module.exports = BenefitEngine;
}

/**
 * Main Application Logic
 */

// Global state
let patientData = {};
let calculatedRisks = {};
let currentSection = 1;

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    initializeEventListeners();
    initializeGoalsOfCare();
    initializeDiabetesFields();
});

/**
 * Set up event listeners
 */
function initializeEventListeners() {
    // Diabetes status changes
    const diabetesSelect = document.getElementById('diabetes-status');
    if (diabetesSelect) {
        diabetesSelect.addEventListener('change', function() {
            const diabetesFields = document.querySelectorAll('.diabetes-fields');
            const showFields = this.value === 'type2' || this.value === 'type1';
            diabetesFields.forEach(field => {
                field.style.display = showFields ? 'flex' : 'none';
            });
        });
    }
}

/**
 * Initialize Goals of Care selection
 */
function initializeGoalsOfCare() {
    const gocOptions = document.querySelectorAll('.goc-option');
    gocOptions.forEach(option => {
        option.addEventListener('click', function() {
            // Remove selected from all
            gocOptions.forEach(opt => opt.classList.remove('selected'));
            // Add selected to clicked
            this.classList.add('selected');
            // Store value
            document.getElementById('goc-value').value = this.dataset.value;
        });
    });
}

/**
 * Initialize diabetes-specific fields visibility
 */
function initializeDiabetesFields() {
    const diabetesSelect = document.getElementById('diabetes-status');
    if (diabetesSelect) {
        diabetesSelect.dispatchEvent(new Event('change'));
    }
}

/**
 * Navigate between sections
 */
function goToSection(sectionNum) {
    // Validate current section before moving forward
    if (sectionNum > currentSection && !validateCurrentSection()) {
        return;
    }

    // Collect data when leaving sections
    if (currentSection === 1) {
        collectRiskFactorData();
    } else if (currentSection === 2) {
        collectGoalsData();
    } else if (currentSection === 3) {
        collectMedicationData();
    }

    // Hide all sections
    document.querySelectorAll('.form-section').forEach(section => {
        section.classList.remove('active');
    });

    // Show target section
    const sectionIds = {
        1: 'section-risk-factors',
        2: 'section-goals',
        3: 'section-medications',
        4: 'section-results'
    };

    document.getElementById(sectionIds[sectionNum]).classList.add('active');

    // Update progress bar
    document.querySelectorAll('.progress-step').forEach((step, index) => {
        step.classList.remove('active', 'completed');
        if (index + 1 < sectionNum) {
            step.classList.add('completed');
        } else if (index + 1 === sectionNum) {
            step.classList.add('active');
        }
    });

    currentSection = sectionNum;

    // Scroll to top
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

/**
 * Validate current section has minimum required data
 */
function validateCurrentSection() {
    if (currentSection === 1) {
        const age = document.getElementById('age').value;
        const sex = document.getElementById('sex').value;
        if (!age || !sex) {
            alert('Please enter at least your age and sex to continue.');
            return false;
        }
    } else if (currentSection === 2) {
        const gocValue = document.getElementById('goc-value').value;
        if (!gocValue) {
            alert('Please select your treatment philosophy to continue.');
            return false;
        }
    }
    return true;
}

/**
 * Collect risk factor data from form
 */
function collectRiskFactorData() {
    patientData = {
        // Demographics
        age: parseInt(document.getElementById('age').value) || null,
        sex: document.getElementById('sex').value || null,
        race: document.getElementById('race').value || null,
        weight: parseFloat(document.getElementById('weight').value) || null,
        height: parseFloat(document.getElementById('height').value) || null,

        // CV Risk Factors
        systolicBP: parseInt(document.getElementById('systolic-bp').value) || null,
        diastolicBP: parseInt(document.getElementById('diastolic-bp').value) || null,
        totalCholesterol: parseInt(document.getElementById('total-cholesterol').value) || null,
        ldl: parseInt(document.getElementById('ldl').value) || null,
        hdl: parseInt(document.getElementById('hdl').value) || null,
        triglycerides: parseInt(document.getElementById('triglycerides').value) || null,
        htnTreatment: document.getElementById('htn-treatment').checked,
        smoker: document.getElementById('smoker').checked,
        formerSmoker: document.getElementById('former-smoker').checked,
        familyHxCAD: document.getElementById('family-hx-cad').checked,

        // Diabetes
        diabetesStatus: document.getElementById('diabetes-status').value,
        a1c: parseFloat(document.getElementById('a1c').value) || null,
        diabetesDuration: parseInt(document.getElementById('diabetes-duration').value) || null,
        fastingGlucose: parseInt(document.getElementById('fasting-glucose').value) || null,

        // Heart & Kidney
        ef: parseInt(document.getElementById('ef').value) || null,
        nyha: document.getElementById('nyha').value,
        creatinine: parseFloat(document.getElementById('creatinine').value) || null,
        egfr: parseInt(document.getElementById('egfr').value) || null,
        uacr: parseInt(document.getElementById('uacr').value) || null,
        bnp: parseInt(document.getElementById('bnp').value) || null,

        // AFib & Stroke
        afib: document.getElementById('afib').checked,
        priorStroke: document.getElementById('prior-stroke').checked,
        priorMI: document.getElementById('prior-mi').checked,
        pvd: document.getElementById('pvd').checked,
        chfHistory: document.getElementById('chf-history').checked,

        // Bleeding Risk
        priorBleed: document.getElementById('prior-bleed').checked,
        anemia: document.getElementById('anemia').checked,
        liverDisease: document.getElementById('liver-disease').checked,
        alcohol: document.getElementById('alcohol').checked,
        nsaidUse: document.getElementById('nsaid-use').checked,
        antiplatelet: document.getElementById('antiplatelet').checked,
        fallRisk: document.getElementById('fall-risk').checked,

        // Other
        copd: document.getElementById('copd').checked,
        osa: document.getElementById('osa').checked,
        depression: document.getElementById('depression').checked,
        dementia: document.getElementById('dementia').checked,
        cancer: document.getElementById('cancer').checked,
        frailty: document.getElementById('frailty').checked,
        osteoporosis: document.getElementById('osteoporosis').checked,
        gout: document.getElementById('gout').checked,
        asthma: document.getElementById('asthma').checked,
        neuropathy: document.getElementById('neuropathy').checked,
        hypothyroidism: document.getElementById('hypothyroidism').checked,
        fibromyalgia: document.getElementById('fibromyalgia').checked
    };

    // Calculate eGFR if not provided
    if (!patientData.egfr && patientData.creatinine && patientData.age) {
        const egfrResult = RiskCalculators.calculateEGFR(patientData);
        if (egfrResult) {
            patientData.egfr = egfrResult.egfr;
        }
    }
}

/**
 * Collect goals of care data
 */
function collectGoalsData() {
    patientData.goalsOfCare = parseInt(document.getElementById('goc-value').value) || 3;
    patientData.timeHorizon = parseInt(document.getElementById('time-horizon').value) || 5;
    patientData.pillBurdenTolerance = document.getElementById('pill-burden').value || 'moderate';
    patientData.costSensitivity = document.getElementById('cost-sensitivity').value || 'moderate';
    patientData.monitoringTolerance = document.getElementById('monitoring-tolerance').value || 'moderate';
}

/**
 * Collect current medications
 */
function collectMedicationData() {
    patientData.currentMedications = [];
    document.querySelectorAll('[data-med]:checked').forEach(checkbox => {
        patientData.currentMedications.push(checkbox.dataset.med);
    });
}

/**
 * Calculate results and display
 */
function calculateResults() {
    // Collect any remaining data
    collectMedicationData();

    // Calculate all risks
    calculatedRisks = RiskCalculators.calculateAllRisks(patientData);

    // Move to results section
    goToSection(4);

    // Display results
    displayGoalsSummary();
    displayRiskSummary();
    displayCurrentMedAnalysis();
    displayPotentialMedications();
}

/**
 * Display goals of care summary at top of results
 */
function displayGoalsSummary() {
    const container = document.getElementById('goals-summary');
    const preferences = getPreferences();

    const gocNames = {
        1: 'Comfort-Focused',
        2: 'Selective',
        3: 'Balanced',
        4: 'Proactive'
    };

    const gocDescriptions = {
        1: 'You prefer quality of life now and only want medications with very high proven benefit.',
        2: 'You want high-value treatments only, avoiding medications where burden outweighs benefit.',
        3: 'You want reasonable prevention, accepting some burden for meaningful benefits.',
        4: 'You want to maximize prevention and are willing to take medications with any proven benefit.'
    };

    const gocThresholds = {
        1: 3.0,
        2: 1.0,
        3: 0.3,
        4: 0.0
    };

    const goc = preferences.goalsOfCare || 3;
    const gocClass = ['comfort', 'selective', 'balanced', 'proactive'][goc - 1];

    let costText = '';
    if (preferences.costSensitivity === 'high') {
        costText = ' Cost is an important consideration for you.';
    }

    container.innerHTML = `
        <div class="goals-summary-content">
            <div class="goals-badge ${gocClass}">${gocNames[goc]}</div>
            <p>${gocDescriptions[goc]}${costText}</p>
            <p class="goals-threshold">Medications need a net benefit of at least <strong>${gocThresholds[goc]} QALYs per 100 patients per year</strong> to be recommended for you.</p>
        </div>
    `;
}

/**
 * Display risk summary
 */
function displayRiskSummary() {
    const container = document.getElementById('risk-summary');
    let html = '';

    // ASCVD Risk
    if (calculatedRisks.ascvd && calculatedRisks.ascvd.risk) {
        const risk = parseFloat(calculatedRisks.ascvd.risk);
        const riskClass = risk >= 20 ? 'high' : risk >= 7.5 ? 'moderate' : 'low';
        html += `
            <div class="risk-item ${riskClass}">
                <div class="risk-label">10-Year CV Risk (ASCVD)</div>
                <div class="risk-value">${calculatedRisks.ascvd.risk}%</div>
                <div class="risk-interpretation">${calculatedRisks.ascvd.interpretation}</div>
            </div>
        `;
    }

    // CHA2DS2-VASc (if AFib)
    if (calculatedRisks.chadsvasc) {
        const score = calculatedRisks.chadsvasc.score;
        const riskClass = score >= 2 ? 'high' : score === 1 ? 'moderate' : 'low';
        html += `
            <div class="risk-item ${riskClass}">
                <div class="risk-label">CHA‚ÇÇDS‚ÇÇ-VASc Score</div>
                <div class="risk-value">${score}</div>
                <div class="risk-interpretation">Annual stroke risk: ${calculatedRisks.chadsvasc.annualStrokeRisk}%</div>
            </div>
        `;
    }

    // HAS-BLED (if AFib)
    if (calculatedRisks.hasbled) {
        const score = calculatedRisks.hasbled.score;
        const riskClass = score >= 3 ? 'high' : 'moderate';
        html += `
            <div class="risk-item ${riskClass}">
                <div class="risk-label">HAS-BLED Score</div>
                <div class="risk-value">${score}</div>
                <div class="risk-interpretation">Annual bleed risk: ${calculatedRisks.hasbled.annualBleedRisk}%</div>
            </div>
        `;
    }

    // Heart Failure Survival
    if (calculatedRisks.seattleHF && calculatedRisks.seattleHF.survival1yr) {
        const surv = parseInt(calculatedRisks.seattleHF.survival1yr);
        const riskClass = surv >= 85 ? 'low' : surv >= 70 ? 'moderate' : 'high';
        html += `
            <div class="risk-item ${riskClass}">
                <div class="risk-label">HF 1-Year Survival</div>
                <div class="risk-value">${surv}%</div>
                <div class="risk-interpretation">${calculatedRisks.seattleHF.interpretation}</div>
            </div>
        `;
    }

    // eGFR
    if (calculatedRisks.egfr) {
        const egfr = calculatedRisks.egfr.egfr;
        const riskClass = egfr >= 60 ? 'low' : egfr >= 30 ? 'moderate' : 'high';
        html += `
            <div class="risk-item ${riskClass}">
                <div class="risk-label">Kidney Function (eGFR)</div>
                <div class="risk-value">${egfr}</div>
                <div class="risk-interpretation">${calculatedRisks.egfr.stage}</div>
            </div>
        `;
    }

    // Diabetes risks
    if (calculatedRisks.ukpds) {
        const chdRisk = parseFloat(calculatedRisks.ukpds.chdRisk);
        const riskClass = chdRisk >= 20 ? 'high' : chdRisk >= 10 ? 'moderate' : 'low';
        html += `
            <div class="risk-item ${riskClass}">
                <div class="risk-label">10-Year CHD Risk (UKPDS)</div>
                <div class="risk-value">${chdRisk}%</div>
                <div class="risk-interpretation">Diabetes-related heart disease risk</div>
            </div>
        `;
    }

    container.innerHTML = html || '<p>Enter more health information to calculate your risk profile.</p>';
}

/**
 * Prepare preferences object for benefit engine
 */
function getPreferences() {
    return {
        goalsOfCare: patientData.goalsOfCare || 3,
        timeHorizon: patientData.timeHorizon || 5,
        pillBurdenTolerance: patientData.pillBurdenTolerance || 'moderate',
        costSensitivity: patientData.costSensitivity || 'moderate',
        monitoringTolerance: patientData.monitoringTolerance || 'moderate'
    };
}

/**
 * Display analysis of current medications
 */
function displayCurrentMedAnalysis() {
    const container = document.getElementById('current-meds-analysis');
    const preferences = getPreferences();

    if (!patientData.currentMedications || patientData.currentMedications.length === 0) {
        container.innerHTML = '<p>No current medications selected.</p>';
        return;
    }

    let html = '';
    try {
        const analyses = patientData.currentMedications
            .map(medId => {
                const med = getMedication(medId);
                if (!med) {
                    console.warn('Medication not found:', medId);
                    return null;
                }
                try {
                    return BenefitEngine.calculateNetBenefit(med, patientData, calculatedRisks, preferences);
                } catch (e) {
                    console.error('Error calculating benefit for', medId, e);
                    return null;
                }
            })
            .filter(a => a !== null)
            .sort((a, b) => b.netBenefit - a.netBenefit);

        analyses.forEach(analysis => {
            html += renderMedicationResult(analysis, true);
        });
    } catch (e) {
        console.error('Error in displayCurrentMedAnalysis:', e);
        html = '<p>Error analyzing medications. Check console for details.</p>';
    }

    container.innerHTML = html || '<p>No medications could be analyzed.</p>';
}

/**
 * Display potential medications to consider - best in each class only
 */
function displayPotentialMedications() {
    const container = document.getElementById('potential-meds');
    const preferences = getPreferences();

    try {
        const allMeds = getAllMedications();
        const currentMedIds = patientData.currentMedications || [];

        // Get classes of medications the patient is already taking
        const currentClasses = new Set();
        currentMedIds.forEach(medId => {
            const med = getMedication(medId);
            if (med) currentClasses.add(med.class);
        });

        // Calculate benefits for all medications not currently being taken
        const allAnalyses = allMeds
            .filter(med => !currentMedIds.includes(med.id))
            .map(med => BenefitEngine.calculateNetBenefit(med, patientData, calculatedRisks, preferences))
            .filter(a => a !== null && a.netBenefit > 0 && a.applicableIndications.length > 0);

        // Group by class and pick the best in each class
        const bestByClass = {};
        allAnalyses.forEach(analysis => {
            const medClass = analysis.medicationClass;
            if (!bestByClass[medClass] || analysis.netBenefit > bestByClass[medClass].netBenefit) {
                bestByClass[medClass] = analysis;
            }
        });

        // Convert to array, sort by benefit, and filter
        let potentialMeds = Object.values(bestByClass)
            .sort((a, b) => b.netBenefit - a.netBenefit);

        // Separate into new classes vs. potential switches
        const newClassMeds = potentialMeds.filter(a => !currentClasses.has(a.medicationClass));
        const switchMeds = potentialMeds.filter(a => currentClasses.has(a.medicationClass));

        let html = '';

        // Show new class recommendations first
        if (newClassMeds.length > 0) {
            html += '<div class="potential-section"><h4>New Medications to Consider</h4>';
            newClassMeds.slice(0, 5).forEach(analysis => {
                html += renderMedicationResult(analysis, false);
            });
            html += '</div>';
        }

        // Show potential switches if there are better options in the same class
        if (switchMeds.length > 0) {
            // Check if the switch is actually better than what they're taking
            const worthwhileSwitches = switchMeds.filter(analysis => {
                // Find current med in same class
                const currentInClass = currentMedIds.find(medId => {
                    const med = getMedication(medId);
                    return med && med.class === analysis.medicationClass;
                });
                if (currentInClass) {
                    const currentMed = getMedication(currentInClass);
                    const currentAnalysis = BenefitEngine.calculateNetBenefit(currentMed, patientData, calculatedRisks, preferences);
                    // Only suggest switch if significantly better (>0.5 QALY improvement)
                    return currentAnalysis && (analysis.netBenefit - currentAnalysis.netBenefit) > 0.5;
                }
                return false;
            });

            if (worthwhileSwitches.length > 0) {
                html += '<div class="potential-section"><h4>Potential Switches Within Class</h4>';
                html += '<p class="switch-note">These may offer better benefit than your current medication in the same class</p>';
                worthwhileSwitches.forEach(analysis => {
                    html += renderMedicationResult(analysis, false, false, true);
                });
                html += '</div>';
            }
        }

        if (html === '') {
            html = '<p>No additional high-benefit medications identified based on your profile and goals.</p>';
        }

        container.innerHTML = html;
    } catch (e) {
        console.error('Error in displayPotentialMedications:', e);
        container.innerHTML = '<p>Error analyzing potential medications.</p>';
    }
}

/**
 * Generate unique ID for medication cards
 */
let medCardCounter = 0;

/**
 * Render a medication result card - simplified, intuitive design
 * @param {object} analysis - The medication analysis
 * @param {boolean} isCurrent - Whether this is a current medication
 * @param {boolean} isDeprescribe - Deprecated, kept for compatibility
 * @param {boolean} isSwitch - Whether this is a potential switch from current med
 */
function renderMedicationResult(analysis, isCurrent, isDeprescribe = false, isSwitch = false) {
    const netBenefit = analysis.netBenefit;
    const cardId = `med-card-${medCardCounter++}`;

    // Determine recommendation status and icon
    let statusClass, statusIcon, statusText;
    const rec = analysis.recommendation;

    if (rec === 'strongly-recommended') {
        statusClass = 'status-strong';
        statusIcon = '++';
        statusText = 'Strongly Recommended';
    } else if (rec === 'recommended') {
        statusClass = 'status-recommended';
        statusIcon = '+';
        statusText = 'Recommended';
    } else if (rec === 'consider') {
        statusClass = 'status-consider';
        statusIcon = '?';
        statusText = 'Consider';
    } else if (rec === 'caution-elderly') {
        statusClass = 'status-caution-elderly';
        statusIcon = '!';
        statusText = 'Caution - Beers Criteria';
    } else if (rec === 'marginal') {
        statusClass = 'status-marginal';
        statusIcon = '-';
        statusText = 'Marginal Benefit';
    } else {
        statusClass = 'status-not-recommended';
        statusIcon = 'X';
        statusText = 'Not Recommended';
    }

    // Get medication details
    const med = getMedication(analysis.medicationId);
    const burdenLevel = analysis.burdenLevel || 'low';
    const costDisplay = med ? `$${med.annualCost}/yr` : '';

    // Get purpose info
    const purpose = med ? med.purpose : 'disease_modifying';
    const purposeInfo = PURPOSE_INFO[purpose] || PURPOSE_INFO.disease_modifying;
    const purposeLabel = purposeInfo.shortLabel;

    // Create simple benefit/harm summary
    const benefitOutcomes = analysis.benefits.map(b => formatOutcomeName(b.outcome)).slice(0, 2);
    const benefitSummary = benefitOutcomes.length > 0 ? benefitOutcomes.join(', ') : 'No applicable benefits';

    // Build expandable details section
    let detailsHtml = '<div class="details-content">';

    // Benefits detail
    if (analysis.benefits.length > 0) {
        detailsHtml += '<div class="detail-section benefits-detail"><h5>Benefits</h5><ul>';
        analysis.benefits.forEach(b => {
            const nntDisplay = b.nnt ? `NNT ${b.nnt}` : `${((b.rrr || 0) * 100).toFixed(0)}% reduction`;
            detailsHtml += `<li><strong>${formatOutcomeName(b.outcome)}</strong>: ${nntDisplay} ‚Üí +${b.expectedBenefit.toFixed(2)} QALYs</li>`;
        });
        detailsHtml += '</ul></div>';
    }

    // Harms detail
    if (analysis.harms.length > 0) {
        detailsHtml += '<div class="detail-section harms-detail"><h5>Serious Risks</h5><ul>';
        analysis.harms.forEach(h => {
            detailsHtml += `<li><strong>${formatOutcomeName(h.harm)}</strong>: NNH ${h.nnh} (${h.annualRisk}/yr) ‚Üí ‚àí${h.expectedHarm.toFixed(2)} QALYs</li>`;
        });
        detailsHtml += '</ul></div>';
    } else {
        detailsHtml += '<div class="detail-section harms-detail"><h5>Serious Risks</h5><p>No significant serious harms identified from trial data.</p></div>';
    }

    // Burden detail
    detailsHtml += `<div class="detail-section burden-detail"><h5>Burden</h5><p>${analysis.burdenDetails || 'No specific burden information.'}</p></div>`;

    // Net calculation
    detailsHtml += `<div class="detail-section calc-detail"><h5>Calculation</h5>
        <p>Benefit (+${analysis.totalBenefit.toFixed(2)}) - Harm (${analysis.totalHarm.toFixed(2)}) = <strong>${netBenefit.toFixed(2)} QALYs</strong> per 100 patients per year</p>
    </div>`;

    detailsHtml += '</div>';

    // Beers Criteria / Elderly Safety Warning
    let beersWarningHtml = '';
    if (analysis.beersWarning && analysis.beersWarning.listed) {
        beersWarningHtml = `
            <div class="beers-warning">
                <div class="beers-warning-header">Beers Criteria Medication</div>
                <div class="beers-warning-content">${analysis.beersWarning.concern}</div>
                <div class="beers-warning-recommendation">${analysis.beersWarning.recommendation}</div>
            </div>
        `;
    } else if (analysis.elderlyCaution && analysis.elderlyCaution.hasWarnings) {
        const warningsList = analysis.elderlyCaution.warnings
            .map(w => `<li class="severity-${w.severity}">${w.message}</li>`)
            .join('');
        beersWarningHtml = `
            <div class="beers-warning">
                <div class="beers-warning-header">Elderly Caution</div>
                <ul class="elderly-caution-list">${warningsList}</ul>
            </div>
        `;
    }

    // Build the card
    return `
        <div class="med-card ${statusClass}" id="${cardId}">
            <div class="med-card-header" onclick="toggleDetails('${cardId}')">
                <div class="med-status-icon">${statusIcon}</div>
                <div class="med-main-info">
                    <div class="med-name">${analysis.medicationName}</div>
                    <div class="med-class">${analysis.medicationClass}</div>
                </div>
                <div class="med-quick-stats">
                    <div class="med-net-benefit">${netBenefit >= 0 ? '+' : ''}${netBenefit.toFixed(1)}</div>
                    <div class="med-net-label">net benefit</div>
                </div>
                <div class="med-tags">
                    <span class="tag purpose-${purpose}" title="${purposeInfo.description}">${purposeLabel}</span>
                    <span class="tag burden-${burdenLevel}">${burdenLevel}</span>
                    <span class="tag cost-tag">${costDisplay}</span>
                </div>
                <div class="expand-arrow">‚ñº</div>
            </div>
            <div class="med-card-summary">
                <span class="status-text">${statusText}</span>
                <span class="benefit-for">${benefitSummary}</span>
            </div>
            ${beersWarningHtml}
            <div class="med-card-details" id="${cardId}-details" style="display: none;">
                ${detailsHtml}
            </div>
        </div>
    `;
}

/**
 * Toggle calculation details visibility
 */
function toggleDetails(cardId) {
    const details = document.getElementById(`${cardId}-details`);
    const card = document.getElementById(cardId);

    if (details.style.display === 'none') {
        details.style.display = 'block';
        card.classList.add('expanded');
    } else {
        details.style.display = 'none';
        card.classList.remove('expanded');
    }
}

/**
 * Format outcome name for display
 */
function formatOutcomeName(name) {
    const mapping = {
        'death': 'Death',
        'all_cause_mortality': 'All-cause mortality',
        'cv_death': 'CV death',
        'mortality': 'Mortality',
        'stroke_any': 'Stroke',
        'stroke_disabling': 'Disabling stroke',
        'mi_nonfatal': 'Heart attack (MI)',
        'mi_fatal': 'Fatal MI',
        'hf_hospitalization': 'HF hospitalization',
        'heart_failure_hospitalization': 'HF hospitalization',
        'cv_death_hf_hosp': 'CV death/HF hospitalization',
        'hospitalization': 'Hospitalization',
        'mace': 'Major CV events',
        'mace_composite': 'Major CV events',
        'stroke': 'Stroke',
        'kidney_progression': 'Kidney disease progression',
        'major_bleeding': 'Major bleeding',
        'intracranial_bleeding': 'Brain bleeding',
        'gi_bleeding': 'GI bleeding',
        'hypoglycemia': 'Low blood sugar',
        'hypotension': 'Low blood pressure',
        'hyperkalemia': 'High potassium',
        'genital_mycotic_infection': 'Yeast infection',
        'uti': 'Urinary infection',
        'dka': 'Diabetic ketoacidosis',
        'gynecomastia': 'Breast enlargement',
        'myalgia': 'Muscle pain',
        'fatigue': 'Fatigue',
        'bradycardia': 'Slow heart rate',
        'weight_gain': 'Weight gain',
        'gi_side_effects': 'GI upset',
        'angioedema': 'Severe swelling'
    };
    return mapping[name] || name.replace(/_/g, ' ');
}

/**
 * Print results
 */
function printResults() {
    window.print();
}

// ============================================
// AI IMPORT FUNCTIONALITY
// ============================================

/**
 * Initialize AI Import tabs
 */
document.addEventListener('DOMContentLoaded', function() {
    initializeAIImportTabs();
});

function initializeAIImportTabs() {
    const tabs = document.querySelectorAll('.ai-tab');
    tabs.forEach(tab => {
        tab.addEventListener('click', function() {
            const tabName = this.dataset.tab;

            // Update active tab
            tabs.forEach(t => t.classList.remove('active'));
            this.classList.add('active');

            // Update active content
            document.querySelectorAll('.ai-tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabName}-tab`).classList.add('active');
        });
    });
}

/**
 * Copy EMR prompt to clipboard
 */
function copyEMRPrompt() {
    const promptText = document.getElementById('emr-prompt-text').textContent;
    navigator.clipboard.writeText(promptText).then(() => {
        const btn = document.querySelector('.copy-prompt-btn');
        btn.textContent = '‚úì Copied!';
        btn.classList.add('copied');
        setTimeout(() => {
            btn.textContent = 'üìã Copy Prompt';
            btn.classList.remove('copied');
        }, 2000);
    }).catch(err => {
        console.error('Failed to copy:', err);
        alert('Failed to copy prompt. Please select and copy manually.');
    });
}

/**
 * Clear paste input
 */
function clearPasteInput() {
    document.getElementById('ai-paste-input').value = '';
    const statusDiv = document.getElementById('ai-extract-status');
    statusDiv.className = 'ai-extract-status';
    statusDiv.textContent = '';
}

/**
 * Extract data from pasted text and fill form
 */
function extractFromPaste() {
    const inputText = document.getElementById('ai-paste-input').value.trim();
    const statusDiv = document.getElementById('ai-extract-status');

    if (!inputText) {
        statusDiv.className = 'ai-extract-status error';
        statusDiv.textContent = 'Please paste some text to extract data from.';
        return;
    }

    // Try to parse as JSON first
    let extractedData = null;

    try {
        // Check if it looks like JSON
        if (inputText.startsWith('{') || inputText.startsWith('[')) {
            extractedData = JSON.parse(inputText);
            statusDiv.className = 'ai-extract-status info';
            statusDiv.textContent = 'JSON detected. Processing...';
        }
    } catch (e) {
        // Not valid JSON, will try text extraction
    }

    if (extractedData) {
        // Process JSON data
        fillFormFromExtractedData(extractedData);
        statusDiv.className = 'ai-extract-status success';
        statusDiv.textContent = '‚úì Data extracted and form populated! Please review the values below.';
    } else {
        // Try simple text extraction for non-JSON input
        const textExtracted = extractFromPlainText(inputText);
        if (textExtracted) {
            fillFormFromExtractedData(textExtracted);
            statusDiv.className = 'ai-extract-status success';
            statusDiv.textContent = '‚úì Text parsed and form populated! Please review the values below.';
        } else {
            statusDiv.className = 'ai-extract-status error';
            statusDiv.textContent = 'Could not parse the input. Please paste valid JSON from the EMR AI, or try structured clinical notes.';
        }
    }
}

/**
 * Extract data from plain text (simple pattern matching)
 */
function extractFromPlainText(text) {
    const data = {};
    const textLower = text.toLowerCase();

    // Age extraction
    const ageMatch = text.match(/(?:age|aged?)[\s:]+(\d+)/i) || text.match(/(\d+)\s*(?:year|yr|yo|y\/o)/i);
    if (ageMatch) data.age = parseInt(ageMatch[1]);

    // Sex extraction
    if (textLower.includes('male') && !textLower.includes('female')) data.sex = 'male';
    else if (textLower.includes('female')) data.sex = 'female';

    // Blood pressure
    const bpMatch = text.match(/(?:bp|blood pressure)[\s:]*(\d+)\s*\/\s*(\d+)/i);
    if (bpMatch) {
        data.systolic_bp = parseInt(bpMatch[1]);
        data.diastolic_bp = parseInt(bpMatch[2]);
    }

    // Labs
    const a1cMatch = text.match(/(?:hba1c|a1c|hemoglobin a1c)[\s:]*(\d+\.?\d*)/i);
    if (a1cMatch) data.a1c = parseFloat(a1cMatch[1]);

    const crMatch = text.match(/(?:creatinine|cr)[\s:]*(\d+\.?\d*)/i);
    if (crMatch) data.creatinine = parseFloat(crMatch[1]);

    const egfrMatch = text.match(/(?:egfr|gfr)[\s:]*(\d+)/i);
    if (egfrMatch) data.egfr = parseInt(egfrMatch[1]);

    const efMatch = text.match(/(?:ejection fraction|ef|lvef)[\s:]*(\d+)/i);
    if (efMatch) data.ef = parseInt(efMatch[1]);

    // Total cholesterol, LDL, HDL
    const tcMatch = text.match(/(?:total cholesterol|tc)[\s:]*(\d+)/i);
    if (tcMatch) data.total_cholesterol = parseInt(tcMatch[1]);

    const ldlMatch = text.match(/ldl[\s:]*(\d+)/i);
    if (ldlMatch) data.ldl = parseInt(ldlMatch[1]);

    const hdlMatch = text.match(/hdl[\s:]*(\d+)/i);
    if (hdlMatch) data.hdl = parseInt(hdlMatch[1]);

    // Conditions
    data.conditions = {};
    if (/(?:atrial fib|afib|a\-?fib|af(?:\s|$))/i.test(text)) data.conditions.afib = true;
    if (/(?:heart failure|hf|chf|hfref|hfpef)/i.test(text)) data.conditions.heart_failure = true;
    if (/(?:type 2 diabetes|t2dm|dm2|type ii)/i.test(text)) data.conditions.diabetes_type2 = true;
    if (/(?:hypertension|htn)/i.test(text)) data.conditions.hypertension = true;
    if (/(?:prior stroke|cva|tia)/i.test(text)) data.conditions.prior_stroke = true;
    if (/(?:prior mi|myocardial infarction|heart attack)/i.test(text)) data.conditions.prior_mi = true;
    if (/(?:ckd|chronic kidney|renal disease)/i.test(text)) data.conditions.ckd = true;
    if (/(?:copd|chronic obstructive)/i.test(text)) data.conditions.copd = true;
    if (/(?:dementia|cognitive impairment|alzheimer)/i.test(text)) data.conditions.dementia = true;
    if (/(?:osteoporosis|osteopenia|low bone density|t\-?score)/i.test(text)) data.conditions.osteoporosis = true;
    if (/(?:gout|hyperuricemia|uric acid)/i.test(text)) data.conditions.gout = true;
    if (/(?:asthma)/i.test(text)) data.conditions.asthma = true;
    if (/(?:neuropathy|peripheral neuropathy|diabetic neuropathy)/i.test(text)) data.conditions.neuropathy = true;
    if (/(?:hypothyroid|hashimoto|low thyroid)/i.test(text)) data.conditions.hypothyroidism = true;
    if (/(?:fibromyalgia)/i.test(text)) data.conditions.fibromyalgia = true;
    if (/(?:depression|anxiety|mdd|gad)/i.test(text)) data.conditions.depression = true;
    if (/(?:frail|debilitated|poor functional)/i.test(text)) data.conditions.frailty = true;
    if (/(?:cancer|malignancy|oncology)/i.test(text)) data.conditions.cancer = true;
    if (/(?:pvd|pad|peripheral artery|claudication)/i.test(text)) data.conditions.pvd = true;

    // Medications - look for common medication names
    data.medications = [];
    const medPatterns = [
        // Cardiovascular
        { pattern: /(?:metformin|glucophage)/i, med: 'metformin' },
        { pattern: /(?:apixaban|eliquis)/i, med: 'apixaban' },
        { pattern: /(?:rivaroxaban|xarelto)/i, med: 'rivaroxaban' },
        { pattern: /(?:dabigatran|pradaxa)/i, med: 'dabigatran' },
        { pattern: /(?:edoxaban|savaysa)/i, med: 'edoxaban' },
        { pattern: /(?:warfarin|coumadin)/i, med: 'warfarin' },
        { pattern: /(?:atorvastatin|lipitor)/i, med: 'atorvastatin' },
        { pattern: /(?:rosuvastatin|crestor)/i, med: 'rosuvastatin' },
        { pattern: /(?:simvastatin|zocor)/i, med: 'simvastatin' },
        { pattern: /(?:ezetimibe|zetia)/i, med: 'ezetimibe' },
        { pattern: /(?:lisinopril|zestril|prinivil)/i, med: 'lisinopril' },
        { pattern: /(?:enalapril|vasotec)/i, med: 'enalapril' },
        { pattern: /(?:losartan|cozaar)/i, med: 'losartan' },
        { pattern: /(?:valsartan|diovan)/i, med: 'valsartan' },
        { pattern: /(?:metoprolol|toprol)/i, med: 'metoprolol' },
        { pattern: /(?:carvedilol|coreg)/i, med: 'carvedilol' },
        { pattern: /(?:bisoprolol|zebeta)/i, med: 'bisoprolol' },
        { pattern: /(?:furosemide|lasix)/i, med: 'furosemide' },
        { pattern: /(?:bumetanide|bumex)/i, med: 'bumetanide' },
        { pattern: /(?:torsemide|demadex)/i, med: 'torsemide' },
        { pattern: /(?:spironolactone|aldactone)/i, med: 'spironolactone' },
        { pattern: /(?:eplerenone|inspra)/i, med: 'eplerenone' },
        { pattern: /(?:finerenone|kerendia)/i, med: 'finerenone' },
        { pattern: /(?:hydrochlorothiazide|hctz|microzide)/i, med: 'hydrochlorothiazide' },
        { pattern: /(?:chlorthalidone|hygroton)/i, med: 'chlorthalidone' },
        { pattern: /(?:digoxin|lanoxin)/i, med: 'digoxin' },
        // Diabetes
        { pattern: /(?:empagliflozin|jardiance)/i, med: 'empagliflozin' },
        { pattern: /(?:dapagliflozin|farxiga)/i, med: 'dapagliflozin' },
        { pattern: /(?:canagliflozin|invokana)/i, med: 'canagliflozin' },
        { pattern: /(?:semaglutide|ozempic|wegovy|rybelsus)/i, med: 'semaglutide' },
        { pattern: /(?:liraglutide|victoza|saxenda)/i, med: 'liraglutide' },
        { pattern: /(?:glipizide|glucotrol)/i, med: 'glipizide' },
        { pattern: /(?:sitagliptin|januvia)/i, med: 'sitagliptin' },
        { pattern: /(?:entresto|sacubitril)/i, med: 'sacubitril_valsartan' },
        { pattern: /(?:aspirin|asa\b)/i, med: 'aspirin' },
        { pattern: /(?:clopidogrel|plavix)/i, med: 'clopidogrel' },
        { pattern: /(?:amlodipine|norvasc)/i, med: 'amlodipine' },
        // Osteoporosis
        { pattern: /(?:alendronate|fosamax)/i, med: 'alendronate' },
        { pattern: /(?:risedronate|actonel)/i, med: 'risedronate' },
        { pattern: /(?:zoledronic|reclast|zometa)/i, med: 'zoledronic_acid' },
        { pattern: /(?:denosumab|prolia)/i, med: 'denosumab' },
        { pattern: /(?:teriparatide|forteo)/i, med: 'teriparatide' },
        { pattern: /(?:romosozumab|evenity)/i, med: 'romosozumab' },
        // Respiratory
        { pattern: /(?:advair)/i, med: 'fluticasone_salmeterol' },
        { pattern: /(?:spiriva|tiotropium)/i, med: 'tiotropium' },
        { pattern: /(?:trelegy)/i, med: 'fluticasone_umeclidinium_vilanterol' },
        // Gout
        { pattern: /(?:allopurinol|zyloprim)/i, med: 'allopurinol' },
        { pattern: /(?:febuxostat|uloric)/i, med: 'febuxostat' },
        { pattern: /(?:colchicine|colcrys)/i, med: 'colchicine' },
        // Pain/Neuro
        { pattern: /(?:gabapentin|neurontin)/i, med: 'gabapentin' },
        { pattern: /(?:pregabalin|lyrica)/i, med: 'pregabalin' },
        { pattern: /(?:duloxetine|cymbalta)/i, med: 'duloxetine' },
        // Other
        { pattern: /(?:omeprazole|prilosec)/i, med: 'omeprazole' },
        { pattern: /(?:levothyroxine|synthroid|levoxyl)/i, med: 'levothyroxine' },
        { pattern: /(?:repatha|evolocumab)/i, med: 'evolocumab' },
        { pattern: /(?:vascepa|icosapent)/i, med: 'icosapent_ethyl' }
    ];

    medPatterns.forEach(({ pattern, med }) => {
        if (pattern.test(text) && !data.medications.includes(med)) {
            data.medications.push(med);
        }
    });

    // Check if we extracted anything useful
    if (Object.keys(data).length > 2 || (data.age && data.sex)) {
        return data;
    }
    return null;
}

/**
 * Fill form fields from extracted data
 */
function fillFormFromExtractedData(data) {
    // Helper to safely set a value
    const setValue = (id, value) => {
        const el = document.getElementById(id);
        if (el && value !== null && value !== undefined) {
            el.value = value;
        }
    };

    // Helper to safely check a checkbox
    const setChecked = (id, value) => {
        const el = document.getElementById(id);
        if (el) {
            el.checked = !!value;
        }
    };

    // Handle nested JSON format (from EMR prompt)
    if (data.demographics) {
        setValue('age', data.demographics.age);
        setValue('sex', data.demographics.sex);
        setValue('race', data.demographics.race);
        setValue('weight', data.demographics.weight_kg);
        setValue('height', data.demographics.height_cm);
    } else {
        // Handle flat format (from text extraction)
        setValue('age', data.age);
        setValue('sex', data.sex);
        setValue('race', data.race);
        setValue('weight', data.weight_kg || data.weight);
        setValue('height', data.height_cm || data.height);
    }

    // Vitals
    if (data.vitals) {
        setValue('systolic-bp', data.vitals.systolic_bp);
        setValue('diastolic-bp', data.vitals.diastolic_bp);
    } else {
        setValue('systolic-bp', data.systolic_bp);
        setValue('diastolic-bp', data.diastolic_bp);
    }

    // Labs
    const labs = data.labs || data;
    setValue('total-cholesterol', labs.total_cholesterol);
    setValue('ldl', labs.ldl);
    setValue('hdl', labs.hdl);
    setValue('triglycerides', labs.triglycerides);
    setValue('creatinine', labs.creatinine);
    setValue('egfr', labs.egfr);
    setValue('a1c', labs.a1c);
    setValue('fasting-glucose', labs.fasting_glucose);
    setValue('bnp', labs.bnp);
    setValue('uacr', labs.uacr);

    // Cardiac data
    const cardiac = data.cardiac || data;
    setValue('ef', cardiac.ejection_fraction || cardiac.ef);
    setValue('nyha', cardiac.nyha_class);
    setChecked('afib', cardiac.afib || (data.conditions && data.conditions.afib));
    setChecked('prior-stroke', cardiac.prior_stroke_tia || (data.conditions && data.conditions.prior_stroke));
    setChecked('prior-mi', cardiac.prior_mi || (data.conditions && data.conditions.prior_mi));
    setChecked('pvd', cardiac.pvd);
    setChecked('chf-history', cardiac.heart_failure || (data.conditions && data.conditions.heart_failure));

    // Diabetes
    if (data.diabetes) {
        const diabetesMap = {
            'none': 'none',
            'prediabetes': 'prediabetes',
            'type2': 'type2',
            'type 2': 'type2',
            'type1': 'type1',
            'type 1': 'type1'
        };
        setValue('diabetes-status', diabetesMap[data.diabetes.status] || data.diabetes.status);
        setValue('diabetes-duration', data.diabetes.duration_years);
    } else if (data.conditions && data.conditions.diabetes_type2) {
        setValue('diabetes-status', 'type2');
    }

    // Bleeding risks
    const bleed = data.bleeding_risks || {};
    setChecked('prior-bleed', bleed.prior_major_bleed);
    setChecked('anemia', bleed.anemia);
    setChecked('liver-disease', bleed.liver_disease);
    setChecked('alcohol', bleed.heavy_alcohol);
    setChecked('nsaid-use', bleed.nsaid_use);
    setChecked('antiplatelet', bleed.on_antiplatelet);
    setChecked('fall-risk', bleed.fall_risk);

    // Other conditions
    const other = data.other_conditions || data.conditions || {};
    setChecked('htn-treatment', other.hypertension_treated || other.hypertension);
    setChecked('smoker', other.current_smoker);
    setChecked('former-smoker', other.former_smoker);
    setChecked('family-hx-cad', other.family_hx_cad);
    setChecked('copd', other.copd);
    setChecked('osa', other.sleep_apnea);
    setChecked('depression', other.depression);
    setChecked('dementia', other.dementia);
    setChecked('cancer', other.active_cancer || other.cancer);
    setChecked('frailty', other.frailty);
    setChecked('osteoporosis', other.osteoporosis);
    setChecked('gout', other.gout);
    setChecked('asthma', other.asthma);
    setChecked('neuropathy', other.neuropathy);
    setChecked('hypothyroidism', other.hypothyroidism);
    setChecked('fibromyalgia', other.fibromyalgia);
    setChecked('pvd', other.pvd);

    // Medications
    const medications = data.current_medications || data.medications || [];
    if (medications.length > 0) {
        // First uncheck all
        document.querySelectorAll('[data-med]').forEach(el => el.checked = false);

        // Then check the ones that match
        medications.forEach(med => {
            const checkbox = document.querySelector(`[data-med="${med}"]`);
            if (checkbox) {
                checkbox.checked = true;
            }
        });
    }

    // Trigger diabetes fields visibility update
    const diabetesSelect = document.getElementById('diabetes-status');
    if (diabetesSelect) {
        diabetesSelect.dispatchEvent(new Event('change'));
    }
}
</script>
</body>
</html>
